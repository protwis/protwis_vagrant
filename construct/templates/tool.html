{% extends "home/base.html" %}
{% load static %}
{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
{% endblock %}
{% block content %}
  <style>
  .ui-menu { width: 200px; }
  .ui-widget-header { padding: 0.2em; }
  .info_text {padding: 0.2em;}
  .tooltip{}
  .large.tooltip-inner {
      max-width: 450px;
      width: 450px;
      text-align:left;
    }
  .medium.tooltip-inner {
      max-width: 300px;
      width: 300px;
    }

  select.form-control {
    height: 34px;
    font-size: 14px;
  }

  .fixed td:not(.mod_buttons){
    font-weight: bold;
  }


  .ignored td:not(.mod_buttons) {
    font-weight: lighter;
  }

  </style>

<div class="modal bd-example-modal-lg" id="myModal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>
      <div class="modal-body" id="ModalBody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<h2> Construct Design Tool  </h2>

<p> This is a tool to help aid structural biologist design constructs.<a href=#  onclick='modifications_overview();showModal("Introduction",tables["help"]);'> Press here for an introduction.</a> <button id=toolvideo mp4="https://files.gpcrdb.org/video/constructtool1.mp4" type="button" class="videoLink btn btn-xs btn-default">
                          <span class="glyphicon glyphicon-film"></span>
                        </button></p>

<p>
Target: {{target.entry_name}} |
Class: {{class}}
</p>

<div id="dialog" title="Reset">
  <p>You sure you want to reset this construct?</p>
</div>

{% if active_xtals  %}
  State: <div class="btn-group" data-toggle="buttons">
    <label class="btn btn-default active">
      <input type="radio" name="state" value="inactive" checked=""> Inactive
    </label>
    <label class="btn btn-default">
      <input type="radio" name="state" value="active"> Active
    </label>
  </div>
{% else %}
  <input type="radio" class="hidden" name="state" value="inactive" checked="">
{% endif %}

Fusion Site: <div class="btn-group" data-toggle="buttons">
  <label class="btn btn-default">
    <input type="radio" name="fusionpos" value="nterm"> N-term
  </label>

    {% if class == 'A' or class == 'F' %}
  <label class="btn btn-default active">
    <input type="radio" name="fusionpos" value="icl3" checked=""> ICL3
  </label>
  {% elif class == 'B' or class == 'C' %}
  <label class="btn btn-default active">
    <input type="radio" name="fusionpos" value="icl3" checked=""> ICL2
  </label>
  {% endif %}

  <label class="btn btn-default">
    <input type="radio" name="fusionpos" value="None"> None
  </label>
</div>
<button class="btn btn-warning" onclick='$( "#dialog" ).dialog( "open" )''>Reset</button>
<button class="btn btn-info" onclick='exportCSVsuggestions();'>Export all suggestions</button>

<form action="/common/importexcel" style="display: inline;" method="post" id="file-upload-form" enctype="multipart/form-data">
    <label class="btn btn-primary btn-file">
      Upload excelfile <input  id="id_file_source" name="file_source" type="file" style="display: none;">
    </label>
</form>

<br>
<br>
<span id='load'>
<span id=loadstatus>Please wait for the dataset to load</span>
<span id='method_options' style='display: none;'>
<div class="row">
  <div class="col-sm-2">
  Deletions:
  </div>
  <div class="col-sm-8">
    <button type="button" id="nterm_button" class="btn btn-primary" onclick='showModal("N-term",tables["nterm"],"#nterm_sug");'>
      N-term
    </button>

      {% if class == 'A'  or class == 'F' %}
        <button type="button" id="icl3_start_button" class="btn btn-primary" onclick='showModal("ICL3 (Start)",tables["icl3_start"],"#icl3_sug_start");'>
        ICL3
        </button>
      {% elif class == 'B' or class == 'C' %}
        <button type="button" id="icl2_start_button" class="btn btn-primary" onclick='showModal("ICL2 (Start)",tables["icl2_start"],"#icl2_sug_start");'>
        ICL2
        </button>
      {% endif %}

    <button type="button" id="cterm_button" class="btn btn-primary" onclick='showModal("C-term",tables["cterm"],"#cterm_sug");'>
      C-term
    </button>
  </div>
</div>
<div class="row">
  <div class="col-sm-2">
  Inserts:
  </div>
  <div class="col-sm-8">
    <button type="button" id="other_inserts_button" class="btn btn-primary" onclick='showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper();inserts_overview();'>
      Manage
    </button>
  </div>
</div>
<div class="row">
  <div class="col-sm-2">
  Mutations:
  </div>
  <div class="col-sm-8">
    <button type="button" id="mutations_button" class="btn btn-primary" onclick='build_mutations();showModal("Thermostabilisation",tables["mutations"],"#mut_sug");'>
      Thermostabilisation
    </button>
    <button type="button" id="removals_button" class="btn btn-primary" onclick='build_site_removals();showModal("Site removals",tables["site_removals"],"#site_sug");'>
      Site Removal
    </button>
  </div>
</div>
<div class="row">
  <div class="col-sm-2">
  Other:
  </div>
  <div class="col-sm-8">
    <button type="button" id="mutations_button" class="btn btn-primary" onclick='showModal("Custom",tables["custom"]);'>
      Custom modification
    </button>
    <button type="button" id="removals_button" class="btn btn-primary" onclick='
      overlay_modifications();modifications_overview();showModal("Overview",tables["overview"]);'>
      Current modifications
    </button>

    <button class="btn btn-info" onclick='exportToExcel();'>Export modifications</button>

  </div>
</div>
</span>
<div class="row">
  <div class="col-sm-12">
  {{ target.get_snake_plot_no_buttons }}
  </div>
</div>
<div class="row">
  <div class="col-sm-12">
    <div id="overview">
    </div>
  </div>
</div>
<iframe id="my_iframe" style="display:none;"></iframe>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
    <script src="{% static 'home/js/diagrams.js' %}"></script>
    <script type="text/javascript" charset="utf-8">

    function upload() {
      event.preventDefault();
      var data = new FormData($('#file-upload-form').get(0));
      console.log(data);
      $.ajax({
          url: $(this).attr('action'),
          type: $(this).attr('method'),
          data: data,
          cache: false,
          processData: false,
          contentType: false,
          success: function(data) {
              console.log(data);
              modifications = new Array;
              resetModifications();
              $.each(data, function(i,mod){
                console.log(mod);
                if ( $.inArray(mod[0], ['Modifications # used','Short-hand','Sequence']) > -1 ) return true;
                mod.splice(0, 1);
                range_match = String(mod[2]).match(/([\d]+)-([\d]+)/);
                console.log(range_match);
                range = new Array;
                if (range_match) {
                  // for (var i = range_match[1]; 1 > 0 ? i <= range_match[2] : i > range_match[2]; i += 1) {
                  //     range.push(i);
                  // }
                  start = parseInt(range_match[1]);
                  end = parseInt(range_match[2]);
                  for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
                      range.push(i);
                  }
                } else {
                  range.push(parseInt(mod[2]));
                }

                if (mod[0]=='Insert') {
                  insert_location = mod[4];
                  order_in_icl_insert = mod[5];
                  insert_type = mod[1].split(":")[0];
                  insert_sub_type = mod[1].split(":")[1];
                  if (mod[2]){
                    console.log('ICLCUT INFO, SET IT!');
                    icl_cut = mod[2];
                  }
                  inserts[insert_location].push({type: insert_type, name: insert_sub_type, order: order_in_icl_insert, sequence: mod[8]});
                }
                if (mod[9]!="yes"){
                  mod[9]="no";
                }
                modi = {method: mod[1], type: mod[0], to: mod[7], from:mod[6], range: range, info: mod[3], fixed: mod[9]};
                modifications.push(modi);
              });

              rebuild_insert_order();
              overlay_modifications();
              modifications_overview();
          }
      });
      return false;
    }

    $(function() {
        $('#file-upload-form').submit(upload);
    });

    function allPossibleCases(arr) {
      if (arr.length === 0) {
        return [];
      }
    else if (arr.length ===1){
    return arr[0];
    }
    else {
        var result = [];
        var allCasesOfRest = allPossibleCases(arr.slice(1));  // recur with the rest of array
        for (var c in allCasesOfRest) {
          for (var i = 0; i < arr[0].length; i++) {
            result.push(arr[0][i] + "," + allCasesOfRest[c]);
          }
        }
        return result;
      }

    }

    $('#id_file_source').on("change", function(){ $('#file-upload-form').submit(); });

    var residues_pos = {{residues_pos|safe}};

    var default_sort = {
        "paging":   false,
        "ordering": true,
        "info":     false,
        "bFilter": true,
        "bInfo": false,
        "order": [],
        // "fixedHeader": true,
        "scrollY": "600px",
        "autoWidth": false,
        "dom": 'lrtip'
    }

    var receptor_name = "{{target.entry_name}}".split("_")[0];

    var modifications = new Array;
    var tables = new Array;
    var mutations_browser = new Array;
    var removals_list = new Array;
    var export_list = {};
    var load_status = 0;
    var sequence = '';
    var sequence_short = '';
    var sequence_long = '';
    var icl_cut = 0; //track where an ICL cut/insert starts to use for where to start ICL inserts
    var inserts = new Array;
    var possible_combinations = 1;
    inserts['fusion'] = [];
    inserts['cterm'] = [];
    inserts['nterm'] = [];
    export_list['nterm'] = [];
    export_list['cterm'] = [];
    // export_list['icl3'] = [];
    export_list['icl3_start'] = [];
    export_list['icl3_end'] = [];
    export_list['icl2_start'] = [];
    export_list['icl2_end'] = [];
    export_list['thermo'] = [];
    export_list['removals'] = [];

    var info_text = {};

    info_text['nterm'] = '<p class=info_text>Here you select the N-term truncation. The data comes from receptor structures and is grouped by the truncation\'s distance to TM1. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest.</p>';

    info_text['icl2_start'] = '<p class=info_text>Select the start position for the truncation within ICL2. The data comes from receptor structures and is grouped by their GPCRdb generic number. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest. Once the starting position is selected a new window will open to select the ending position.</p>';
    info_text['icl2_end'] = '<p class=info_text>Select the ending position for the ICL2 truncation.</p>';

    info_text['icl3_start'] = '<p class=info_text>Select the start position for the truncation within ICL3. The data comes from receptor structures and is grouped by their GPCRdb generic number. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest. Once the starting position is selected a new window will open to select the ending position.</p>';
    info_text['icl3_end'] = '<p class=info_text>Select the ending position for the ICL3 truncation.</p>';

    info_text['cterm'] = '<p class=info_text>Here you select the C-term truncation. The data comes from receptor structures and is grouped by the truncation\'s distance to TM8. It is possible to sort the data by occurrances (frequence) or by homology (Levels).</p>';
    info_text['termo'] = '<p class=info_text>Select mutation by click the mutation suggestion in the <i>Mutation</i> column.</p>';

    info_text['sites'] = '<p class=info_text>The tool recognizes possible site motifs. These can be attempted to be removed using the following mutations.</p>';
    info_text['custom'] = '<p class=info_text>Use options below to insert custom mutations or truncations not suggested by tool. You will be asked to confirm modification.</p>';
    info_text['current'] = '<p class=info_text>See current modifications below. These will be included if you export to excel.<br> If there are several modfications chosen for the same form of deletion then you can either generate multiple construct sequences with combinations of the choices. Alternatively you can fix to a chosen modification by ticking the Fix box.<br> In the same fashion mutations can be fixed or used to make multiple sequences</p>';



    tables["custom"] = [info_text['custom']]
    tables["custom"].push( "Mutate: <input type='text' id='custom_pos' placeholder='sequence position'> to <input type='text' id='custom_mut' placeholder='aminoacid (1-letter)'> <input type='text'  id='custom_reason' placeholder='Reason'><input type=button value=Add onclick='custom_mut()'><div id=confirm_cus_mut></div><br>");
    tables["custom"].push( "Deletion: <input type='text' id='custom_del_start' placeholder='from (sequence position)'> - <input type='text' id='custom_del_end' placeholder='to (sequence number)'> <input type='text'  id='custom_del_reason' placeholder='Reason'><input type=button value=Add onclick='custom_del()'><div id=confirm_cus_del></del><br>");
    tables["custom"] = tables["custom"].join( "" );

    tables["help"] = ['See small movie with a sample usage of tool: <button onclick="$(\'#toolvideo\').click();" mp4="https://files.gpcrdb.org/video/constructtool1.mp4" type="button" class="videoLink btn btn-xs btn-default">' +
                        '<span class="glyphicon glyphicon-film"></span>' +
                        '</button>']

    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>State</strong></div><div class='col-sm-10'>Select either Inactive or Active to limit the dataset to the structures with chosen state.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Fusion site</strong></div><div class='col-sm-10'>Select if and where the fusion protein to be inserted. This is used to make suggestions for the intercelluar loop (ICL) truncation based on structures with fusion protein in same region.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Export</strong></div><div class='col-sm-10'>Export all suggestions to an excel sheet for local analysis.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Upload</strong></div><div class='col-sm-10'>Upload a previous construct design to continue work.</div></div>");
    tables["help"].push( "<br><div class='row'><div class='col-sm-2'><strong>Deletions</strong></div><div class='col-sm-10'>Methods to help guide truncations in different regions</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Mutations</strong></div><div class='col-sm-10'>Suggestions for thermostabilising mutations and for site removals</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Other</strong></div><div class='col-sm-10'>Create Custom modifications and see current modifications. Export current modificaitons to excel.</div></div>");
    tables["help"] = tables["help"].join( "" );


    // insert_sequences = new Array;


    insert_sequences = {"tag_His(10)": "HHHHHHHHHH",
                        "tag_His(8)": "HHHHHHHH",
                        "tag_FLAG": "DYKDDDDK",
                        "fusion_T4 Lysozyme (T4L)": "NIFEMLRIDEGLRLKIYKDTEGYYTIGIGHLLTKSPSLNAAKSELDKAIGRNTNGVITKDEAEKLFNQDVDAAVRGILRNAKLKPVYDSLDAVRRAALINMVFQMGETGVAGFTNSLRMLQQKRWDEAAVNLAKSRWYNQTPNRAKRVITTFRTGTWDAY",
                        "fusion_BRIL (b562RIL)": "ADLEDNWETLNDNLKVIEKADNAAQVKDALTKMRAAALDAQKATPPKLEDKSPDSPEMKDFRHGFDILVGQIDDALKLANEGKVKEAQAAAEQLKTTRNAYIQKYL",
                        "fusion_Rubredoxin": "MKKYTCTVCGYIYNPEDGDPDNGVNPGTDFKDIPDDWVCPLCGVGKDQFEEVEE",
                        "fusion_Flavodoxin": "AKALIVYGSTTGNTEYTAETIARELADAGYEVDSRDAASVEAGGLFEGFDLVLLGCSTWGDDSIELQDDFIPLFDSLEETGAQGRKVACFGCGDSSWEYFCGAVDAIEEKLKNLGAEIVQDGLRIDGDPRAARDDIVGWAHDVRGAI",
                        "signal_hemagglutinin" : "MKTIIALSYIFCLVFA",
                        "prot_cleavage_Thrombin": "LVPRGS",
                        "prot_cleavage_TEV protease": "ENLYFQG"};

    // insert_sequences["tag_His(10)"] = "HHHHHHHHHH";


    fusion_protein_dropdown = "<select id=fusion_choice class='form-control'><option>Select from list</option>";
    fusion_proteins = {{inserts.fusions|safe}};
    for(var key in {{inserts.fusions|safe}}) {
      fusion_protein_dropdown += "<option>"+fusion_proteins[key]+"</option>";
    }

    fusion_protein_dropdown += "<input class='form-control hidden' type=value id='fusion_where'><input type=button class='btn btn-info' value=Add onclick='add_fusion(this)'>"

    other_inserts_dropdown = fusion_protein_dropdown+"<br><select class='form-control'>";
    other_inserts = {{inserts.other|safe}};
    for(var key in other_inserts) {
      for (var key2 in other_inserts[key]) {
        other_inserts_dropdown += "<option>"+key+" - "+other_inserts[key][key2]+"</option>";
      }
    }

    other_inserts_dropdown = "Please see <a href='https://files.gpcrdb.org/Insert_sequences.xlsx'>here</a> for exact sequences used in inserts. They are based on sequences used in published structures.<br><table><tr class='fusion_site_inserts'><th colspan=2 id=fusion_text>Fusion Protein</th></tr><tr class='fusion_site_inserts'><td colspan=2>"+fusion_protein_dropdown + "</td></tr><tr><th colspan=2>Other inserts</th></tr>";
    // other_inserts_dropdown += `<select id="insert_type_where"  class="form-control">
    //               <option value="" >Please select Type</option>
    //               <option value="nterm">N-term</option>
    //               <option value="fusion">Fusion-Site</option>
    //               <option value="cterm">C-term</option>
    //             </select>`;
    // other_inserts_dropdown += "<table>";
    var segment_pretty = ['N-term','FusionSite','C-term']
     $.each(['nterm','fusion','cterm'], function(key,segment) {
    other_inserts_dropdown += "<tr class='"+segment+"_site_inserts'><th width=75>"+segment_pretty[key] + "</th><td>";
    other_inserts_dropdown += `<select id="`+segment+`_insert_type" name="protein_type" class='form-control'>
                  <option value="" >Please select Type</option>
                  <option value="`+segment+`_signal">Signal Peptide</option>
                  <option value="`+segment+`_tag">Tag</option>
                  <option value="`+segment+`_linker">Linker sequence</option>
                  <option value="`+segment+`_prot_cleavage">Proteolytic Cleavage site</option>
                </select>`;

    other_inserts_dropdown += `<select class="`+segment+`_insert_type form-control" id="`+segment+`_signal" name="signal">
                  <option value="">Please Select</option>
                  <option value="hemagglutinin">hemagglutinin</option>
                  <option value="other">Other</option>
                </select>`;


    other_inserts_dropdown += `<select class="`+segment+`_insert_type form-control" id="`+segment+`_tag" name="tag">
                  <option value="">Please Select</option>
                  <optgroup label="Affinity tags">
                  <option value="FLAG">FLAG</option>
                  <option value="His(10)">His(10)</option>
                  <option value="His(8)">His(8)</option>
                  <option value="His(6)">His(6)</option>
                  <option value="GST">GST</option>
                  <option value="MBP (Maltose Binding protein)">MBP (Maltose Binding protein)</option>
                  <option value="T7">T7</option>
                  <option value="TrxA">TrxA</option>
                  <option value="1D4">1D4</option>
                  <option value="Rho9">Rho9</option>
                  <option value="HA tag">HA tag</option>
                  <option value="Streptavidin tag">Streptavidin tag</option>
                  <option value="Myc tag">Myc tag</option>
                  <option value="other">Other</option>
                  <optgroup label="Coupling tags">
                  <option value="SNAP">SNAP</option>
                  <option value="Halo tag">Halo tag</option>
                  <option value="other">Other</option>
                  <optgroup label="Fluoresence/Labeling tags">
                  <option value="dsRED">dsRED</option>
                  <option value="GFP">GFP</option>
                  <option value="CFP">CPF</option>
                  <option value="YFP">YFP</option>
                  <option value="Luciferase">Luficerase</option>
                  <option value="SNAP tag">SNAP tag</option>
                  <option value="Flash tag">Flash tag</option>
                  <option value="other">Other</option>
                </select>`;
       other_inserts_dropdown += `<select class="`+segment+`_insert_type form-control" id="`+segment+`_prot_cleavage" name="prot_cleavage">
                  <option value="">Please Select</option>
                  <option value="Thrombin">Thrombin</option>
                  <option value="TEV protease">TEV protease</option>
                  <option value="HRV 3C protease (PreScission protease)">HRV 3C protease (PreScission protease)</option>
                  <option value="Carboxypeptidase A">Carboxypeptidase A</option>
                  <option value="V8 protease (endoproteinase GluC from Staph8)">V8 protease (endoproteinase GluC from Staph8)</option>
                  <option value="other">Other</option>
                </select>`;

      other_inserts_dropdown += `<input class="`+segment+`_insert_type insert_text form-control" maxlength="50" id="`+segment+`_linker" placeholder="Please input sequence" type="text" />`;
      other_inserts_dropdown += `<input class="`+segment+`_insert_type insert_text form-control" maxlength="50" id="`+segment+`_insert_other" placeholder="" type="text" />`;
      other_inserts_dropdown += `<input class="btn btn-info `+segment+`_insert_type" id="`+segment+`_insert_submit" placeholder="" value="Add" type="button" /></td></tr>`;
      });
      other_inserts_dropdown += "</table><div id=inserts_table></div>"
    tables["other_inserts"] = other_inserts_dropdown;

    function stopPropagation(evt) {
      if (evt.stopPropagation !== undefined) {
        evt.stopPropagation();
      } else {
        evt.cancelBubble = true;
      }
    }

    function updateLoadStatus() {

      $('#loadstatus').html("Please wait while data is loaded. "+Math.round(load_status*100/11)+"% done");
      if (load_status != 11) {
        $('#method_options').hide();
      } else {
        $('#method_options').show();
        $('#loadstatus').hide();
      }
    }

    function showModal(heading,content, datatable){
      $("#myModalLabel").html(heading);
      $("#ModalBody").html(content);
      $("#myModal").modal("show");
      build_tooltips();
      if (typeof(datatable)!=='undefined'){
        default_sort["order"] = [];
        var db_table = $(datatable).DataTable(default_sort);
      }

        var title = $('#fusion_search').text();
        $('#fusion_search').html( '<input type="text" onclick="stopPropagation(event);" placeholder="Search '+title+'" />' );

        // Apply the filter
        $("#fusion_search input").on( 'keyup change', function () {
            db_table.column( $('#fusion_search').index()+':visible' )
                    .search( this.value )
                    .draw();
        } );
    }

    function resetAll() {
      modifications = new Array;
      resetModifications();
      modifications_overview();
    }

    function build_tooltips() {
      $('[data-toggle="tooltip"]').tooltip();
      $('.prio_info').tooltip('destroy');
      $('.prio_info').tooltip({
          container: 'body',
          template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner large"></div></div>'
      });
      $('.methods_info').tooltip('destroy');
      $('.methods_info').tooltip({
          template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner medium"></div></div>'
      });
    }

    function resetModifications() {

      $('#snakeplot').find("circle").each(function( index ){
            //console.log( index + ": " + $( this ).text() );
            aa =  $(this).next().text();
            //console.log( index + ": " + aa );
            $(this).css("fill", 'white');
            $(this).next().css("fill", 'black');
          });

    }

    function inserts_helper() {

      fusionpos = $('input:radio[name=fusionpos]:checked').val();

      if (fusionpos == 'nterm') {
            fusionpos_pretty = "N-term";
      } else {
          fusionpos_pretty = fusionpos.toUpperCase();
      }
      $("#fusion_text").html("Select the Fusion Protein to add in "+fusionpos_pretty);

      if (fusionpos == 'None') {
        console.log("REMOVE FUSION OPTIONS");
        $(".fusion_site_inserts").hide();
      }

      $("#insert_type").hide();
      $( "#insert_type_where" )
        .change(function () {
          insert_location = $( "#insert_type_where option:selected" ).val();
          if (insert_location) {
            $("#insert_type").val($("#insert_type option:first").val());
            $(".insert_type").hide();
            $("#insert_type").show();

          } else {
            $("#insert_type").hide();
            $(".insert_type").hide();
          }
        });

      $(".insert_type").hide();
      $(".nterm_insert_type").hide();
      $(".fusion_insert_type").hide();
      $(".cterm_insert_type").hide();
      $( "#nterm_insert_type" ).add('#fusion_insert_type').add('#cterm_insert_type')
        .change(function () {
          this_class = "."+$(this).attr("id");
          this_id = "#"+$(this).attr("id");
          this_segment = $(this).attr("id").split("_")[0]

          console.log(this_segment);
          $("."+this_segment+"_insert_type").hide();

          insert_type = $( this_id+" option:selected" ).val();

          insert_type_specific = insert_type.split("_")[1];

          $("#"+insert_type).show();
          $("#"+insert_type).val($("#"+insert_type+" option:first").val());
          $("#"+this_segment+"_insert_other").val("");
          //Bind to check for other
          if (insert_type_specific=='linker') {
            // return if linker, as there is not supposed to be change event
            return
          }
          console.log("#"+insert_type);
          $("#"+insert_type).change(function () {
            console.log("changed #"+insert_type);
            console.log("changed #"+$(this).attr("id"));
            changed_id = $(this).attr("id");
            this_segment = $(this).attr("id").split("_")[0]
            $("#"+this_segment+"_insert_other").hide();
            sub_insert_type = $( "#"+changed_id+" option:selected" ).val();
            console.log("changed to "+sub_insert_type)
            if (sub_insert_type=='other'){
                $("#"+this_segment+"_insert_submit").hide();
                $("#"+this_segment+"_insert_other").show();
                console.log("show " +"#"+this_segment+"insert_other");
            } else if (sub_insert_type) {
                $("#"+this_segment+"_insert_submit").show();
                console.log("show submit for " +"#"+this_segment+"_insert_submit");
            } else {
                $("#"+this_segment+"_insert_submit").hide();
            }
          })
        })
        $( ".insert_text" ).keyup(function() {
          entered_text = $(this).val()
          this_segment = $(this).attr("id").split("_")[0]
          if (entered_text){ //if not empty in other or other text f ield
                $("#"+this_segment+"_insert_submit").show();
          } else {
                $("#"+this_segment+"_insert_submit").hide();
          }
        });
        $("#nterm_insert_submit").add('#fusion_insert_submit').add('#cterm_insert_submit')
          .click(function() {
            console.log("PRESSED");
            this_segment = $(this).attr("id").split("_")[0]
            insert_location = this_segment;
            insert_type = $( "#"+this_segment+"_insert_type option:selected" ).val();
            insert_type_specific = insert_type.split("_")[1]
            if (insert_type_specific!="linker") {
              insert_sub_type = $( "#"+insert_type+" option:selected" ).val();
              if (insert_sub_type=='other') {
                insert_sub_type = $("#"+this_segment+"_insert_other").val()
              }
            } else {
              insert_sub_type = $("#"+this_segment+"_linker").val()
            }
            insert_type = insert_type.replace(this_segment+"_","");
            add_other_fusion(insert_location,insert_type,insert_sub_type);

        })
    }

  function getSortedKeys(obj) {
      var keys = []; for(var key in obj) keys.push(key);
      return keys.sort(function(a,b){return obj[b]['hits']-obj[a]['hits']});
  }

  function getSortedKeysPrio(obj) {
      var keys = []; for(var key in obj) keys.push(key);
      return keys.sort(function(a,b){
          // return obj[b]['priority']-obj[a]['priority']

          if (obj[a]['priority'] > obj[b]['priority']) return 1;
          if (obj[a]['priority'] < obj[b]['priority']) return -1;

          if (obj[a]['hits'] < obj[b]['hits']) return 1;
          if (obj[a]['hits'] > obj[b]['hits']) return -1;
        }
        );
  }
  function exportCSVsuggestions(){

    postData = JSON.stringify(export_list);
    $.ajax({
      type:    "POST",
      url:     "/common/exportexcelsuggestions",
      data:    {"d":postData},
      success: function(data) {
            $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
      },
      // vvv---- This is the new bit
      error:   function(jqXHR, textStatus, errorThrown) {
            alert("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown
            );
            console.log("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown);
      }
    });
  }

  function exportToExcel(){

    postData = JSON.stringify(modifications);
    $.ajax({
      type:    "POST",
      url:     "/common/exportexcelmodifications",
      data:    {"d":postData, "s":JSON.stringify(export_list['sequences'])},
      success: function(data) {
            $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
      },
      // vvv---- This is the new bit
      error:   function(jqXHR, textStatus, errorThrown) {
            alert("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown
            );
            console.log("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown);
      }
    });
  }

  function getSortedKeys_advanced(obj) {

    var keys = []; for(var key in obj) keys.push(key);
    return keys.sort(function(a,b){
      if (obj[a]['levels_num'][0] < obj[b]['levels_num'][0]) return 1;
      if (obj[a]['levels_num'][0] > obj[b]['levels_num'][0]) return -1;

      if (obj[a]['levels_num'][1] < obj[b]['levels_num'][1]) return 1;
      if (obj[a]['levels_num'][1] > obj[b]['levels_num'][1]) return -1;

      if (obj[a]['levels_num'][2] < obj[b]['levels_num'][2]) return 1;
      if (obj[a]['levels_num'][2] > obj[b]['levels_num'][2]) return -1;

      if (obj[a]['levels_num'][3] < obj[b]['levels_num'][3]) return 1;
      if (obj[a]['levels_num'][3] > obj[b]['levels_num'][3]) return -1;
      return 0;
    });
  }

    function build_nterm_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_nterm = {};
      show_table = {};
      level_num = 0
      $.each(n_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3]) {
              if (fusionpos==vals[4] || (fusionpos=='None' && vals[4]!='nterm') || (fusionpos!='nterm' && vals[4]=='None') || 1==1) { //include all data regardless of fusion
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;

                  if (vals[5] in show_table[vals[2]]['fusion_proteins_counts'] && vals[4]=='nterm' && vals[5]!=''){
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] += 1;
                  } else if (vals[3]=='nterm' && vals[5]!='') {
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] = 1;
                  }

                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }

                if(show_table[vals[2]]['fusion_proteins'].indexOf(vals[5])==-1 && vals[4]=='nterm' && vals[5]!='') {
                  show_table[vals[2]]['fusion_proteins'].push(vals[5]);
                }

                if ( !(vals[5] in show_table[vals[2]]['fusion_proteins_counts']) && vals[4]=='nterm' && vals[5]!=''){
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] = 1;
                }

              }
            }
          })
        })
        level_num += 1;
      })

      var items_table = [info_text['nterm']];
      items_table.push( "Custom: <input type='text' id='custom_nterm' placeholder='From Helix 1'><input type=button value=Add onclick='custom_nterm()'>");
      items_table.push( "<table id=nterm_sug class='table-striped table table-bordered'><thead><tr><th>From Helix 1</th><th>Freq</th><th>Levels</th><th id=fusion_search>Fusion proteins</th><th>Use</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })

        temp = "<tr val='"+pos+"'><td>"+pos+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='nterm_tm1(this)' from='"+val['pdbs']+"' value='"+pos+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['nterm'].push([pos,val['hits'],val['levels'],val['fusion_proteins']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['nterm'] = result;
      $("#nterm_button").html("N-term ("+Object.keys(show_table).length+")");
      // $("#ModalBody").html(result);
    }

    function build_cterm_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_cterm = {};
      show_table = {};
      level_num = 0
      $.each(c_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3]) {
                find = 1;
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                if(!show_cterm[level]) { show_cterm[level] = {}; }
                if(!show_cterm[level][vals[2]]) { show_cterm[level][vals[2]] = {'proteins': [],'pdbs': [], 'hits':0}; }
                if(show_cterm[level][vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_cterm[level][vals[2]]['proteins'].push(protein);
                  show_cterm[level][vals[2]]['pdbs'].push(pdb);
                  show_cterm[level][vals[2]]['hits'] += 1;
                }

                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;
                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }
            }
          })
        })
        if (find==1 ){
          show_cterm[level]['sortedkeys'] = getSortedKeys(show_cterm[level]);
        }
        level_num += 1;
      })

      var items_table = [info_text['cterm']];
      items_table.push( "Custom: <input type='text' id='custom_cterm' placeholder='From Helix 8'><input type=button value=Add onclick='custom_cterm()'>");
      items_table.push("<table id=cterm_sug class='table-striped table table-bordered'><thead><tr><th>From Helix8 End</th><th>Freq</th><th>Levels</th><th>Use</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        temp = "<tr><td>"+(pos)+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td><a href='#' onclick='cterm(this)' from='"+val['pdbs']+"' value='"+pos+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['cterm'].push([pos,val['hits'],val['levels']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['cterm'] = result;
      $("#cterm_button").html("C-term ("+Object.keys(show_table).length+")");

    }

    function build_icl3_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_icl3 = {};
      show_table = {};
      show_table_start = {};
      show_table_end = {};
      level_num = 0
      $.each(icl3_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[2]) {
              if (fusionpos==vals[3] || (fusionpos=='None' && vals[3]!='icl3') || (fusionpos!='icl3' && vals[3]=='None')) {
                find = 1;
                range = "5."+(50+vals[0])+"-"+"6."+(50-vals[1]);
                range_start = "5."+(50+vals[0]);
                range_end = "6."+(50-vals[1]);

                // TABLE
                if(!show_table_start[range_start]) { show_table_start[range_start] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_start[range_start]['proteins'].indexOf(protein)==-1) {
                  show_table_start[range_start]['proteins'].push(protein);
                  show_table_start[range_start]['pdbs'].push(pdb);
                  show_table_start[range_start]['hits'] += 1;
                  show_table_start[range_start]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_start[range_start]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                  }

                }

                if(show_table_start[range_start]['levels'].indexOf(level)==-1) {
                  show_table_start[range_start]['levels'].push(level);
                }

                if(show_table_start[range_start]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_start[range_start]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_start[range_start]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                }

                // TABLE
                if(!show_table_end[range_end]) { show_table_end[range_end] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_end[range_end]['proteins'].indexOf(protein)==-1) {
                  show_table_end[range_end]['proteins'].push(protein);
                  show_table_end[range_end]['pdbs'].push(pdb);
                  show_table_end[range_end]['hits'] += 1;
                  show_table_end[range_end]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_end[range_end]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                  }

                }

                if(show_table_end[range_end]['levels'].indexOf(level)==-1) {
                  show_table_end[range_end]['levels'].push(level);
                }

                if(show_table_end[range_end]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_end[range_end]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_end[range_end]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                }


              }
            }
          })
        })
        level_num += 1;
      })

       var items_table = [info_text['icl3_start']];
      items_table.push( "Custom: 5.<input type='text' id='custom_icl' placeholder='Generic number'><input type=button value=Add onclick='custom_icl(3)'>");
      items_table.push("<table id=icl3_sug_start class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th id=fusion_search>Fusion</th><th>Use</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_start), function( i, pos ) {
        val = show_table_start[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl3_start(this)' from='"+val['pdbs']+"' tm5='"+val['start']+"'  tm6='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl3_start'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl3_start'] = result;
      {% if class == 'A' and residues.ICL3|length < 9 %}
      if (fusionpos!='icl3'){
        tables['icl3_start'] = "Loop is too short to require a truncation without a fusion protein";
      }
      {% endif %}
      var items_table = [info_text['icl3_end']];
      items_table.push( "Custom: 6.<input type='text' id='custom_icl_end' placeholder='Generic number'><input type=button value=Add onclick='custom_icl_end(3)'>");
      items_table.push( "<div id=icl3_start_info></div><table id=icl3_sug_end class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th id=fusion_search>Fusion</th><th>Use</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_end), function( i, pos ) {
        val = show_table_end[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl3(this)' from='"+val['pdbs']+"' tm5='"+val['start']+"'  tm6='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl3_end'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl3_end'] = result;


      $("#icl3_start_button").html("ICL3 ("+Object.keys(show_table_start).length+")");
    }

    function build_icl2_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_icl2 = {};
      show_table_start = {};
      show_table_end = {};
      level_num = 0
      $.each(icl2_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[2]) {
              if (fusionpos==vals[3] || (fusionpos=='None' && vals[3]!='icl3') || (fusionpos!='icl3' && vals[3]=='None')) { //use icl3 cos thats how it is
                find = 1;
                range = "3."+(50+vals[0])+"-"+"4."+(50-vals[1]);

                range_start = "3."+(50+vals[0]);
                range_end = "4."+(50-vals[1]);

                // TABLE
                if(!show_table_start[range_start]) { show_table_start[range_start] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_start[range_start]['proteins'].indexOf(protein)==-1) {
                  show_table_start[range_start]['proteins'].push(protein);
                  show_table_start[range_start]['pdbs'].push(pdb);
                  show_table_start[range_start]['hits'] += 1;
                  show_table_start[range_start]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_start[range_start]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                  }
                }

                if(show_table_start[range_start]['levels'].indexOf(level)==-1) {
                  show_table_start[range_start]['levels'].push(level);
                }

                if(show_table_start[range_start]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_start[range_start]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_start[range_start]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                }

                // TABLE
                if(!show_table_end[range_end]) { show_table_end[range_end] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_end[range_end]['proteins'].indexOf(protein)==-1) {
                  show_table_end[range_end]['proteins'].push(protein);
                  show_table_end[range_end]['pdbs'].push(pdb);
                  show_table_end[range_end]['hits'] += 1;
                  show_table_end[range_end]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_end[range_end]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                  }
                }

                if(show_table_end[range_end]['levels'].indexOf(level)==-1) {
                  show_table_end[range_end]['levels'].push(level);
                }
                if(show_table_end[range_end]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_end[range_end]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_end[range_end]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                }

              }
            }
          })
        })
        level_num += 1;
      })


       var items_table = [info_text['icl2_start']];
      items_table.push( "Custom: 3.<input type='text' id='custom_icl' placeholder='Generic number'><input type=button value=Add onclick='custom_icl(2)'>");
      items_table.push("<table id=icl2_sug_start class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th>Fusion proteins</th><th>Use</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_start), function( i, pos ) {
        val = show_table_start[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl2_start(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl2_start'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl2_start'] = result;

       var items_table = [info_text['icl2_end']];
      items_table.push( "Custom: 4.<input type='text' id='custom_icl_end' placeholder='Generic number'><input type=button value=Add onclick='custom_icl_end(2)'>");
      items_table.push("<div id=icl2_start_info></div><table  id=icl2_sug_end class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th>Fusion proteins</th><th>Use</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_end), function( i, pos ) {
        val = show_table_end[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl2(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl2_end'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl2_end'] = result;
      $("#icl2_start_button").html("ICL2 ("+Object.keys(show_table_start).length+")");
    }

    function build_mutations() {
      // console.log(mutations_browser);
      // console.log(mutations_browser.length);

      var state = $('input:radio[name=state]:checked').val();
      var keys = Object.keys(mutations_browser);
      export_list['thermo'] = [];
      muts = {}
      $.each(keys, function( i,type ) {
        if (type.substring(0, 11) == "struc_rules" && type.substring(12)!=state) {
          return true; //loop away from these
        }
        $.each(mutations_browser[type], function(gn, values){
          if(!muts[gn]) { muts[gn] = {'priority': 99, 'gn': gn, 'types': [], 'pretty_types': [], 'hits':0, 'details':[]}; }

          muts[gn]['hits'] += 1;

          muts[gn]['details'].push(values);
          if (type.substring(0, 11) == "struc_rules") {
            if (muts[gn]['priority']>5) muts[gn]['priority'] = 5;
            pretty_type = 'State-stabilising'
          } else if (type == "termo_From target recepter") {
            if (muts[gn]['priority']>1) muts[gn]['priority'] = 1;
            pretty_type = 'From Receptor'
          } else if (type == "termo_Common mutation (Wt)") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Observed (multiple)'
          } else if (type == "termo_Common mutation (Mut)") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Observed (multiple)'
          } else if (type == "termo_Single common mutation (Wt)") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 3;
            pretty_type = 'Observed (single)'
          } else if (type == "cons_rm_conserved_G") {
            if (muts[gn]['priority']>4) muts[gn]['priority'] = 4;
            pretty_type = 'Conservation (remove Gly)'
          } else if (type == "cons_rm_nonconserved_GP") {
            if (muts[gn]['priority']>4) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation (remove Gly/Pro)'
          } else if (type == "cons_rf_and_class") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation'
          } else if (type == "cons_rf") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation'
          } else if (type == "cons_strucs") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation'
          } else {
            console.log(type);
          }

          muts[gn]['types'].push(type);
          muts[gn]['pretty_types'].push(pretty_type);
        });
      });
      // console.log(muts);

          prio_info = '<p class=info_text>Thermostabilising mutations have 5 priority levels based on method: <ol><li>From structure of this target ({{target.entry_name}})</li><li>Introducing conserved residue or observed in >2 structures</li><li>Observed in 1 structure</li><li>Increase helix propensity (Remove Gly)</li><li>State-stabilising interactions (e.g. ionic lock or sodium ion site)</li></ol></p>';

        var items_table = [info_text['termo']];
        items_table.push("<table id='mut_sug' class='table-striped table table-bordered'><thead><tr><th>Prio <a class='prio_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+prio_info+"'><i class='glyphicon glyphicon-info-sign'></i></a></th><th>Pos</th><th>Mut</th><th>Methods <a class='prio_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+prio_info+"'><i class='glyphicon glyphicon-info-sign'></i></a></th></tr></thead><tbody>");
      $.each( getSortedKeysPrio(muts), function( i, gn ) {
        vals = muts[gn];
        mut_suggestions = [];
        check = []
        label = []
        $.each(vals['details'], function(i, val) {
            // console.log(val);
            if (vals['types'][i].substring(0, 5) == "cons_") {
              label.push(val[0]+val[1]+val[2]);
              if ($.inArray(val[0]+val[1]+val[2], check)==-1) {
                mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' >"+val[0]+val[1]+val[2]+"</a>");
                check.push(val[0]+val[1]+val[2]);
              }
            } else if (vals['types'][i].substring(0, 5) == "termo") {
              $.each( val, function( key, value ) {
                if (vals['types'][i]=='termo_Common mutation (Wt)') {
                  // console.log(key);
                  // console.log(value);
                  $.each(value['muts'], function(ii, mut_aa) {
                    // console.log(mut_aa);
                    label.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    if ($.inArray(value['wt'][0]+value['wt'][1]+mut_aa, check)==-1) {
                      mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+mut_aa+"'>"+value['wt'][0]+value['wt'][1]+mut_aa+"</a>");
                      check.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    }
                   });
                } else if (vals['types'][i]=='termo_Single common mutation (Wt)') {
                  // console.log(key);
                  // console.log(value);
                  $.each(value['muts'], function(ii, mut_aa) {
                    // console.log(mut_aa);
                    label.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    if ($.inArray(value['wt'][0]+value['wt'][1]+mut_aa, check)==-1) {
                      mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+mut_aa+"'>"+value['wt'][0]+value['wt'][1]+mut_aa+"</a>");
                      check.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    }
                   });
                } else {
                    // temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+to+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+to+"</strong></a></li>";

                  label.push(value['wt'][0]+value['wt'][1]+key);
                  if ($.inArray(value['wt'][0]+value['wt'][1]+key, check)==-1) {
                    mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+key+"'>"+value['wt'][0]+value['wt'][1]+key+"</a>");
                    check.push(value['wt'][0]+value['wt'][1]+key);
                  }
                }
              });

            } else if (vals['types'][i].substring(0, 11) == "struc_rules") {
              vals['types'][i] += ":"+val[0]['definition'];
              $.each( val, function( key, value ) {
                label.push(value['wt']+value['pos']+value['mut']);
                if ($.inArray(value['wt']+value['pos']+value['mut'], check)==-1) {
                  mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['pos']+"' gn='"+gn+"' wt='"+value['wt']+"' from='"+value['wt']+"' to='"+value['mut']+"' >"+value['wt']+value['pos']+value['mut']+"</a>");
                  check.push(value['wt']+value['pos']+value['mut']);
                }
              });
            }
        });
        //<td>"+vals['hits']+"</td>
        temp = "<tr><td align=center>"+vals['priority']+"</td><td>"+gn+"</td><td origin='"+vals['types']+"'>"+mut_suggestions.join(", ")+"</td><td>"+vals['pretty_types']+" <a class='methods_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+vals['types'].join("<br>")+"'><i class='glyphicon glyphicon-info-sign'></i></a></td></tr>";
        items_table.push( temp );
        export_list['thermo'].push([gn,label.join(", "),vals['hits'],vals['types']]);
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['mutations'] = result;
      $("#mutations_button").html("Thermostabilisation ("+Object.keys(muts).length+")");
    }

    function build_site_removals() {
      var keys = Object.keys(removals_list);
      removals = {}
      count = 0;
      var items_table = [info_text['sites'] + "<table  id='site_sug' class='table-striped table table-bordered'><thead><tr><th>Segment</th><th>Mutation</th><th>Type of removal</th></tr></thead><tbody>"];
      $.each(keys, function( i,type ) {
        $.each(removals_list[type], function(subtype, values){
          // console.log(type);
          // console.log(subtype);
          $.each(values, function(i, details) {
            // console.log(i);
            // console.log(details);
            count += 1;
            if (details[2]!="") { //single mutation
              suggestion = "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' to2='"+details[3]+"' wt2='"+details[4][1]+"'> Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3]+"</a>";
              label = "Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3];
            } else {
                suggestion =  "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' > Mutate "+details[4][0]+details[0]+details[1]+"</a>";
                label = "Mutate "+details[4][0]+details[0]+details[1];
            }
            temp = "<tr><td>"+details[5]+"</td><td>"+suggestion+"</td><td>"+type+" ("+subtype+")</td></tr>";
            items_table.push( temp );
            export_list['removals'].push([details[5],label,type,subtype]);
          });
        });
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['site_removals'] = result;
      $("#removals_button").html("Site removals ("+count+")");
    }

    // ON CLICK FUNCTIONS

    function reset_fixed(modi_type) {

      $.each(modifications, function(key,val) {
          if (val['type']+"_"+val['method']==modi_type) {
            modifications[key]['fixed'] = 'no';
          }
      });

    }


    function nterm_tm1(elem) {
      n_val = $(elem).attr("value");
      from = $(elem).attr("from").split(',');
      // until = {{residues_gn.1x50.sequence_number}}-n_val;

      until = {{residues.TM1.0.sequence_number}}-n_val;

      range = new Array;
      for (var i = 1; 1 > 0 ? i <= until : i > until; i += 1) {
          range.push(i);
      }
      reset_fixed("deletion_n-term");
      // $('#myModal').modal('hide');
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
      // $(elem).css('font-weight', 'bold');
      modi = {method: "n-term", type: "deletion", from: from, range: range, info: n_val+" from TM1 start. Based on "+from.join(", "), fixed: 'yes'};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }


    function custom_nterm(elem) {
      n_val = $("#custom_nterm").val();
      from = ["custom"];
      // until = {{residues_gn.1x50.sequence_number}}-n_val;

      until = {{residues.TM1.0.sequence_number}}-n_val;

      range = new Array;
      for (var i = 1; 1 > 0 ? i <= until : i > until; i += 1) {
          range.push(i);
      }

      reset_fixed("deletion_n-term");
      // $('#myModal').modal('hide');
      modi = {method: "n-term", type: "deletion", from: from, range: range, info: "Custom: "+n_val+" from TM1 start", fixed: 'yes'};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    function cterm(elem) {
      n_val = $(elem).attr("value");
      from = $(elem).attr("from").split(',');
      // start = {{residues_gn.8x50.sequence_number}}-n_val;
      start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val);
      {% with residues.Cterm|last as last %}
       end =   {{ last.sequence_number }};
      {% endwith %}

      range = new Array;
      for (var i = start; 1 > 0 ? i <= end : i > end; i += 1) {
          range.push(i);
      }

      reset_fixed("deletion_c-term");
      // $('#myModal').modal('hide');
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
      modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Based on "+from.join(", "), fixed: 'yes'};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    function custom_cterm(elem) {
      n_val = $("#custom_cterm").val();
      from = ["custom"];
      // until = {{residues_gn.1x50.sequence_number}}-n_val;

      start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val);
      {% with residues.Cterm|last as last %}
       end =   {{ last.sequence_number }};
      {% endwith %}

      range = new Array;
      for (var i = start; 1 > 0 ? i <= end : i > end; i += 1) {
          range.push(i);
      }

      reset_fixed("deletion_c-term");
      $('#myModal').modal('hide');
      modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Custom: "+n_val+" from TM8 end", fixed: 'yes'};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    var icl3_del_start = 0;
    var icl_start_from = "";

    function custom_icl(icl_number) {

      icl_del_start = $("#custom_icl").val();
      if (icl_number=='3'){
        icl3_del_start =parseInt(icl_del_start)-50;
      } else if (icl_number=='2'){
        icl2_del_start =parseInt(icl_del_start)-50;
      }
      icl_start_from = "Custom";

      showModal("ICL"+icl_number+" (End)",tables["icl"+icl_number+"_end"],"#icl"+icl_number+"_sug_end");
      $("#icl"+icl_number+"_start_info").html("Start selected: ."+(parseInt(icl_del_start)) );

    }

    function custom_icl_end(icl_number) {

      icl_del_end = $("#custom_icl_end").val();
      // make it be positions from 50
      icl_del_end =50-parseInt(icl_del_end);
      console.log("distance "+icl_del_end);

      from = "Custom";
      if (icl_number=="3") {
        end = {{residues_gn.6x50.sequence_number}}-icl_del_end;
        start = {{residues_gn.5x50.sequence_number}}-(-icl3_del_start);
        icl_cut = start;
      } else if (icl_number=="2") {
        end = {{residues_gn.4x50.sequence_number}}-icl_del_end;
        start = {{residues_gn.3x50.sequence_number}}-(-icl2_del_start);
        icl_cut = start;

      }
      // console.log(start+" "+end);

      range = new Array;
      for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
          range.push(i);
      }

      reset_fixed("deletion_ICL"+icl_number);
      modi = {method: "ICL"+icl_number, type: "deletion", from: from, range: range, info: from, fixed: 'yes'};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
      $('#myModal').modal('hide');

    }

    function icl3_start(elem) {
      icl3_del_start = $(elem).attr("tm5");
      icl_start_from = $(elem).attr("from");

      showModal("ICL3 (End)",tables["icl3_end"],"#icl3_sug_end");
      $("#icl3_start_info").html("Start selected: 5."+(50+parseInt(icl3_del_start)) );

    }

    function icl3(elem) {
      from = icl_start_from+","+$(elem).attr("from");
      from = Array.from(new Set(from.split(',')));
      end = {{residues_gn.6x50.sequence_number}}-$(elem).attr("tm6");
      start = {{residues_gn.5x50.sequence_number}}-(-icl3_del_start);
      icl_cut = start;
      // console.log(start+" "+end);

      range = new Array;
      for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
          range.push(i);
      }

      reset_fixed("deletion_ICL3");
      modi = {method: "ICL3", type: "deletion", from: from, range: range, info: "Based on "+from.join(", "), fixed: 'yes'};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
      $('#myModal').modal('hide');
    }


    var icl2_del_start = 0;
    function icl2_start(elem) {
      icl2_del_start = $(elem).attr("tm3");
      icl_start_from = $(elem).attr("from");

      showModal("ICL2 (End)",tables["icl2_end"],"#icl2_sug_end");
      $("#icl2_start_info").html("Start selected: 3."+(50+parseInt(icl2_del_start)) );

    }

    function icl2(elem) {
      from = icl_start_from+$(elem).attr("from");
      from = Array.from(new Set(from.split(',')));

      end = {{residues_gn.4x50.sequence_number}}-$(elem).attr("tm4");
      start = {{residues_gn.3x50.sequence_number}}-(-icl2_del_start);
      icl_cut = start;
      // console.log(start+" "+end);

      range = new Array;
      for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
          range.push(i);
      }
      reset_fixed("deletion_ICL2");
      modi = {method: "ICL2", type: "deletion", from: from, range: range, info: "Based on "+from.join(", "), fixed: 'yes'};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
      $('#myModal').modal('hide');
    }

    function custom_del(confirm) {
      start = $('#custom_del_start').val();
      end = $('#custom_del_end').val();
      reason = $('#custom_del_reason').val();

      start_gn = residues_pos[start][2];
      start_wt = residues_pos[start][0];
      start_seg = residues_pos[start][1];

      end_gn = residues_pos[end][2];
      end_wt = residues_pos[end][0];
      end_seg = residues_pos[end][1];

      label = start_wt+start+'-'+end_wt+end+' ('+start_seg+'/'+end_seg+')';
      if (typeof(confirm)==='undefined'){
        $('#confirm_cus_del').html('Custom deletion! '+label+' '+'Reason:'+reason+' <input type=button value=Confirm onclick=custom_del("1")>');
      } else {
        range = new Array;
        for (var i = parseInt(start); 1 > 0 ? i <= parseInt(end) : i > parseInt(end); i += 1) {
            range.push(i);
        }
        modi = {method: label, type: "deletion", to: to, range: range, info: "Custom deletion. Reason:"+reason, fixed: 'yes'};
        modifications.push(modi);
        overlay_modifications();
        modifications_overview();
        $('#confirm_cus_del').html('Added '+label);
        pos = $('#custom_del_end').val('');
        to = $('#custom_del_start').val('');
        reason = $('#custom_del_reason').val('');
      }
    }

    function custom_mut(confirm) {
      pos = $('#custom_pos').val();
      to = $('#custom_mut').val();
      reason = $('#custom_reason').val();
      gn = residues_pos[pos][2];
      wt = residues_pos[pos][0];
      seg = residues_pos[pos][1];


      label = wt+pos+to;
      if (typeof(confirm)==='undefined'){
        $('#confirm_cus_mut').html('Custom! '+label+' ('+seg+'/'+gn+') '+'Reason:'+reason+' <input type=button value=Confirm onclick=custom_mut("1")>');
      } else {
        range = new Array;
        range.push(pos);
        modi = {method: label+" "+gn, type: "mutation", to: to, range: range, info: "Custom mutation. Reason:"+reason, fixed: 'yes'};
        modifications.push(modi);
        overlay_modifications();
        modifications_overview();
        $('#confirm_cus_mut').html('Added '+label);
        pos = $('#custom_pos').val('');
        to = $('#custom_mut').val('');
        reason = $('#custom_reason').val('');
      }
    }

    function add_fusion(elem){

      fusion = $( "#fusion_choice option:selected" ).val();

      console.log($(elem).parent());
      console.log(fusion);

      range = new Array;
      range.push("");

      order_in_icl_insert = inserts['fusion'].length

      if ("fusion_"+fusion in insert_sequences) {
         sequence = insert_sequences["fusion_"+fusion];
      } else {
        sequence = "";
        var sequence = prompt("We do not have a sequence on record for this, please specify the sequence to use:", val['sequence']);
      }
      if (sequence === null) {
        sequence = "";
      }

      inserts['fusion'].push({type: "fusion", name: fusion, order: order_in_icl_insert, sequence: sequence});

      // fusion = {method: fusion, type: "Fusion", range: range, info: "", order: order_in_icl_insert, insert_location: "fusion"};
      // modifications.push(fusion);
      // overlay_modifications();
      // modifications_overview();
      inserts_overview();
      // console.log(inserts['fusion']);
    }


    function add_other_fusion(insert_location,insert_type,insert_sub_type){

      order_in_icl_insert = inserts[insert_location].length

      if (insert_type+"_"+insert_sub_type in insert_sequences) {
         sequence = insert_sequences[insert_type+"_"+insert_sub_type];
      } else {
        sequence = "";
      }

      if (insert_type=='linker') {
        sequence = insert_sub_type;
        insert_sub_type = 'custom';
      }

      if (sequence == "") {
        var sequence = prompt("We do not have a sequence on record for this, please specify the sequence to use:", val['sequence']);
      }
      if (sequence === null) {
        sequence = "";
      }

      inserts[insert_location].push({type: insert_type, name: insert_sub_type, order: order_in_icl_insert, sequence: sequence});

      range = new Array;
      range.push("");

      // insert = {method: insert_type+":"+insert_sub_type, type: "Insert", range: range, info: "", order: order_in_icl_insert, insert_location: insert_location};
      // modifications.push(insert);
      // modifications_overview();
      console.log(inserts);
      inserts_overview();


    }

    function edit_sequence(location,order){
      order = parseInt(order);
      $.each(inserts[location], function(key,val) {
        if (val['order']==order) {
          var sequence = prompt("Please specify the sequence to use:", val['sequence']);
          if (sequence!=null){
            inserts[location][key]['sequence'] = sequence;
          }
          return false;
        }
      });
      rebuild_insert_order();
      inserts_overview();
    }

    function remove_insert(location,order){
      order = parseInt(order);
      $.each(inserts[location], function(key,val) {
        if (val['order']==order) {
          inserts[location].splice(key, 1);
          return false;
        }
      });
      rebuild_insert_order();
      inserts_overview();
    }

    function change_insert(direction,location,order){
      order = parseInt(order);
      if (direction == "up"){
        if ((order)>0) { //dont go too far
          $.each(inserts[location], function(key,val) {
            if (val['order']==(order-1)) { //this is the one to replace
              val['order'] += 1;
            } else if (val['order']==order) { //this is the one to replace
              val['order'] -= 1;
            }
          })
        }
      } else if (direction == "down"){
        console.log('move '+order+' down'+(order+1));
        if ((order+1)<inserts[location].length) { //dont go too far
          console.log('move '+order+' down');
          $.each(inserts[location], function(key,val) {
            valorder = parseInt(val['order']);
            console.log(val);
            if (valorder==order) { //this is the one to replace
              val['order'] += 1;
            } else if (valorder==(order+1)) { //this is the one to replace
              val['order'] -= 1;
            }
            console.log(val);
          })
        }
      }
      inserts_overview();
    }

    function rebuild_insert_order() {
      console.log("rebuild_insert_order!");
      fusionpos = $('input:radio[name=fusionpos]:checked').val();
      // $.each(modifications, function(key,val) { //remove all inserts
      //   console.log(val);
      //   type = val['type'];
      //   if (type == 'Fusion' || type == 'Insert' ) {
      //     modifications.splice(key, 1);
      //   }
      // });
      for(var i = 0; i < modifications.length; i++) {
          type =  modifications[i]['type'];
          if (type == 'Fusion' || type == 'Insert' ){
            modifications.splice(i, 1);
              i--;
          }
      };

      $.each(['nterm','fusion','cterm'], function(key,segment) {
        //console.log(segment);
        inserts[segment].sort(function(a, b) {
            return a.order - b.order
        })
        $.each(inserts[segment], function(key,val) {
          val['order'] = key;
          console.log("segment"+segment);
          console.log(val);
          console.log("icl_cut"+icl_cut);
          if (segment=='fusion' && icl_cut) {
            range = icl_cut;
          } else if (val['range']) {
            range = val['range'][0];
          } else {
            range = "";
          }
          if (fusionpos =='None' ||  fusionpos =='nterm') {
            range = "";
          }

          insert = {method: val['type']+":"+val['name'], type: "Insert", range: [range], info: "", order: val['order'], insert_location: segment, sequence: val['sequence']};
          console.log('CHECK INSERT' + insert);
          modifications.push(insert);
          console.log(modifications);
        });
      });

    }

    function mut(elem) {
      gn = $(elem).attr("gn");
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).parent().parent().parent().find('.origin').html();
      origin = $(elem).attr("title");
      origin = $(elem).parent().attr("origin");


      console.log(origin);

      range = new Array;
      range.push(pos);


      modi = {method: wt+pos+to+" "+gn, type: "mutation", to: to, range: range, info: "Based on: "+origin.split(',').join(', ')};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
    }

    function glyco(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");
      to2 = $(elem).attr("to2");
      wt2 = $(elem).attr("wt2");

      origin = $(elem).attr("motif");

      // console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Glycosylation", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      if (to2) {
      range = new Array;
      pos2 = parseInt(parseInt(pos)+1)
      range.push(pos2);
      modi = {method: wt2+pos2+to2 + " Glycosylation", type: "mutation", to: to2, range: range, info: "Based on "+origin};
      modifications.push(modi);
      }

      overlay_modifications();
      modifications_overview();
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
    }

    function palmi(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).attr("motif");

      // console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Palmitoylation site removal", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      overlay_modifications();
      modifications_overview();
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
    }

    function modifications_overview() {
      console.log("Start modifications_overview");

      rebuild_insert_order();
      overlay_modifications();
      make_combinations();

      // $("#overview").html("");
      tables["overview"] = [];
      tables["overview"].push(info_text['current'] + "<table class='table-striped table table-bordered'><tr><th>Type</th><th>Modification</th><th>Pos/Range</th><th>Based on</th><th>Fix</th><th>Extra</th></tr>");

      console.log(modifications);
      modifications.sort(function(a, b) {

          console.log(a.type);
          var o1 = a.type.toLowerCase();
          var o2 = b.type.toLowerCase();

          var p2 = a.method.toLowerCase();
          var p1 = b.method.toLowerCase();
          if (a.type=='mutation' && b.type=='mutation') {
            var p1 = a.range;
            var p2 = b.range;
          }


          var q1 = a.range;
          var q2 = b.range;

          if (o1 < o2) return -1;
          if (o1 > o2) return 1;
          if (p1 < p2) return -1;
          if (p1 > p2) return 1;
          if (q1 < q2) return -1;
          if (q1 > q2) return 1;
        })

      $.each(modifications, function(key,val) {

        type = val['type'];
        range = val['range'];
        method = val['method'];
        from = val['from'];

        fix_checked = '';
        mod_class = '';
        if (val['fixed']) {
          if (val['fixed']=='yes'){
            fix_checked = 'checked';
            mod_class = 'fixed';
          }
        }

        if (val['ignored']) {
          if (val['ignored']=='true'){
            mod_class = 'ignored';
          }
        }

        if (val['info']) {
          info = "<p>"+val['info']+"</p>";
        } else {
          info = "";
        }

        if (val['range'].length == 1 ) {
          range = val['range'];
        } else {
          // console.log(val['range']);
          // a = val['range'].split(',');
          range = val['range'][0]+" - "+val['range'][val['range'].length - 1];
        }

        if (type == 'Fusion' || type == 'Insert' ) {
          range = val['insert_location']+":"+val['order'];
        }


        row =  "<h3>"+method+" ("+type+")</h3>" +
            "<div>" +
            // "  <p>Based from "+from+"</p>" +
            // "  <p>"+range+"</p>" +
            info +
            "  <button onclick='remove_mod(this)' mod_id="+key+">Remove</button>" +
            "</div>"
        row =  "<tr class="+mod_class+"><td>"+type+"</td><td>"+method+"</td><td>"+range+"</td><td>"+val['info']+"</td><td><input class='fix_"+type+"_"+method+"' fix_type='"+type+"_"+method+"'  mod_id="+key+" type=checkbox "+fix_checked+"  onclick='update_fix(this);'></td><td class=mod_buttons><button class='btn btn-secondary' onclick='remove_mod(this)' mod_id="+key+">Remove</button></td></tr>";
        // $("#overview").append(row);
        tables["overview"].push(row);

      })
      tables["overview"].push("</table>");

      tables["overview"] = tables["overview"].join( "" );
      tables["overview"] += "<br>"+possible_combinations+" possible combinations<hr>";
      $.each(export_list['sequences'], function(key,seq) {
        tables["overview"] += "Combination #"+(key+1)+":<br>"+seq[1]+"<br>";
      });
      // $( "#overview" ).accordion( "refresh" );
      // $( "#overview" ).accordion({
      //   collapsible: true,
      //   active: false,
      // });

    }


    function inserts_overview() {
      console.log("Start inserts_overview");

      // $("#overview").html("");
      tables["inserts"] = [];
      tables["inserts"].push(info_text['current'] + "<table class='table-striped table table-bordered'><tr><th>Segment</th><th>Type</th><th>Subtype</th><th>Sequence</th><th>Order</th></tr>");
      $.each(['nterm','fusion','cterm'], function(key,segment) {

        //console.log(segment);
        inserts[segment].sort(function(a, b) {
            return a.order - b.order
        })
        $.each(inserts[segment], function(key2,val) {
          console.log(val);
          type = val['type'];
          subtype = val['name'];
          order = val['order'];
          sequence = val['sequence'];
          if (sequence.length>18) {
            sequence = sequence.substring(0, 16)+"...";
          }

          row =  "<tr><td>"+segment_pretty[key]+"</td><td>"+type+"</td><td>"+subtype+"</td><td>"+sequence+" <a href=# onclick=edit_sequence('"+segment+"','"+order+"');><span class='glyphicon glyphicon-edit'></span></a></td><td>"+order+" <a href=# onclick=change_insert('up','"+segment+"','"+order+"');><span class='glyphicon glyphicon-arrow-up'></span></a> <a href=# onclick=change_insert('down','"+segment+"','"+order+"');><span class='glyphicon glyphicon-arrow-down'></a> <a href=# onclick=remove_insert('"+segment+"','"+order+"');><span class='glyphicon glyphicon-remove-sign'></a> </td></tr>";
          tables["inserts"].push(row);

        });

      })
      tables["inserts"].push("</table>");

      overlay_modifications();

      tables["inserts"].push("Sequence: "+sequence_short);

      tables["inserts"] = tables["inserts"].join( "" );
      $("#inserts_table").html(tables["inserts"]);
      // $( "#overview" ).accordion( "refresh" );
      // $( "#overview" ).accordion({
      //   collapsible: true,
      //   active: false,
      // });

    }


    function make_combinations() {

      // groups that can only have on choice -- so if any is fixed, then ignore the rest
      unique_groups = {"deletion_c-term":[0,0,[],[]],"deletion_n-term":[0,0,[],[]],"deletion_ICL2":[0,0,[],[]],"deletion_ICL3":[0,0,[],[]],"mutation":[0,0,[],[],[]]};
      //0 is combination options
      //1 is amount of fixed in this type (normally 1 but more for mutations)
      //2 is the key that is fixed
      //3 is the options to ignore from making
      //4 is the mutations that are fixed, to differenciate the ones that are combi

      combination_groups = [[],[],[],[],[]];

      $.each(modifications, function(key,val) {
          fix_type = val['type']+"_"+val['method'];
          val['ignored'] = "false";
          if (fix_type in unique_groups) {
            if(val['fixed']=='yes') {
              unique_groups[fix_type][1] += 1;
              unique_groups[fix_type][3] = unique_groups[fix_type][2];
              unique_groups[fix_type][2] = key; // only this key should be in the list to make combinations from
            } else {
              unique_groups[fix_type][0] += 1;
              if (unique_groups[fix_type][1]==0) {
                unique_groups[fix_type][2].push(key);
              } else {
                unique_groups[fix_type][3].push(key);
              }
            }
          }
          if (val['type']=="mutation") {
            //fixed will be fixed but include the rest as combinations
            if(val['fixed']=='yes') {
              unique_groups["mutation"][4].push(key);
              unique_groups["mutation"][1] += 1;
            } else {
              //if combination mutation
              unique_groups["mutation"][0] += 1;
              unique_groups["mutation"][2].push(key);

            }
          }
      });

      // console.log(unique_groups);
      possible_combinations = 1;
      modifications_to_do = []
      $.each(unique_groups, function(key,val) {
        $.each(val[3], function(key,ignored) {
          modifications[ignored]['ignored'] = "true";
        });
        if (val[1]!=0) {
          // do nothing, since there is only one
          if (key!='mutation') {
            modifications_to_do.push([val[2]]);
          } else {
            // add the combination possibilities to its own array
            if (val[2]) {
              modifications_to_do.push(val[2]);
              possible_combinations *= val[0];
            }

            $.each(val[4], function(key,val) {
              // add the fixed mutations one at a time
              modifications_to_do.push([val]);
            });
          }
        } else if (val[0]!=0) {
          //if combinations but it's not a batch with only one option (val[1])
          possible_combinations *= val[0];
          if (key!='mutation') {
            modifications_to_do.push(val[2]); //add all combinations to a single array
          } else {
            if (val[2]) modifications_to_do.push(val[2]); //add all combinations to a single array
            //for the case of mutations,
            $.each(val[4], function(key,val) {
              // add the fixed mutations one at a time
              modifications_to_do.push([val]);
            });
          }
        }
      });



      possible = allPossibleCases(modifications_to_do);
      console.log("Do comb");
      // console.log(modifications_to_do);
      // console.log(possible);
      export_list['sequences'] = [];
      $.each(possible, function(key,val) {
        // ensure it is a string
        val = String(val);
        generate_sequence(val);
      });
      console.log(export_list['sequences']);
    }

    function update_fix(elem) {
      id = $(elem).attr("mod_id");
      fix_group = $(elem).attr("fix_type");
      fix_checked = elem.checked;
      console.log("check update "+fix_checked+" "+id+" reset: "+fix_group);

      reset_fixed(fix_group);
      if (fix_checked){
        // if checked
        console.log("TRUE NOW "+fix_checked);
        modifications[id]['fixed'] = 'yes';
      }

      modifications_overview();
      $("#ModalBody").html(tables["overview"]);

    }

    function remove_mod(elem) {
      id = $(elem).attr("mod_id");
      // console.log('remove id'+id)
      //delete modifications[id];

      if (modifications[id]['type'] == 'Fusion' || modifications[id]['type'] == 'Insert') {
        // if fusion/insert
        inserts[modifications[id]['insert_location']].splice(modifications[id]['order'], 1);
      }

      modifications.splice(id, 1);
      resetModifications();
      overlay_modifications();
      modifications_overview();
      $("#ModalBody").html(tables["overview"]);

    }

    function generate_sequence(include) {
      console.log("Start generating a sequence");
      console.log(include);
      include = include.split(",");
      track_pos = {};
      fusion_site_location = -1;

      fusionpos = $('input:radio[name=fusionpos]:checked').val();

      $.each(modifications, function(key,val) {

        if ($.inArray(String(key), include)==-1 && val['type']!="Insert") {
          return true;
        }
        type = val['type'];
        range = val['range'];

        if (type == 'Insert') {
          if (val['insert_location']=='fusion'){

            console.log('fusion! ');
            console.log(val);
            fusion_site_location = val['range'][0];
          }
        }

        $.each(range, function(i, ii){
          // console.log(ii,type);
          if (ii){
            track_pos[ii] = val;
          }
        })

      })
      console.log("Fusion would be around "+fusion_site_location);
      sequence = "";
      sequence_short = "";
      sequence_short_2 = "";
      sequence_long = "";
      find_n_term = 0;
      $.each(inserts["nterm"], function(key,val) {
          sequence += "["+val['type']+":"+val['name']+"]";
          sequence_short += "["+val['type']+":"+val['name']+"]";
          sequence_short_2 += "["+val['type']+":"+val['name']+"]";
          if (val['sequence']) {
            sequence_long += val['sequence'].toLowerCase();
          } else {
            sequence_long += "["+val['type']+":"+val['name']+"]";
          }
          find_n_term = 1;
      });

      if (fusionpos=='nterm') {
            $.each(inserts["fusion"], function(key,val) {
                sequence += "["+val['type']+":"+val['name']+"]";
                sequence_short += "["+val['type']+":"+val['name']+"]";
                sequence_short_2 += "["+val['type']+":"+val['name']+"]";
                if (val['sequence']) {
                  sequence_long += val['sequence'].toLowerCase();
                } else {
                  sequence_long += "["+val['type']+":"+val['name']+"]";
                }
            });
            fusion_site_location = 0;
          find_n_term = 1;
      }

      if (find_n_term==0){
          sequence_short_2 += "[ADD N-TERM INSERTS]";
      }

      add_wt_start = 1;
      $.each(residues_pos, function(key,val) {
        // console.log(key);
        // console.log(val);
        if (track_pos[key]){
          // if in here, either delete or add mutation
          // console.log(track_pos[key]);
          if (add_wt_start==0){
            //if we were in a strech and got cut off
             sequence_short += key+"]";
          }
          if (track_pos[key]['type']=='mutation') {
            sequence += track_pos[key]['to'];
            sequence_short += "[MUT:"+val[0]+key+""+track_pos[key]['to']+"]";
            sequence_short_2 += "[MUT:"+val[0]+key+""+track_pos[key]['to']+"]";
            sequence_long += track_pos[key]['to'].toLowerCase();

          } else {
            // check for fusion site
            // console.log(key);
            if (fusion_site_location!=-1) {
              if (key==fusion_site_location && fusionpos!='None') {
                console.log('WE ARE AT FUSION SITE!');
                  $.each(inserts["fusion"], function(key,val) {
                      sequence += "["+val['type']+":"+val['name']+"]";
                      sequence_short += "["+val['type']+":"+val['name']+"]";
                      sequence_short_2 += "["+val['type']+":"+val['name']+"]";
                      if (val['sequence']) {
                        sequence_long += val['sequence'].toLowerCase();
                      } else {
                        sequence_long += "["+val['type']+":"+val['name']+"]";
                      }
                  });
              }
            }

          }
          add_wt_start = 1;
        } else {
          sequence += val[0];
          sequence_long += val[0].toUpperCase();
          sequence_short_2 += val[0].toUpperCase();
          if (add_wt_start){
             sequence_short += "["+receptor_name+":"+key+"-";
             add_wt_start = 0;
          }
          last_key_in_stretch = key;
          // console.log('added');
        }
      });
      if (add_wt_start==0){
            //if we were in a strech and got cut off
             sequence_short += last_key_in_stretch+"]";
          }

      find_c_term = 0;
      $.each(inserts["cterm"], function(key,val) {
          sequence += "["+val['type']+":"+val['name']+"]";
          sequence_short += "["+val['type']+":"+val['name']+"]";
          sequence_short_2 += "["+val['type']+":"+val['name']+"]";
          if (val['sequence']) {
            sequence_long += val['sequence'].toLowerCase();
          } else {
            sequence_long += "["+val['type']+":"+val['name']+"]";
          }
          find_c_term = 1;
      });
      if (find_c_term==0){
          sequence_short_2 += "[ADD C-TERM INSERTS]";
      }

      export_list['sequences'].push([include.sort(function (a, b) {  return a - b;  }),sequence_short,sequence_long,sequence_short_2]);

      return [sequence_short,sequence_long];
    }

    function overlay_modifications() {
      console.log("Start overlay_modifications");

      track_pos = {};
      fusion_site_location = -1;

      fusionpos = $('input:radio[name=fusionpos]:checked').val();
      // console.log("fusionpost"+fusionpos);

      $.each(modifications, function(key,val) {
        type = val['type'];
        range = val['range'];
        // console.log(val);

        if (type == 'Insert') {
          if (val['insert_location']=='fusion'){
            fusion_site_location = val['range'][0];
            console.log('fusionsite:'+fusion_site_location);
          }
        }

        $.each(range, function(i, ii){
          // console.log(ii,type);
          if (ii){
            color_residue(ii,type);
            track_pos[ii] = val;
          }
        })

      })
      // console.log(track_pos);
      sequence = "";
      sequence_short = "";
      sequence_long = "";
      $.each(inserts["nterm"], function(key,val) {
          sequence += "["+val['type']+":"+val['name']+"]";
          sequence_short += "["+val['type']+":"+val['name']+"]";
          if (val['sequence']) {
            sequence_long += val['sequence'];
          } else {
            sequence_long += "["+val['type']+":"+val['name']+"]";
          }
      });

      if (fusionpos=='nterm') {
            $.each(inserts["fusion"], function(key,val) {
                sequence += "["+val['type']+":"+val['name']+"]";
                sequence_short += "["+val['type']+":"+val['name']+"]";
                if (val['sequence']) {
                  sequence_long += val['sequence'];
                } else {
                  sequence_long += "["+val['type']+":"+val['name']+"]";
                }
            });
            fusion_site_location = 0;
      }

      add_wt_start = 1;
      $.each(residues_pos, function(key,val) {
        // console.log(key);
        // console.log(val);
        if (track_pos[key]){
          // if in here, either delete or add mutation
          // console.log(track_pos[key]);
          if (add_wt_start==0){
            //if we were in a strech and got cut off
             sequence_short += key+"]";
          }
          if (track_pos[key]['type']=='mutation') {
            sequence += track_pos[key]['to'];
            // console.log('mutation'+track_pos[key]);
            sequence_short += "[MUT:"+val[0]+key+""+track_pos[key]['to']+"]";
            sequence_long += track_pos[key]['to'];

          } else {
            // check for fusion site
            // console.log(key);
            if (fusion_site_location!=-1) {
              if (key==fusion_site_location && fusionpos!='None') {
                console.log('WE ARE AT FUSION SITE!');
                  $.each(inserts["fusion"], function(key,val) {
                      sequence += "["+val['type']+":"+val['name']+"]";
                      sequence_short += "["+val['type']+":"+val['name']+"]";
                      if (val['sequence']) {
                        sequence_long += val['sequence'];
                      } else {
                        sequence_long += "["+val['type']+":"+val['name']+"]";
                      }
                  });
              }
            }

          }
          add_wt_start = 1;
        } else {
          sequence += val[0];
          sequence_long += val[0];
          if (add_wt_start){
             sequence_short += "["+receptor_name+":"+key+"-";
             add_wt_start = 0;
          }
          last_key_in_stretch = key;
          // console.log('added');
        }
      });
      if (add_wt_start==0){
            //if we were in a strech and got cut off
             sequence_short += last_key_in_stretch+"]";
          }

      $.each(inserts["cterm"], function(key,val) {
          sequence += "["+val['type']+":"+val['name']+"]";
          sequence_short += "["+val['type']+":"+val['name']+"]";
          if (val['sequence']) {
            sequence_long += val['sequence'];
          } else {
            sequence_long += "["+val['type']+":"+val['name']+"]";
          }
      });
          // console.log(sequence.length);
          // console.log(sequence);
          // console.log(sequence_short);

    }

    function color_residue(pos, type) {

     if (type == 'deletion') {
        bg = 'red';
        fill = 'white';
     } else if (type == 'mutation') {
        bg = 'yellow';
        fill = 'red';
     }

     $('#'+pos+'t').css("fill", fill);
     $('#'+pos+'t').prev().css("fill", bg);


    }

  // Make snake plot big
  $(document).ready(function() {

    $('input[type=radio][name=state], input[type=radio][name=fusionpos]').change(function() {
          build_nterm_menu();
          build_cterm_menu();
          {% if class == 'A' or class == 'F' %}
              build_icl3_menu();
          {% elif class == 'B' or class == 'C' %}
              build_icl2_menu();
          {% endif %}
    });

    $( "#overview" ).accordion({
      collapsible: true,
      active: false,
    });

        $( "#dialog" ).dialog({
      autoOpen: false,
      show: {
        effect: "blind",
        duration: 200
      },
      hide: {
        effect: "explode",
        duration: 200
      },
      buttons: {
        "Reset": function() {
          $( this ).dialog( "close" );
          resetAll();
        },
        Cancel: function() {
          $( this ).dialog( "close" );
        }
      }
    });

        $(".long").show();
        $(".short").hide();
        maxmin();

      // http://localhost:8000/construct/tool/json/nterm/adrb2_human/
      $.getJSON( "/construct/tool/json/nterm/{{target.entry_name}}/", function( data ) {
          n_term_data = data;
          build_nterm_menu();
          load_status += 1;
          updateLoadStatus();
        });

      // http://localhost:8000/construct/tool/json/cterm/adrb2_human/
      $.getJSON( "/construct/tool/json/cterm/{{target.entry_name}}/", function( data ) {
          c_term_data = data;
          build_cterm_menu();
          load_status += 1;
          updateLoadStatus();
        });

      //and residues.ICL3|length > 8
    {% if class == 'A'  or class == 'F' %}
      // http://localhost:8000/construct/tool/json/icl3/adrb2_human/
      $.getJSON( "/construct/tool/json/icl3/{{target.entry_name}}/", function( data ) {
          icl3_data = data;
          build_icl3_menu();
          load_status += 1;
          updateLoadStatus();
        });
    {% elif class == 'B' or class == 'C' %}
      // http://localhost:8000/construct/tool/json/icl3/adrb2_human/
      $.getJSON( "/construct/tool/json/icl2/{{target.entry_name}}/", function( data ) {
          icl2_data = data;
          build_icl2_menu();
          load_status += 1;
          updateLoadStatus();
        });
    {% else %}
      icl3_data = [];
      load_status += 1;
    {% endif %}


      $.getJSON( "/construct/tool/json/glyco/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( type, val ) {
            temp = "<li id='" + type + "' class=\"dropdown-submenu\"><a>" + type + " ("+Object.keys(val).length+" hits)</a><ul class=\"dropdown-menu\">";
            $.each( val, function( key, value ) {
                if (type == 'mammalian') {
                temp += "<li id='"+key+"'  class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+" ("+value[5]+")</a><ul  class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' to2='"+value[3]+"' wt2='"+value[4][1]+"'> Mutate "+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+"</a></li></ul></li>";
                } else {
                temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
                }
            });

            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#glyco").html(result);
          removals_list["glyco"] = data;
          build_site_removals();
          load_status += 1;
          updateLoadStatus();
        });

      // http://localhost:8000/construct/tool/json/palmi/adrb2_human/
      $.getJSON( "/construct/tool/json/palmi/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( type, val ) {
            temp = "";
            $.each( val, function( key, value ) {
                temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='palmi(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
            });

            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#palmi").html(result);
          removals_list["palmi"] = data;
          build_site_removals();
          load_status += 1;
          updateLoadStatus();
        });

        $.getJSON( "/construct/tool/json/cons_strucs/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_strucs").html(result);
          mutations_browser['cons_strucs'] = data;
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });

        $.getJSON( "/construct/tool/json/cons_rf/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rf").html(result);
          mutations_browser['cons_rf'] = data;
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });

        $.getJSON( "/construct/tool/json/cons_rf_and_class/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rf_and_class").html(result);
          mutations_browser['cons_rf_and_class'] = data;
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });




        $.getJSON( "/construct/tool/json/cons_rm_GP/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rm_GP").html(result);
          mutations_browser['cons_rm_nonconserved_GP'] = data['non-conserved'];
          mutations_browser['cons_rm_conserved_G'] = data['conserved'];
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });

      $.getJSON( "/construct/tool/json/termo/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( level, gns ) {
            if (level == 1) {
              level_text = "From target recepter"
            } else if (level == 2) {
              level_text = "Common mutation (Mut)"
            } else if (level == 3) {
              level_text = "Common mutation (Wt)"
            } else if (level == 4) {
              level_text = "Single common mutation (Wt)"
            }
            mutations_browser['termo_'+level_text] = gns;
            temp = "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + level_text + "</a><ul class=\"dropdown-menu\">";
            $.each( gns, function( gn, aa ) {
                $.each( aa, function( key, value ) {

                extra = " to ";
                to = key ;
                number = value['pdbs'].length;
                if (level == 2) {
                  extra = " to ";
                  from = value['wt'][0];
                  to = key;
                  number = value['proteins'].length;
                } else if (level ==3 ){
                  extra = " to " + value['muts'] + " from ";
                  to = value['muts'];
                  number = value['proteins'].length;
                }

                temp += "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + gn + extra + " ("+number+" hits)</a><ul class=\"dropdown-menu\">";
                temp += "<li><a>"+gn+" in {{target.entry_name}} is "+value['wt'][0]+"</a></li>";
                temp += "<li class=\"divider\"></li>";

                // pos = to.split(",");
                if (level == 3) {
                  $.each(to, function(key,pos){
                    temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+pos+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+pos+"</strong></a></li>";
                  })
                } else {
                  temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+to+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+to+"</strong></a></li>";
                }
                temp += "<li class=\"divider\"></li>";
                if (level == 1 ) {
                  $.each(value['pdbs'], function(i, pdb) {
                      temp += "<li id='" + level + "'><a>" + pdb+"</a>";
                  })
                } else if (level == 2 || level == 3 ) {
                  $.each(value['proteins'], function(i, pdb) {
                      temp += "<li id='" + level + "'><a>" + pdb+"</a>";
                  })
                }
                // temp += "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + key + " ("+value['hits']+" hits)</a>";
                // temp += "<ul class=\"dropdown-menu\"><li></li></ul>";

                temp += "</li>";
                temp += "</ul></li>";
                });
             });
            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#thermo").html(result);
        });
          build_mutations();
          load_status += 1;
          updateLoadStatus();

    });

      $.getJSON( "/construct/tool/json/struc_rules/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( level, gns ) {
            mutations_browser['struc_rules_'+level] = gns;
        });
          build_mutations();
          load_status += 1;
          updateLoadStatus();

    });
</script>
{% endblock %}
