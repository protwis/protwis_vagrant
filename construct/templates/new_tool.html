{% extends "home/base.html" %}
{% load static %}
{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
{% endblock %}
{% block content %}
  <style>

  .btn_break{
    white-space:normal !important;
        max-width:100px;
  }

  .glyphicon-large {
    font-size: 25px;
    margin-top: -0.5em;
    margin-left: 0.5em;
    position:absolute;
    top:50%;
    height:10em;
    cursor: help;
  }

  .ui-menu { width: 200px; }
  .ui-widget-header { padding: 0.2em; }
  .info_text {padding: 0.2em;}
  .tooltip{}
  .large.tooltip-inner {
      max-width: 450px;
      width: 450px;
      text-align:left;
    }
  .medium.tooltip-inner {
      max-width: 300px;
      width: 300px;
    }

  select.form-control {
    height: 34px;
    font-size: 14px;
  }

  .fixed td:not(.mod_buttons){
    font-weight: bold;
  }


  .ignored td:not(.mod_buttons) {
    font-weight: lighter;
  }

    @media (min-width: 1600px){
        #content {
            width: 90%;
        }
    }

  #possibilities td, #possibilities th {
    text-align:center;
    vertical-align:middle;
  }

  .table-condensed{
    font-size: 10px;
  }

  tr.error {
    background-color: red;
  }

  .fadeMe {
  background: #000;
  width:      100%;
  height:     100%;
  z-index:    1001;
  top:        0;
  left:       0;
  position:   fixed;
}
#close {
    padding:25px 35px;
    background:#F00;
    display: none;
    position:   absolute;
    top: 15px;
    left: 15px;
    cursor: pointer; cursor: hand;
}
#fullscreensvg {
    position: absolute;
    top: 15px;
    right: 15px;
    cursor: pointer; cursor: hand;
    opacity: 0.8;
}
.table-nonfluid {
   width: auto !important;
}
.mutation_scan_th {
  display: none;
}


  </style>

<div class="modal bd-example-modal-lg" id="myModal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>
      <div class="modal-body" id="ModalBody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="dialog" title="Reset">
  <p>You sure you want to reset this construct?</p>
</div>


<div id="dialogauto" title="Switch Mode">
  <p>You sure you want change to Truncation/fusion scan? All current changes will be deleted</p>
</div>

<div id="dialogauto_mut" title="Switch Mode">
  <p>You sure you want change to Mutation scan? All current changes will be deleted</p>
</div>


    <div class="row">
      <div class="col-sm-8">

        <h1 class="display-4">Construct Design Tool</h1>
        <p>This is a tool to design structure constructs based on all published GPCR structures. <br>A modification can be based on a closest template, most frequent solution or structural rationale (mutations).<br><a href="http://docs.gpcrdb.org/constructs.html#construct-design-tool"  target="_blank">Read about the tool here.</a> <button id=toolvideo mp4="https://files.gpcrdb.org/video/constructtool3.mp4" type="button" class="videoLink btn btn-xs btn-default">
                              <span class="glyphicon glyphicon-film"></span>
                            </button></p>

Target: {{target.name|safe}} ({{target.entry_name}})
<div class="row">
      <div class="col-sm-12">
      Applications:
      </div>


    </div>
    <div class="row">
      <div class="col-sm-12">

        <div class="btn-group" data-toggle="buttons">

          <label class="work_mode btn btn-default active">
            <input type="radio" name="work_mode" value="combi_mode_button" onclick='$( "#dialogauto" ).dialog( "open" )' checked> Truncation/fusion scan
          </label>

          <label class="work_mode btn btn-default">
            <input type="radio" name="work_mode" value="combi_mode_mut_button" onclick='$( "#dialogauto_mut" ).dialog( "open" )'> Mutation scan
          </label>

          <label class="work_mode btn btn-default">
            <input type="radio" name="work_mode" value="manual_mode_button" onclick='edit_mode();'>Custom constructs
          </label>

        </div>
        <button class="btn btn-default" onclick='$( "#dialog" ).dialog( "open" )'>Reset</button>
        <span onclick='showModal("Applications",tables["help_application"]);' class='glyphicon glyphicon-large glyphicon-question-sign'></span>
      </div>

    </div>


      <div style='width:500px'>
            <div class="row">
        <div class="col-sm-5">
              Fusion Site: <br>
          <div class="btn-group" data-toggle="buttons">
            <label class="btn btn-default">
              <input type="radio" name="fusionpos" value="nterm"> N-term
            </label>

              {% if class == 'A' or class == 'F' %}
            <label class="btn btn-default active">
              <input type="radio" name="fusionpos" value="icl3" checked=""> ICL3
            </label>
            {% elif class == 'B' or class == 'C' %}
            <label class="btn btn-default active">
              <input type="radio" name="fusionpos" value="icl3" checked=""> ICL2
            </label>
            {% endif %}
            <!-- <label class="btn btn-default">
              <input type="radio" name="fusionpos" value="both"> Both
            </label> -->
            <label class="btn btn-default">
              <input type="radio" name="fusionpos" value="None"> None
            </label>
          </div>
        </div>

        <div class="col-sm-5">
              File (Excel):<br>
          <button class="btn btn-default" onclick='exportToExcel();'>Save</button>
            <form action="/common/importexcel" style="display: inline;" method="post" id="file-upload-form" enctype="multipart/form-data">
                <label class="btn btn-default btn-file">
                  Open<input  id="id_file_source" name="file_source" type="file" style="display: none;">
                </label>
            </form>
        </div>
        <div class="col-sm-2">
          Snakeplot:<br>
          <div class="btn-group closed">
            <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="false" aria-expanded="false">
              <span class="glyphicon glyphicon-download"></span> Download <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
              <li>
                <a href="javascript:saveSvgAsPng(document.getElementById('snakeplot'), 'snake_construct_design.png', {scale: 3});">PNG</a>
              </li>
              <li>
                <a href="javascript:saveSvgAsJpg(document.getElementById('snakeplot'), 'snake_construct_design.jpg', {scale: 3});">JPG</a>
              </li>
              <li>
                <a href="javascript:saveSvgAsTiff(document.getElementById('snakeplot'), 'snake_construct_design.tiff', {scale: 3});">TIFF</a>
              </li>
              <li>
                <a id="snake_svg_link" href-lang="image/svg+xml" href="" download="snake_gp139_human">SVG</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

<!-- <button class="btn btn-info" onclick='exportCSVsuggestions();'>Export all suggestions</button> -->


      </div>

      <div class="col-sm-4" style="">

        <div id="snakeplot_div" style='height:300px;'>
      <!--   <span id='close' <button class="btn btn-info btn-xs" onclick='fullscreensvg();'><span class="glyphicon glyphicon-fullscreen"></span></button></span> -->
        <span id='fullscreensvg'><button id='fullscreenbutton' class="btn btn-info btn-xs" onclick='fullscreensvg();'><span class="glyphicon glyphicon-fullscreen"></span> Fullscreen </button></span>
        {{ target.get_snake_plot_no_buttons }}
        </div>
      </div>


    </div>


<span id='load'>
<span id=loadstatus>Please wait for the dataset to load</span>
<span id='method_options' style='display: none;'>

</span>
<br>
<div class="table-responsive">

        <!-- <button class="btn btn-warning btn-xs" onclick='showModal("Automatic Construct Design",tables["auto_combi"],"");automatic_helper();'>Automatic Construct Design</button>
        <button type="button" id="mutations_button" class="btn btn-primary btn-xs" onclick='showModal("Custom",tables["custom"]);'>
          User-defined mutation or deletion
        </button> -->
<h4 id='combi_mode'>Truncation/fusion scan
      </h4>
<table width=100%  id='possibilities' class='table table-bordered table-condensed table-striped'>
<thead>
<tr>
  <th colspan=2>Total constructs:</th>
  <th colspan=1 id='total_count'> 0 </th>
  <th rowspan="1" colspan="1" class='possiblities_nterm'  id='fusion_count_nterm'>0</th>
  <th rowspan="1" colspan="3" id='deletion_n-term_count'>0</th>
    {% if class == 'A'  or class == 'F' %}
  <th rowspan="1" colspan="3" id='deletion_ICL3_start_count'>0</th>
  <th rowspan="1" colspan="3" class='possiblities_icl' id='fusion_count'>0</th>
  <th rowspan="1" colspan="3" id='deletion_ICL3_end_count'>0</th>
      {% elif class == 'B' or class == 'C' %}
  <th rowspan="1" colspan="3" id='deletion_ICL2_start_count'>0</th>
  <th rowspan="1" colspan="3" class='possiblities_icl' id='fusion_count'>0</th>
  <th rowspan="1" colspan="3" id='deletion_ICL2_end_count'>0</th>
      {% endif %}
  <th rowspan="1" colspan="3" id='deletion_c-term_count'>0</th>
  <th rowspan="1" colspan="1">  </th>
  <th rowspan="1" colspan="1" id='mutation_count'>0</th>
  <th rowspan="1" colspan="1" class='mutation_scan_th' id='mutation_count_scan'>0</th>

<tr>
  <th rowspan="2">No</th>
  <th rowspan="2">Display snake-plot <br>
    <button type="button" id="delete_other" class="btn btn-primary btn-xs" onclick='delete_other();'>
          Delete other
    </button>
  </th>
  <th rowspan="2">
  <button type="button" id="other_inserts_button" class="btn btn-primary btn-xs btn_break" onclick='showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("nterm");inserts_overview(true);'>
          N-term Inserts
  </button>
  </th>
  <th rowspan="1" colspan="1" class='possiblities_nterm'>
    <button type="button" id="other_inserts_button" class="btn btn-primary btn-xs btn_break" onclick='showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("fusion");inserts_overview(true);'>
      Fusion
    </button>
  </th>
  <th rowspan="1" colspan="3">
  <button type="button" id="nterm_button" class="btn btn-primary btn-xs btn_break" onclick='build_nterm_menu();showModal("N-term",tables["nterm"],"#nterm_sug");'>
      {% if signal_p %}
      N-term / Signal Peptide truncation
      {% else %}
      N-term truncation
      {% endif %}
    </button>
    </th>
  <th rowspan="1" colspan="3">
    {% if class == 'A'  or class == 'F' %}
        <button type="button" id="icl3_start_button" class="btn btn-primary btn-xs btn_break" onclick='build_icl3_menu();showModal("ICL3 (Start)",tables["icl3_start"],"#icl3_sug_start");'>
        Fusion/Deletion site start (last kept Rec res)*
        </button>
      {% elif class == 'B' or class == 'C' %}
        <button type="button" id="icl2_start_button" class="btn btn-primary btn-xs btn_break" onclick='build_icl2_menu();showModal("ICL2 (Start)",tables["icl2_start"],"#icl2_sug_start");'>
        Fusion/Deletion site start (last kept Rec res)*
        </button>
      {% endif %}

  </th>
  <th rowspan="1" colspan="3" class='possiblities_icl'>

        <button type="button" id="other_inserts_button" class="btn btn-primary btn-xs btn_break" onclick='showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("fusion");inserts_overview(true);'>
          Fusion
        </button>

  </th>
  <th rowspan="1" colspan="3">

    {% if class == 'A'  or class == 'F' %}
        <button type="button" id="icl3_end_button" class="btn btn-primary btn-xs btn_break" onclick='build_icl3_menu();showModal("ICL3 (End)",tables["icl3_end"],"#icl3_sug_end");'>
        Fusion/Deletion site end (first kept Rec res)*
        </button>
      {% elif class == 'B' or class == 'C' %}
       <button type="button" id="icl2_end_button" class="btn btn-primary btn-xs btn_break" onclick='build_icl2_menu();showModal("ICL2 (End)",tables["icl2_end"],"#icl2_sug_start");'>
        Fusion/Deletion site end (first kept Rec res)*
        </button>
      {% endif %}


    </th>
  <th rowspan="1" colspan="3">
  <button type="button" id="cterm_button" class="btn btn-primary btn-xs btn_break" onclick='build_cterm_menu();showModal("C-term",tables["cterm"],"#cterm_sug");'>
      C-term truncation
    </button>
    </th>
  <th rowspan="2">
  <button type="button" id="other_inserts_button" class="btn btn-primary btn-xs  btn_break" onclick='showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("cterm");inserts_overview(true);'>
          C-term Inserts
  </button>
  </th>

  <th rowspan="2">
    <button type="button" id="mutations_mode" class="btn btn-primary btn-xs  btn_break" onclick='build_mutation_mode_table("known");showModal("Mutations",tables["mutations"],"#mutations");'>Add known stabilising mutations to all constructs</button>
  </th>
  <th rowspan="2" class='mutation_scan_th'>
    <button type="button" id="mutations_mode" class="btn btn-primary btn-xs  btn_break" onclick='build_mutation_mode_table("scan");showModal("Mutations",tables["mutations"],"#mutations");'>Add predicted mutations in separate constructs</button>
  </th>
</tr>
<tr>
  <th rowspan="1" class='possiblities_nterm'>N-term fusion***</th>
  <!-- <th rowspan="1" class='possiblities_nterm'>N-term linker</th> -->
  <th>N-term res kept before to TM1*</th>
  <th>Pos</th>
  <th>AA</th>
   {% if class == 'A' %}
  <th>BW</th>
  {% elif class == 'B' %}
  <th>Woot</th>
  {% elif class == 'C' %}
  <th>Pin</th>
  {% elif class == 'F' %}
  <th>Wang</th>
  {% else %}
  <th>BW</th>
  {% endif %}
  <th>Pos</th>
  <th>AA</th>

  {% if class == 'A'  or class == 'F' %}
    <th rowspan="1" class='possiblities_icl'>TM5-ICL3 linker (non-wt)</th>
    <th rowspan="1" class='possiblities_icl'>Fusion<!-- ICL3 modification (Fusion / Deletion / Wt) --></th>
    <th rowspan="1" class='possiblities_icl'>ICL3-TM6 linker (non-wt)</th>
  {% elif class == 'B' or class == 'C' %}
    <th rowspan="1" class='possiblities_icl'>TM3-ICL2 linker (non-wt)</th>
    <th rowspan="1" class='possiblities_icl'>Fusion<!-- ICL2 modification (Fusion / Deletion / Wt) --></th>
    <th rowspan="1" class='possiblities_icl'>ICL2-TM4 linker (non-wt)</th>
  {% endif %}

   {% if class == 'A' %}
  <th>BW</th>
  {% elif class == 'B' %}
  <th>Woot</th>
  {% elif class == 'C' %}
  <th>Pin</th>
  {% elif class == 'F' %}
  <th>Wang</th>
  {% else %}
  <th>BW</th>
  {% endif %}
  <th>Pos</th>
  <th>AA</th>
  <th>C-term res kept after h8*</th>
  <th>Pos</th>
  <th>AA</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>


<div class="table-responsive">

<h4 id='manual_mode'>Custom constructs
    <button type="button" id="add_manual" class="btn btn-primary btn-xs" onclick='add_manual_row()'>
      Add Construct (row)
    </button></h4>
<table width=100%  id='edit_mode' class='table table-bordered table-condensed table-striped'>
<thead>
<tr>
  <th rowspan="2">No</th>
  <th rowspan="2">Display snake-plot
  <!-- / mut scan / ref constr --></th>
  <!-- <th rowspan="2">Add</th> -->
  <th rowspan="2">
  N-term Inserts
  </th>
  <th rowspan="1" colspan="1" class='possiblities_nterm'>
  Fusion
  </th>
  <th rowspan="1" colspan="3">
      {% if signal_p %}
      N-term / Signal Peptide truncation
      {% else %}
      N-term truncation
      {% endif %}
    </th>
  <th rowspan="1" colspan="3">
    {% if class == 'A'  or class == 'F' %}
        Fusion/Deletion site start (last kept Rec res)*
      {% elif class == 'B' or class == 'C' %}
        Fusion/Deletion site start (last kept Rec res)*
      {% endif %}

  </th>
  <th rowspan="1" colspan="1" class='possiblities_icl'>
    Fusion

  </th>
  <th rowspan="1" colspan="3">

    {% if class == 'A'  or class == 'F' %}
        Fusion/Deletion site end (first kept Rec res)*
      {% elif class == 'B' or class == 'C' %}
        Fusion/Deletion site end (first kept Rec res)*
      {% endif %}


    </th>
  <th rowspan="1" colspan="3">
  C-term truncation
    </th>
  <th rowspan="2">
  C-term Inserts
  </th>

  <th colspan="1" rowspan="2">
    Mutations
  </th>
</tr>
<tr>
  <th rowspan="1" class='possiblities_nterm'>N-term fusion***</th>
  <!-- <th rowspan="1" class='possiblities_nterm'>N-term linker</th> -->
  <th>N-term res kept rel. to TM1*</th>
  <th>Pos</th>
  <th>AA</th>
   {% if class == 'A' %}
  <th>BW</th>
  {% elif class == 'B' %}
  <th>Woot</th>
  {% elif class == 'C' %}
  <th>Pin</th>
  {% elif class == 'F' %}
  <th>Wang</th>
  {% else %}
  <th>BW</th>
  {% endif %}
  <th>Pos</th>
  <th>AA</th>

  {% if class == 'A'  or class == 'F' %}
    <!-- <th rowspan="1" class='possiblities_icl'>TM5-ICL3 linker (non-wt)</th> -->
    <th rowspan="1" class='possiblities_icl'>Fusion<!-- ICL3 modification (Fusion / Deletion / Wt) --></th>
    <!-- <th rowspan="1" class='possiblities_icl'>ICL3-TM6 linker (non-wt)</th> -->
  {% elif class == 'B' or class == 'C' %}
    <!-- <th rowspan="1" class='possiblities_icl'>TM3-ICL2 linker (non-wt)</th> -->
    <th rowspan="1" class='possiblities_icl'>Fusion<!-- ICL2 modification (Fusion / Deletion / Wt) --></th>
    <!-- <th rowspan="1" class='possiblities_icl'>ICL2-TM4 linker (non-wt)</th> -->
  {% endif %}

   {% if class == 'A' %}
  <th>BW</th>
  {% elif class == 'B' %}
  <th>Woot</th>
  {% elif class == 'C' %}
  <th>Pin</th>
  {% elif class == 'F' %}
  <th>Wang</th>
  {% else %}
  <th>BW</th>
  {% endif %}
  <th>Pos</th>
  <th>AA</th>
  <th>C-term res kept after h8*</th>
  <th>Pos</th>
  <th>AA</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<div class="row">
</div>




<iframe id="my_iframe" style="display:none;"></iframe>
{% endblock %}

{% block addon_js %}

<script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
<script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
<script src="{% static 'home/js/diagrams.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
<script src="{% static 'home/js/select2.js' %}"> </script>
<script type="text/javascript" charset="utf-8">

if (navigator.userAgent.indexOf('Safari') != -1 && navigator.userAgent.indexOf('Chrome') == -1) {

  $("#content").prepend('<div class="alert alert-warning"><strong>Warning!</strong> <p>Safari browser has compability issues with the snakeplot display. The export results will be correct, but the diagram will have errors. To prevent these issues, use Firefox or Chrome.</div>');

}

  function upload() {
      event.preventDefault();
      var data = new FormData($('#file-upload-form').get(0));
      // console.log(data);
      $.ajax({
          url: $(this).attr('action'),
          type: $(this).attr('method'),
          data: data,
          cache: false,
          processData: false,
          contentType: false,
          success: function(data) {
              // console.log(data);
              modifications = new Array;
              resetModifications();
              $.each(data, function(i,mod){
                console.log(mod);
                if ( $.inArray(mod[0], ['Modifications # used','Short-hand','Sequence']) > -1 ) return true;
                mod.splice(0, 1);
                range_match = String(mod[2]).match(/([\d]+)-([\d]+)/);
                // console.log(range_match);
                range = new Array;
                if (range_match) {
                  // for (var i = range_match[1]; 1 > 0 ? i <= range_match[2] : i > range_match[2]; i += 1) {
                  //     range.push(i);
                  // }
                  start = parseInt(range_match[1]);
                  end = parseInt(range_match[2]);
                  for (var i = start; 1 > 0 ? i <= end : i > end; i += 1) {
                      range.push(i);
                  }
                } else {
                  range.push(parseInt(mod[2]));
                }

                if (mod[0]=='Insert' || mod[0]=='fusion') {
                  insert_location = mod[4];
                  order_in_icl_insert = mod[5];
                  insert_type = mod[1].split(":")[0];
                  insert_sub_type = mod[1].split(":")[1];
                  if (mod[2]){
                    // console.log('ICLCUT INFO, SET IT!');
                    icl_cut = mod[2];
                  }
                  inserts[insert_location].push({type: insert_type, name: insert_sub_type, order: order_in_icl_insert, sequence: mod[8]});
                }
                if (mod[9]!="yes"){
                  mod[9]="no";
                }
                modi = {method: mod[1], type: mod[0], to: mod[7], from:mod[6], range: range, info: mod[3], fixed: mod[9],extra: mod[10]};
                console.log(modi);
                modifications.push(modi);
              });
              // console.log(modifications);
              rebuild_insert_order();
              modifications_overview();
              // overlay_modifications();
          }
      });
      return false;
    }

    $(function() {
        $('#file-upload-form').submit(upload);
    });

    function allPossibleCases(arr) {
      if (arr.length === 0) {
        return [];
      }
    else if (arr.length ===1){
    return arr[0];
    }
    else {
        var result = [];
        var allCasesOfRest = allPossibleCases(arr.slice(1));  // recur with the rest of array
        for (var c in allCasesOfRest) {
          for (var i = 0; i < arr[0].length; i++) {
            result.push(arr[0][i] + "," + allCasesOfRest[c]);
          }
        }
        return result;
      }

    }

    $('#id_file_source').on("change", function(){ $('#file-upload-form').submit(); });

    var residues_pos = {{ residues_pos|safe }};

    var default_sort = {
        "paging":   false,
        "ordering": true,
        "info":     false,
        "bFilter": true,
        "bInfo": false,
        "order": [],
        // "fixedHeader": true,
        "scrollY": "600px",
        "autoWidth": false,
        "dom": 'lrtip'
    }

    var receptor_name = "{{target.entry_name}}".split("_")[0];

    {% if signal_p %}
    var signal_p = {{signal_p}};
    {% else %}
    var signal_p = '';
    {% endif %}

    var modifications = new Array;
    var tables = new Array;
    var mutations_browser = new Array;
    var mutations_mode_suggestions = [];
    var removals_list = new Array;
    var export_list = {};
    var load_status = 0;
    var sequence = '';
    var sequence_short = '';
    var sequence_long = '';
    var icl_cut = 0; //track where an ICL cut/insert starts to use for where to start ICL inserts
    var inserts = new Array;
    var possible_combinations = 1;
    var table_rows = new Array;
    var possible = new Array; //track the actual combinations
    var ICL_min = {{ICL_min|safe}}; // array to track min values of ICL2 and ICL3
    var ICL_max = {{ICL_max|safe}}; // array to track max values of ICL2 and ICL3
    var mutation_mode_on = false;
    var edit_mode_on = false;
    var combi_mode_on = true;
    var combi_mode_mut_on = false;

    var manual_constructs = new Array;
    var manual_inserts = new Array;

    var custom_additions = new Array;
    custom_additions['nterm'] = [];
    custom_additions['cterm'] = [];

    inserts['fusion'] = [];
    inserts['cterm'] = [];
    inserts['nterm'] = [];
    export_list['nterm'] = [];
    export_list['cterm'] = [];
    // export_list['icl3'] = [];
    export_list['icl3_start'] = [];
    export_list['icl3_end'] = [];
    export_list['icl2_start'] = [];
    export_list['icl2_end'] = [];
    export_list['thermo'] = [];
    export_list['removals'] = [];
    export_list['sequences'] = [];
    var info_text = {};



   {% if class == 'A' %}
     generic_label = 'BW';
    {% elif class == 'B' %}
     generic_label = 'Woot';
    {% elif class == 'C' %}
     generic_label = 'Pin';
    {% elif class == 'F' %}
     generic_label = 'Wang';
    {% else %}
     generic_label = 'BW';
    {% endif %}

    info_text['nterm'] = '<p class=info_text>Here you select the N-term truncation. The data comes from GPCR/receptor structures and is grouped by the truncation\'s distance to TM1. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest.</p>';

    info_text['icl2_start'] = '<p class=info_text>Select the start position for the truncation within ICL2. The data comes from GPCR/receptor structures and is grouped by their GPCRdb generic number. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest. Once the starting position is selected a new window will open to select the ending position.</p>';
    info_text['icl2_end'] = '<p class=info_text>Select the ending position for the ICL2 truncation.</p>';

    info_text['icl3_start'] = '<p class=info_text>Select the start position for the truncation within ICL3. The data comes from GPCR/receptor structures and is grouped by their GPCRdb generic number. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest. Once the starting position is selected a new window will open to select the ending position.</p>';
    info_text['icl3_end'] = '<p class=info_text>Select the ending position for the ICL3 truncation.</p>';

    info_text['cterm'] = '<p class=info_text>Here you select the C-term truncation. The data comes from GPCR/receptor structures and is grouped by the truncation\'s distance to TM8. It is possible to sort the data by occurrances (frequence) or by homology (Levels).</p>';
    info_text['termo'] = '<p class=info_text>Select mutation by click the mutation suggestion in the <i>Mutation</i> column.</p>';

    info_text['sites'] = '<p class=info_text>The tool recognizes possible site motifs. These can be attempted to be removed using the following mutations.</p>';
    info_text['custom'] = '<p class=info_text>Use options below to insert custom mutations or truncations not suggested by tool. You will be asked to confirm modification.</p>';
    info_text['current'] = '<p class=info_text>See current modifications below. These will be included if you export to excel.<br> If there are several modfications chosen for the same form of deletion then you can either generate multiple construct sequences with combinations of the choices. Alternatively you can fix to a chosen modification by ticking the Fix box.<br> In the same fashion mutations can be fixed or used to make multiple sequences</p>';
    info_text['inserts_general'] = '<p class=info_text>See current inserts below. For inserts in N- or C-term you can change the order they come in.<br>If you choose several fusion proteins, they will be used for combinations.</p>';
    info_text['auto_combi'] = '<p class=info_text>Automatic work mode generates all combinations of the selected truncation and fusion sites.<br>You have the option to delete specific combinations/constructs afterwards.<br>Specify the number of:</p>';
    info_text['mutations'] = "<strong>Manually add mutation</strong>: <input type='text' id='custom_pos' placeholder='sequence position'> to <input type='text' id='custom_mut' placeholder='aminoacid (1-letter)'> <input type='text'  id='custom_reason' placeholder='Reason'><input type=button value=Add onclick='custom_mut()'><div id=confirm_cus_mut></div>";


    tables["custom"] = [info_text['custom']]
    tables["custom"].push( "Mutate: <input type='text' id='custom_pos' placeholder='sequence position'> to <input type='text' id='custom_mut' placeholder='aminoacid (1-letter)'> <input type='text'  id='custom_reason' placeholder='Reason'><input type=button value=Add onclick='custom_mut()'><div id=confirm_cus_mut></div><br>");
    tables["custom"].push( "Deletion: <input type='text' id='custom_del_start' placeholder='from (sequence position)'> - <input type='text' id='custom_del_end' placeholder='to (sequence number)'> <input type='text'  id='custom_del_reason' placeholder='Reason'><input type=button value=Add onclick='custom_del()'><div id=confirm_cus_del></del><br>");
    tables["custom"] = tables["custom"].join( "" );

    combi_dropdown = "<option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>";

    tables["auto_combi"] = [info_text['auto_combi']]
    tables["auto_combi"].push( "<table class='table combitable'><tr><td>N-term truncation:</td><td><select id=combi_nterm class='form-control'>"+combi_dropdown+"</select></td></tr><tr><td>ICL start cut:</td><td><select id=combi_icl_start class='form-control'>"+combi_dropdown+"</select></td></tr><tr><td>ICL end cut:</td><td><select id=combi_icl_end class='form-control'>"+combi_dropdown+"</select></td></tr><tr><td>C-term truncation:</td><td><select id=combi_cterm class='form-control'>"+combi_dropdown+"</select></td></tr><tr><td></td><td><span id=combi_summary></span><button type='submit' class='btn btn-primary pull-right' onclick='auto_generate()'>Add</button></td></tr></table>");
    tables["auto_combi"] = tables["auto_combi"].join( "" );

    tables["help"] = ['See small movie with a sample usage of tool: <button onclick="$(\'#toolvideo\').click();" mp4="https://files.gpcrdb.org/video/constructtool3.mp4" type="button" class="videoLink btn btn-xs btn-default">' +
                        '<span class="glyphicon glyphicon-film"></span>' +
                        '</button>']

    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>State</strong></div><div class='col-sm-10'>Select either Inactive or Active to limit the dataset to be GPCR/receptor structures with chosen state.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Fusion site</strong></div><div class='col-sm-10'>Select if and where the fusion protein to be inserted. This is used to make suggestions for the intercelluar loop (ICL) truncation based on structures with fusion protein in same region.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Export</strong></div><div class='col-sm-10'>Export all suggestions to an excel sheet for local analysis.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Upload</strong></div><div class='col-sm-10'>Upload a previous construct design to continue work.</div></div>");
    tables["help"].push( "<br><div class='row'><div class='col-sm-2'><strong>Deletions</strong></div><div class='col-sm-10'>Methods to help guide truncations in different regions</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Mutations</strong></div><div class='col-sm-10'>Suggestions for thermostabilising mutations and for site removals</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Other</strong></div><div class='col-sm-10'>Create Custom modifications and see current modifications. Export current modificaitons to excel.</div></div>");
    tables["help"] = tables["help"].join( "" );

    tables["help_application"] = []
    tables["help_application"].push("<div class='row'><div class='col-sm-3'><strong>Truncation/fusion scan</strong></div><div class='col-sm-8'>Generates constructs covering all the unique combinations of user-selected truncations and/or fusions.</div></div><br>");
    tables["help_application"].push( "<div class='row'><div class='col-sm-3'><strong>Mutation scan</strong></div><div class='col-sm-8'>First designs one reference construct and then selects a number of stabilising mutations which are individually added to generate as many constructs.</div></div><br>");
    tables["help_application"].push( "<div class='row'><div class='col-sm-3'><strong>Custom constructs</strong></div><div class='col-sm-8'>Constructs are designed one at the time by repeated custom selection of truncations, fusions and mutations.</div></div>");
    tables["help_application"] = tables["help_application"].join( "" );


    // insert_sequences = new Array;


    insert_sequences = {"tag_His(10)": "HHHHHHHHHH",
                        "tag_His(8)": "HHHHHHHH",
                        "tag_FLAG": "DYKDDDDK",
                        "tag_FLAG_ala": "DYKDDDDA",
                        "fusion_T4 Lysozyme (T4L)": "NIFEMLRIDEGLRLKIYKDTEGYYTIGIGHLLTKSPSLNAAKSELDKAIGRNTNGVITKDEAEKLFNQDVDAAVRGILRNAKLKPVYDSLDAVRRAALINMVFQMGETGVAGFTNSLRMLQQKRWDEAAVNLAKSRWYNQTPNRAKRVITTFRTGTWDAY",
                        "fusion_BRIL (b562RIL)": "ADLEDNWETLNDNLKVIEKADNAAQVKDALTKMRAAALDAQKATPPKLEDKSPDSPEMKDFRHGFDILVGQIDDALKLANEGKVKEAQAAAEQLKTTRNAYIQKYL",
                        "fusion_Rubredoxin": "MKKYTCTVCGYIYNPEDGDPDNGVNPGTDFKDIPDDWVCPLCGVGKDQFEEVEE",
                        "fusion_Flavodoxin": "AKALIVYGSTTGNTEYTAETIARELADAGYEVDSRDAASVEAGGLFEGFDLVLLGCSTWGDDSIELQDDFIPLFDSLEETGAQGRKVACFGCGDSSWEYFCGAVDAIEEKLKNLGAEIVQDGLRIDGDPRAARDDIVGWAHDVRGAI",
                        "signal_hemagglutinin" : "MKTIIALSYIFCLVFA",
                        "prot_cleavage_Thrombin": "LVPRGS",
                        "prot_cleavage_TEV protease": "ENLYFQG"};

    // insert_sequences["tag_His(10)"] = "HHHHHHHHHH";


    fusion_protein_dropdown = "<select id=fusion_choice class='form-control'><option>Select from list</option>";
    fusion_proteins = {{inserts.fusions|safe}};
    for(var key in {{inserts.fusions|safe}}) {
      fusion_protein_dropdown += "<option>"+fusion_proteins[key]+"</option>";
    }

    fusion_protein_dropdown += "<input class='form-control hidden' type=value id='fusion_where'><input type=button class='btn btn-info' value=Add onclick='add_fusion(this)'>"

    other_inserts_dropdown = fusion_protein_dropdown+"<br><select class='form-control'>";
    other_inserts = {{inserts.other|safe}};
    for(var key in other_inserts) {
      for (var key2 in other_inserts[key]) {
        other_inserts_dropdown += "<option>"+key+" - "+other_inserts[key][key2]+"</option>";
      }
    }

    other_inserts_dropdown = "Please see <a href='https://files.gpcrdb.org/Insert_sequences.xlsx'>here</a> for exact sequences used in inserts. They are based on sequences used in published structures.<br><table><tr class='fusion_inserts fusion fusion_site_inserts'><th colspan=2 id=fusion_text>Fusion Protein</th></tr><tr class='fusion_inserts fusion fusion_site_inserts'><td colspan=2>"+fusion_protein_dropdown + "</td></tr>";
    // other_inserts_dropdown += `<select id="insert_type_where"  class="form-control">
    //               <option value="" >Please select Type</option>
    //               <option value="nterm">N-term</option>
    //               <option value="fusion">Fusion-Site</option>
    //               <option value="cterm">C-term</option>
    //             </select>`;
    // other_inserts_dropdown += "<table>";
    var segment_pretty = ['N-term','FusionSite','C-term']
     $.each(['nterm','fusionsite','cterm'], function(key,segment) {
    other_inserts_dropdown += "<tr class='fusion_inserts "+segment+" "+segment+"_site_inserts'><th width=75>"+segment_pretty[key] + "</th><td>";

    if (segment!='cterm') {
        other_inserts_dropdown += `<select id="`+segment+`_insert_type" name="protein_type" class='form-control'>
                  <option value="" >Please select Type</option>
                  <option value="`+segment+`_signal">Signal Peptide</option>
                  <option value="`+segment+`_tag">Tag</option>
                  <option value="`+segment+`_linker">Linker sequence</option>
                  <option value="`+segment+`_prot_cleavage">Proteolytic Cleavage site</option>
                </select>`;
    } else {
        other_inserts_dropdown += `<select id="`+segment+`_insert_type" name="protein_type" class='form-control'>
                  <option value="" >Please select Type</option>
                  <option value="`+segment+`_tag">Tag</option>
                  <option value="`+segment+`_linker">Linker sequence</option>
                  <option value="`+segment+`_prot_cleavage">Proteolytic Cleavage site</option>
                </select>`;

    }

    other_inserts_dropdown += `<select class="`+segment+`_insert_type form-control" id="`+segment+`_signal" name="signal">
                  <option value="">Please Select</option>
                  <option value="hemagglutinin">hemagglutinin</option>
                  <option value="other">Other</option>
                </select>`;


    other_inserts_dropdown += `<select class="`+segment+`_insert_type form-control" id="`+segment+`_tag" name="tag">
                  <option value="">Please Select</option>
                  <optgroup label="Affinity tags">
                  <option value="FLAG">FLAG</option>
                  <option value="FLAG_ala">FLAG alternative (ALA instead of C-terminal LYS)</option>
                  <option value="His(10)">His(10)</option>
                  <option value="His(8)">His(8)</option>
                  <option value="His(6)">His(6)</option>
                  <option value="GST">GST</option>
                  <option value="MBP (Maltose Binding protein)">MBP (Maltose Binding protein)</option>
                  <option value="T7">T7</option>
                  <option value="TrxA">TrxA</option>
                  <option value="1D4">1D4</option>
                  <option value="Rho9">Rho9</option>
                  <option value="HA tag">HA tag</option>
                  <option value="Streptavidin tag">Streptavidin tag</option>
                  <option value="Myc tag">Myc tag</option>
                  <option value="other">Other</option>
                  <optgroup label="Coupling tags">
                  <option value="SNAP">SNAP</option>
                  <option value="Halo tag">Halo tag</option>
                  <option value="other">Other</option>
                  <optgroup label="Fluoresence/Labeling tags">
                  <option value="dsRED">dsRED</option>
                  <option value="GFP">GFP</option>
                  <option value="CFP">CPF</option>
                  <option value="YFP">YFP</option>
                  <option value="Luciferase">Luficerase</option>
                  <option value="SNAP tag">SNAP tag</option>
                  <option value="Flash tag">Flash tag</option>
                  <option value="other">Other</option>
                </select>`;
       other_inserts_dropdown += `<select class="`+segment+`_insert_type form-control" id="`+segment+`_prot_cleavage" name="prot_cleavage">
                  <option value="">Please Select</option>
                  <option value="Thrombin">Thrombin</option>
                  <option value="TEV protease">TEV protease</option>
                  <option value="HRV 3C protease (PreScission protease)">HRV 3C protease (PreScission protease)</option>
                  <option value="Carboxypeptidase A">Carboxypeptidase A</option>
                  <option value="V8 protease (endoproteinase GluC from Staph8)">V8 protease (endoproteinase GluC from Staph8)</option>
                  <option value="other">Other</option>
                </select>`;

      other_inserts_dropdown += `<input class="`+segment+`_insert_type insert_text form-control" maxlength="50" id="`+segment+`_linker" placeholder="Please input sequence" type="text" />`;
      other_inserts_dropdown += `<input class="`+segment+`_insert_type insert_text form-control" maxlength="50" id="`+segment+`_insert_other" placeholder="" type="text" />`;
      other_inserts_dropdown += `<input class="btn btn-info `+segment+`_insert_type" id="`+segment+`_insert_submit" placeholder="" value="Add" type="button" /></td></tr>`;
      });
      other_inserts_dropdown += "</table><div id=inserts_table></div>"

      //"
    tables["other_inserts"] = other_inserts_dropdown;

    function stopPropagation(evt) {
      if (evt.stopPropagation !== undefined) {
        evt.stopPropagation();
      } else {
        evt.cancelBubble = true;
      }
    }

    function updateLoadStatus() {

      $('#loadstatus').html("Please wait while data is loaded. "+Math.round(load_status*100/7)+"% done");
      if (load_status != 5) {
        $('#method_options').hide();
      } else {
        $('#method_options').show();
        $('#loadstatus').hide();
      }
    }

    function showModal(heading,content, datatable){

      if (edit_mode_on) {

      }

      $("#myModalLabel").html(heading);
      $("#ModalBody").html(content);
      $("#myModal").modal("show");
      $(".modal-footer").show();
      build_tooltips();
      if (typeof(datatable)!=='undefined'){
        default_sort["order"] = [];
        var db_table = $(datatable).DataTable({scrollY:'50vh',
                                                scrollCollapse: true,
                                                paging:         false,
                                                "info":     false,
                                                "order": []
                                                });
      }

        var title = $('#fusion_search').text();
        $('#fusion_search').html( '<input type="text" onclick="stopPropagation(event);" placeholder="Search '+title+'" />' );

        // Apply the filter
        $("#fusion_search input").on( 'keyup change', function () {
            db_table.column( $('#fusion_search').index()+':visible' )
                    .search( this.value )
                    .draw();
        } );
        if (datatable == '#mutations') {
          yadcf.init(db_table,
                    [
                        {
                            column_number : 0,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "State",
                            filter_reset_button_text: false,
                            filter_match_mode : "exact",
                        }
                    ],
                    {
                        cumulative_filtering: false
                    }
                );

          yadcf.exResetAllFilters(db_table);
          $("tr.glyco").hide();
          $("tr.palmi").hide();

      }
    }

    function has_changes() {
      if (modifications.length>0) return true;
      if (manual_constructs.length>0) return true;
      if (manual_inserts.length>0) return true;

      if (inserts['fusion'].length>0) return true;
      if (inserts['cterm'].length>0) return true;
      if (inserts['nterm'].length>0) return true;

      return false;

    }

    function resetAll() {
      modifications = new Array;
      manual_constructs = new Array;
      manual_inserts = new Array;
      inserts = new Array;
      inserts['fusion'] = [];
      inserts['cterm'] = [];
      inserts['nterm'] = [];
      resetModifications();
      if (edit_mode_on) {
            build_edit_table();
      }
      modifications_overview();
    }

    function build_tooltips() {
      $('[data-toggle="tooltip"]').tooltip();
      $('.prio_info').tooltip('destroy');
      $('.prio_info').tooltip({
          container: 'body',
          template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner large"></div></div>'
      });
      $('.methods_info').tooltip('destroy');
      $('.methods_info').tooltip({
          template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner medium"></div></div>'
      });
    }

    function resetModifications() {

      $('#snakeplot').find("circle").each(function( index ){
            //console.log( index + ": " + $( this ).text() );
            aa =  $(this).next().text();
            //console.log( index + ": " + aa );
            $(this).css("fill", 'white');
            $(this).next().css("fill", 'black');
          });

    }

    function automatic_helper() {
      $(".modal-footer").hide();
      $( ".combitable select" ).change(function() {
        var n_terms = Math.max($("#combi_nterm").val(),1);
        var icl_start = Math.max($("#combi_icl_start").val(),1);
        var icl_end = Math.max($("#combi_icl_end").val(),1);
        var c_terms = Math.max($("#combi_cterm").val(),1);
        combinations = n_terms*icl_start*c_terms*icl_end;

        $("#combi_summary").html(combinations+" construct");
        if (combinations>1) $("#combi_summary").html(combinations+" constructs");
      });
        $("#combi_summary").html("0 construct");
    }

    function inserts_helper(position_insert) {

      if (typeof(position_insert)!=='undefined'){
        current_position_insert = position_insert;
        $(".fusion_inserts").hide();
        $(".fusion_inserts."+current_position_insert).show();
      } else {
        // allow all
        current_position_insert = false;
        $(".fusion_inserts").show();
      }

      fusionpos = $('input:radio[name=fusionpos]:checked').val();

      if (fusionpos == 'nterm') {
            fusionpos_pretty = "N-term";
      } else {
          fusionpos_pretty = fusionpos.toUpperCase();
      }
      $("#fusion_text").html("Select the Fusion Protein to add in "+fusionpos_pretty);

      if (fusionpos == 'None') {
        // console.log("REMOVE FUSION OPTIONS");
        $(".fusion_site_inserts").hide();
      }

      $("#insert_type").hide();
      $( "#insert_type_where" )
        .change(function () {
          insert_location = $( "#insert_type_where option:selected" ).val();
          if (insert_location) {
            $("#insert_type").val($("#insert_type option:first").val());
            $(".insert_type").hide();
            $("#insert_type").show();

          } else {
            $("#insert_type").hide();
            $(".insert_type").hide();
          }
        });

      $(".insert_type").hide();
      $(".nterm_insert_type").hide();
      $(".fusion_insert_type").hide();
      $(".cterm_insert_type").hide();
      $( "#nterm_insert_type" ).add('#fusion_insert_type').add('#cterm_insert_type')
        .change(function () {
          this_class = "."+$(this).attr("id");
          this_id = "#"+$(this).attr("id");
          this_segment = $(this).attr("id").split("_")[0]

          // console.log(this_segment);
          $("."+this_segment+"_insert_type").hide();

          insert_type = $( this_id+" option:selected" ).val();

          insert_type_specific = insert_type.split("_")[1];

          $("#"+insert_type).show();
          $("#"+insert_type).val($("#"+insert_type+" option:first").val());
          $("#"+this_segment+"_insert_other").val("");
          //Bind to check for other
          if (insert_type_specific=='linker') {
            // return if linker, as there is not supposed to be change event
            return
          }
          // console.log("#"+insert_type);
          $("#"+insert_type).change(function () {
            // console.log("changed #"+insert_type);
            // console.log("changed #"+$(this).attr("id"));
            changed_id = $(this).attr("id");
            this_segment = $(this).attr("id").split("_")[0]
            $("#"+this_segment+"_insert_other").hide();
            sub_insert_type = $( "#"+changed_id+" option:selected" ).val();
            // console.log("changed to "+sub_insert_type)
            if (sub_insert_type=='other'){
                $("#"+this_segment+"_insert_submit").hide();
                $("#"+this_segment+"_insert_other").show();
                // console.log("show " +"#"+this_segment+"insert_other");
            } else if (sub_insert_type) {
                $("#"+this_segment+"_insert_submit").show();
                // console.log("show submit for " +"#"+this_segment+"_insert_submit");
            } else {
                $("#"+this_segment+"_insert_submit").hide();
            }
          })
        })
        $( ".insert_text" ).keyup(function() {
          entered_text = $(this).val()
          this_segment = $(this).attr("id").split("_")[0]
          if (entered_text){ //if not empty in other or other text f ield
                $("#"+this_segment+"_insert_submit").show();
          } else {
                $("#"+this_segment+"_insert_submit").hide();
          }
        });
        $("#nterm_insert_submit").add('#fusion_insert_submit').add('#cterm_insert_submit')
          .click(function() {
            // console.log("PRESSED");
            this_segment = $(this).attr("id").split("_")[0]
            insert_location = this_segment;
            insert_type = $( "#"+this_segment+"_insert_type option:selected" ).val();
            insert_type_specific = insert_type.split("_")[1]
            if (insert_type_specific!="linker") {
              insert_sub_type = $( "#"+insert_type+" option:selected" ).val();
              if (insert_sub_type=='other') {
                insert_sub_type = $("#"+this_segment+"_insert_other").val()
              }
            } else {
              insert_sub_type = $("#"+this_segment+"_linker").val()
            }
            insert_type = insert_type.replace(this_segment+"_","");
            add_other_fusion(insert_location,insert_type,insert_sub_type);

        })
    }

  function getSortedKeys(obj) {
      var keys = []; for(var key in obj) keys.push(key);
      return keys.sort(function(a,b){return obj[b]['hits']-obj[a]['hits']});
  }

  function getSortedKeysPrio(obj) {
      var keys = []; for(var key in obj) keys.push(key);
      return keys.sort(function(a,b){
          // return obj[b]['priority']-obj[a]['priority']

          if (obj[a]['priority'] > obj[b]['priority']) return 1;
          if (obj[a]['priority'] < obj[b]['priority']) return -1;

          if (obj[a]['hits'] < obj[b]['hits']) return 1;
          if (obj[a]['hits'] > obj[b]['hits']) return -1;
        }
        );
  }
  function exportCSVsuggestions(){

    postData = JSON.stringify(export_list);
    $.ajax({
      type:    "POST",
      url:     "/common/exportexcelsuggestions",
      data:    {"d":postData},
      success: function(data) {
            $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
      },
      // vvv---- This is the new bit
      error:   function(jqXHR, textStatus, errorThrown) {
            alert("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown
            );
            console.log("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown);
      }
    });
  }

  function exportToExcel(){
    if (!edit_mode_on) {
      console.log('export auto!');
      postData = JSON.stringify(modifications);
      $.ajax({
        type:    "POST",
        url:     "/common/exportexcelmodifications",
        data:    {"d":postData, "s":JSON.stringify(export_list['sequences'])},
        success: function(data) {
              $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
        },
        // vvv---- This is the new bit
        error:   function(jqXHR, textStatus, errorThrown) {
              alert("Error, status = " + textStatus + ", " +
                    "error thrown: " + errorThrown
              );
              console.log("Error, status = " + textStatus + ", " +
                    "error thrown: " + errorThrown);
        }
      });

    } else {
      console.log('export manual!');
      postData = JSON.stringify(manual_constructs);
      $.ajax({
        type:    "POST",
        url:     "/common/exportexcelmodifications",
        data:    {"m":postData, "s":JSON.stringify(export_list['sequences'])},
        success: function(data) {
              $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
        },
        // vvv---- This is the new bit
        error:   function(jqXHR, textStatus, errorThrown) {
              alert("Error, status = " + textStatus + ", " +
                    "error thrown: " + errorThrown
              );
              console.log("Error, status = " + textStatus + ", " +
                    "error thrown: " + errorThrown);
        }
      });
    }
  }

  function fullscreensvg() {

    if ($( "#snakeplot_div" ).hasClass( "fadeMe" )) {
        $("#snakeplot_div").removeClass("fadeMe");
        $("#fullscreenbutton").addClass("btn-xs");
        $("#close").hide();
        fix_snake_plot();
        $("#snakeplot_div").height('300px');
    } else {
        $("#snakeplot_div").height('');
        $("#snakeplot").height("100%")
        $("#snakeplot_div").addClass("fadeMe");
        $("#fullscreenbutton").removeClass("btn-xs");
        $("#close").show();
    }

  }

  $(document).keyup(function(e) {
     if (e.keyCode == 27) { // escape key maps to keycode `27`
      if ($( "#snakeplot_div" ).hasClass( "fadeMe" )) {
        $("#snakeplot_div").removeClass("fadeMe");
        $("#close").hide();
        fix_snake_plot();
      }
    }
});

  function getSortedKeys_advanced(obj) {

    var keys = []; for(var key in obj) keys.push(key);
    return keys.sort(function(a,b){
      if (obj[a]['levels_num'][0] < obj[b]['levels_num'][0]) return 1;
      if (obj[a]['levels_num'][0] > obj[b]['levels_num'][0]) return -1;

      if (obj[a]['levels_num'][1] < obj[b]['levels_num'][1]) return 1;
      if (obj[a]['levels_num'][1] > obj[b]['levels_num'][1]) return -1;

      if (obj[a]['levels_num'][2] < obj[b]['levels_num'][2]) return 1;
      if (obj[a]['levels_num'][2] > obj[b]['levels_num'][2]) return -1;

      if (obj[a]['levels_num'][3] < obj[b]['levels_num'][3]) return 1;
      if (obj[a]['levels_num'][3] > obj[b]['levels_num'][3]) return -1;
      return 0;
    });
  }

    function build_nterm_menu() {
      // console.log('"DOING NTERM');
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_nterm = {};
      show_table = {};
      level_num = 0
      $.each(n_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3] || 1==1) { // ignore state
              if (fusionpos==vals[4] || (fusionpos=='None' && vals[4]!='nterm') || (fusionpos!='nterm' && vals[4]=='None') ) { //|| 1==1 include NOT all data regardless of fusion
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;

                  if (vals[5] in show_table[vals[2]]['fusion_proteins_counts'] && vals[4]=='nterm' && vals[5]!=''){
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] += 1;
                  } else if (vals[3]=='nterm' && vals[5]!='') {
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] = 1;
                  }

                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }

                if(show_table[vals[2]]['fusion_proteins'].indexOf(vals[5])==-1 && vals[4]=='nterm' && vals[5]!='') {
                  show_table[vals[2]]['fusion_proteins'].push(vals[5]);
                }

                if ( !(vals[5] in show_table[vals[2]]['fusion_proteins_counts']) && vals[4]=='nterm' && vals[5]!=''){
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] = 1;
                }

              }
            }
          })
        })
        level_num += 1;
      })


      combi_options = "<select id=combi_nterm class='form-control'>";
      c = 0;
      $.each(getSortedKeys_advanced(show_table), function(i, val) {
          c += 1;
          combi_options += "<option>"+c+"</option>";
      });
      combi_options += "</select>";

      // console.log('check existing nterm!');
      var existing_nterms = [];
      $.each(modifications, function(key,val) {
        if (val['method']=='n-term') existing_nterms.push(parseInt(val['extra']));
      });

      $.each(custom_additions['nterm'], function(i,val) {
        console.log("CUSTOM",val);
        level = "Custom";
        level_num = 0;
          if(!show_table[val]) { show_table[val] = {'gn': val, 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

          if(show_table[val]['levels'].indexOf(level)==-1) {
            show_table[val]['levels'].push(level);
          }

          show_table[val]['levels_num'][level_num] += 1000;
      });
      // console.log(existing_nterms);
      export_list['nterm'] = [];

      signal_p_text = ''
      if (signal_p) {
          signal_p_text =  "<hr><p align=center><a href='http://www.cbs.dtu.dk/services/SignalP/'>Signal P</a> suggestion: Remove the signal peptide signal around 1-{{signal_p}} <input type='hidden' id='custom_nterm_pos_signal' placeholder='Position' value={{signal_p}}><input type=button value='Truncate' onclick='custom_nterm(\"SignalP\")'></p><hr>";
      }
      var items_table = [];
      add_top = "<div> Custom: <input type='text' id='custom_nterm' placeholder='From Helix 1'> or <input type='text' id='custom_nterm_pos' placeholder='Position'><input type=button value=Add onclick='custom_nterm()'>" + '<p class="pull-right">Add top'+combi_options+" suggestions<input type=button value=Add onclick='auto_nterm()'></p></div>";
      items_table.push( "");
      if (fusionpos=='nterm') {
        items_table.push(info_text['nterm'],signal_p_text,add_top,"<table id=nterm_sug class='table-striped table table-bordered'><thead><tr><th>From Helix 1</th><th>AA</th><th>Freq</th><th>From same</th><th id=fusion_search>Fusion proteins</th><th>Add</th></tr></thead><tbody>");
      } else {
        items_table.push(info_text['nterm'],signal_p_text,add_top,"<table id=nterm_sug class='table-striped table table-bordered'><thead><tr><th>From Helix 1</th><th>AA</th><th>Freq</th><th>From same</th><th>Add</th></tr></thead><tbody>");
      }
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        seq_pos = {{residues.TM1.0.sequence_number}}-(pos);
        if (!(seq_pos in residues_pos)) {
          seq_pos = "N/A";
          aa = "";
        } else {
          aa = residues_pos[seq_pos][0];
        }
        selected_row = "";
        if ($.inArray( parseInt(pos), existing_nterms )!==-1 ) selected_row = "checked";
        fusion_cols = "";
        if (fusionpos=='nterm') fusion_cols = "<td>"+t_fusion+"</td>";

        temp = "<tr val='"+pos+"'><td>"+pos+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td>"+fusion_cols+"<td><input type=checkbox id='nterm_sug_"+pos+"'  onclick='nterm_tm1(this)' from='"+val['pdbs']+"' value='"+pos+"' "+selected_row+"></tr>";
        items_table.push( temp );
        export_list['nterm'].push([pos,val['hits'],val['levels'],val['fusion_proteins'],val['pdbs']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['nterm'] = result;
      // $("#nterm_button").html("N-term ("+Object.keys(show_table).length+")");
      // $("#ModalBody").html(result);
    }

    function nterm_helper() {
      build_nterm_menu();
    }

    function build_cterm_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_cterm = {};
      show_table = {};
      level_num = 0
      $.each(c_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3] || 1==1) {
                find = 1;
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                if(!show_cterm[level]) { show_cterm[level] = {}; }
                if(!show_cterm[level][vals[2]]) { show_cterm[level][vals[2]] = {'proteins': [],'pdbs': [], 'hits':0}; }
                if(show_cterm[level][vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_cterm[level][vals[2]]['proteins'].push(protein);
                  show_cterm[level][vals[2]]['pdbs'].push(pdb);
                  show_cterm[level][vals[2]]['hits'] += 1;
                }

                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;
                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }
            }
          })
        })
        if (find==1 ){
          show_cterm[level]['sortedkeys'] = getSortedKeys(show_cterm[level]);
        }
        level_num += 1;
      })

      console.log("show_table",show_table);
      console.log("custom_additions",custom_additions['cterm']);
      $.each(custom_additions['cterm'], function(i,val) {
        console.log("CUSTOM",val);
        level = "Custom";
        level_num = 0;
          if(!show_table[val[0]]) { show_table[val[0]] = {'gn': val[0], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

          if(show_table[val[0]]['levels'].indexOf(level)==-1) {
            show_table[val[0]]['levels'].push(level);
          }

          show_table[val[0]]['levels_num'][level_num] += 1000;
      });

      combi_options = "<select id=combi_cterm class='form-control'>";
      c = 0;
      $.each(getSortedKeys_advanced(show_table), function(i, val) {
          c += 1;
          combi_options += "<option>"+c+"</option>";
      });
      combi_options += "</select>";

      var existing_cterms = [];
      $.each(modifications, function(key,val) {
        if (val['method']=='c-term') existing_cterms.push(parseInt(val['extra']));
      });
      // console.log('existing_cterms',existing_cterms);
      export_list['cterm'] = [];
      var items_table = [info_text['cterm']];
      add_top = "<div> Custom: <input type='text' id='custom_cterm' placeholder='From Helix 8'> or <input type='text' id='custom_cterm_pos' placeholder='Position'><input type=button value=Add onclick='custom_cterm()'>" + '<p class="pull-right">Add top'+combi_options+" suggestions<input type=button value=Add onclick='auto_cterm()'></p></div>";

      items_table.push( add_top);
      items_table.push("<table id=cterm_sug class='table-striped table table-bordered'><thead><tr><th>From Helix8 End</th><th>AA</th><th>Freq</th><th>From same</th><th>Add</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        seq_pos = {{residues.Cterm.0.sequence_number}}+parseInt(pos)-1;
        if (!(seq_pos in residues_pos)) {
          seq_pos = "N/A";
          aa = "";
        } else {
          aa = residues_pos[seq_pos][0];
        }
        selected_row = "";
        if ($.inArray( parseInt(pos), existing_cterms )!==-1 ) selected_row = "checked";
        temp = "<tr><td>"+(pos)+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td><input type=checkbox id='cterm_sug_"+pos+"'  onclick='cterm(this)' from='"+val['pdbs']+"' value='"+pos+"' "+selected_row+"></tr>";
        items_table.push( temp );
        export_list['cterm'].push([pos,val['hits'],val['levels'],val['pdbs']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['cterm'] = result;
      // $("#cterm_button").html("C-term ("+Object.keys(show_table).length+")");

    }

    function build_icl3_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_icl3 = {};
      show_table = {};
      show_table_start = {};
      show_table_end = {};
      level_num = 0
      $.each(icl3_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[2] || 1==1) {
              if (fusionpos==vals[3] || (fusionpos=='None' && vals[3]!='icl3') || (fusionpos!='icl3' && vals[3]=='None')) {
                find = 1;

                // 5x50    5.50 A
                // 6x50    6.50 A

                // 5x50    3.54 F
                // 6x50    4.50 F

                {% if class == 'A' %}
                  gn_550 = 50;
                  gn_650 = 50;
                {% elif class == 'F' %}
                  gn_550 = 54;
                  gn_650 = 49;
                {% endif %}


                range = "5."+(gn_550+vals[0])+"-"+"6."+(gn_650-vals[1]);
                range_start = "5."+(gn_550+vals[0]);
                range_end = "6."+(gn_650-vals[1]);

                // TABLE
                if(!show_table_start[range_start]) { show_table_start[range_start] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_start[range_start]['proteins'].indexOf(protein)==-1) {
                  show_table_start[range_start]['proteins'].push(protein);
                  show_table_start[range_start]['pdbs'].push(pdb);
                  show_table_start[range_start]['hits'] += 1;
                  show_table_start[range_start]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_start[range_start]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                  }

                }

                if(show_table_start[range_start]['levels'].indexOf(level)==-1) {
                  show_table_start[range_start]['levels'].push(level);
                }

                if(show_table_start[range_start]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_start[range_start]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_start[range_start]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                }

                // TABLE
                if(!show_table_end[range_end]) { show_table_end[range_end] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_end[range_end]['proteins'].indexOf(protein)==-1) {
                  show_table_end[range_end]['proteins'].push(protein);
                  show_table_end[range_end]['pdbs'].push(pdb);
                  show_table_end[range_end]['hits'] += 1;
                  show_table_end[range_end]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_end[range_end]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                  }

                }

                if(show_table_end[range_end]['levels'].indexOf(level)==-1) {
                  show_table_end[range_end]['levels'].push(level);
                }

                if(show_table_end[range_end]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_end[range_end]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_end[range_end]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                }


              }
            }
          })
        })
        level_num += 1;
      })

      var existing_icl_start = [];
      $.each(modifications, function(key,val) {
        if (val['method']=='ICL3_start') existing_icl_start.push(parseInt(val['extra']));
      });
      var existing_icl_end = [];
      $.each(modifications, function(key,val) {
        if (val['method']=='ICL3_end') existing_icl_end.push(parseInt(val['extra']));
      });


      combi_options = "<select id=combi_icl_start class='form-control'>";
      c = 0;
      $.each(getSortedKeys_advanced(show_table_start), function(i, val) {
          c += 1;
          combi_options += "<option>"+c+"</option>";
      });
      combi_options += "</select>";

      combi_options2 = "<select id=combi_icl_end class='form-control'>";
      c = 0;
      $.each(getSortedKeys_advanced(show_table_end), function(i, val) {
          c += 1;
          combi_options2 += "<option>"+c+"</option>";
      });
      combi_options2 += "</select>";

      export_list['icl3_start'] = [];
      export_list['icl3_end'] = [];
       var items_table = [info_text['icl3_start']];
      items_table.push("<div>Custom: 5.<input type='text' id='custom_icl' placeholder='Generic number'><input type=button value=Add onclick='custom_icl(3)'><p class='pull-right'>Add top"+combi_options+" suggestions<input type=button value=Add onclick='auto_icl_start()'></p></div>");
      items_table.push("<table id=icl3_sug_start class='table-striped table table-bordered'><thead><tr><th>"+generic_label+"</th><th>AA</th><th>Freq</th><th>From same</th><th id=fusion_search>Fusion</th><th>Add</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_start), function( i, pos ) {
        val = show_table_start[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        seq_pos = {{residues_gn.5x50.sequence_number}}-(-val['start']);
        aa = residues_pos[seq_pos][0];
        selected_row = "";
        if ($.inArray( parseInt(val['start']), existing_icl_start )!==-1 ) selected_row = "checked";
        temp = "<tr><td>"+pos+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td>"+t_fusion+"</td><td><input type=checkbox onclick='icl3_start(this)' from='"+val['pdbs']+"' tm5='"+val['start']+"'  tm6='"+val['end']+"' from='' "+selected_row+"></tr>";
        items_table.push( temp );
        export_list['icl3_start'].push([pos,val['hits'],val['levels'],val['pdbs'],val['start']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl3_start'] = result;
      var items_table = [info_text['icl3_end']];
      items_table.push("<div>Custom: 6.<input type='text' id='custom_icl_end' placeholder='Generic number'><input type=button value=Add onclick='custom_icl_end(3)'><p class='pull-right'>Add top"+combi_options2+" suggestions<input type=button value=Add onclick='auto_icl_end()'></p></div>");
      items_table.push( "<div id=icl3_start_info></div><table id=icl3_sug_end class='table-striped table table-bordered'><thead><tr><th>"+generic_label+"</th><th>AA</th><th>Freq</th><th>From same</th><th id=fusion_search>Fusion</th><th>Add</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_end), function( i, pos ) {
        val = show_table_end[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        seq_pos = {{residues_gn.6x50.sequence_number}}-(val['end']);
        aa = residues_pos[seq_pos][0];
        selected_row = "";
        if ($.inArray( parseInt(val['end']), existing_icl_end )!==-1 ) selected_row = "checked";
        temp = "<tr><td>"+pos+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><input type=checkbox onclick='icl3(this)' from='"+val['pdbs']+"' tm5='"+val['start']+"'  tm6='"+val['end']+"' from='' "+selected_row+"></tr>";
        items_table.push( temp );
        export_list['icl3_end'].push([pos,val['hits'],val['levels'],val['pdbs'],val['end']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl3_end'] = result;

      {% if class == 'A' and residues.ICL3|length < 9 %}
      if (fusionpos!='icl3'){
        tables['icl3_start'] = "Loop is too short to require a truncation without a fusion protein";
        tables['icl3_end'] = "Loop is too short to require a truncation without a fusion protein";
        export_list['icl3_start'] = [];
        export_list['icl3_end'] = [];
      }
      {% endif %}

      // $("#icl3_start_button").html("ICL3 ("+Object.keys(show_table_start).length+")");
    }

    function build_icl2_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_icl2 = {};
      show_table_start = {};
      show_table_end = {};
      level_num = 0
      $.each(icl2_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[2] || 1==1) {
              if (fusionpos==vals[3] || (fusionpos=='None' && vals[3]!='icl3') || (fusionpos!='icl3' && vals[3]=='None')) { //use icl3 cos thats how it is
                find = 1;

                // 3x50    3.54 C
                // 4x50    4.40 C

                // 3x50    3.54 B
                // 4x50    4.50 B

                {% if class == 'B' %}
                  gn_350 = 54;
                  gn_450 = 50;
                {% elif class == 'C' %}
                  gn_350 = 54;
                  gn_450 = 40;
                {% endif %}





                range = "3."+(gn_350+vals[0])+"-"+"4."+(gn_450-vals[1]);

                range_start = "3."+(gn_350+vals[0]);
                range_end = "4."+(gn_450-vals[1]);

                // TABLE
                if(!show_table_start[range_start]) { show_table_start[range_start] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_start[range_start]['proteins'].indexOf(protein)==-1) {
                  show_table_start[range_start]['proteins'].push(protein);
                  show_table_start[range_start]['pdbs'].push(pdb);
                  show_table_start[range_start]['hits'] += 1;
                  show_table_start[range_start]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_start[range_start]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                  }
                }

                if(show_table_start[range_start]['levels'].indexOf(level)==-1) {
                  show_table_start[range_start]['levels'].push(level);
                }

                if(show_table_start[range_start]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_start[range_start]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_start[range_start]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                }

                // TABLE
                if(!show_table_end[range_end]) { show_table_end[range_end] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_end[range_end]['proteins'].indexOf(protein)==-1) {
                  show_table_end[range_end]['proteins'].push(protein);
                  show_table_end[range_end]['pdbs'].push(pdb);
                  show_table_end[range_end]['hits'] += 1;
                  show_table_end[range_end]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_end[range_end]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                  }
                }

                if(show_table_end[range_end]['levels'].indexOf(level)==-1) {
                  show_table_end[range_end]['levels'].push(level);
                }
                if(show_table_end[range_end]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_end[range_end]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_end[range_end]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                }

              }
            }
          })
        })
        level_num += 1;
      })


      combi_options = "<select id=combi_icl_start class='form-control'>";
      c = 0;
      $.each(getSortedKeys_advanced(show_table_start), function(i, val) {
          c += 1;
          combi_options += "<option>"+c+"</option>";
      });
      combi_options += "</select>";


      combi_options2 = "<select id=combi_icl_end class='form-control'>";
      c = 0;
      $.each(getSortedKeys_advanced(show_table_end), function(i, val) {
          c += 1;
          combi_options2 += "<option>"+c+"</option>";
      });
      combi_options2 += "</select>";



      var existing_icl_start = [];
      $.each(modifications, function(key,val) {
        if (val['method']=='ICL2_start') existing_icl_start.push(parseInt(val['extra']));
      });
      var existing_icl_end = [];
      $.each(modifications, function(key,val) {
        if (val['method']=='ICL2_end') existing_icl_end.push(parseInt(val['extra']));
      });

      export_list['icl2_start'] = [];
      export_list['icl2_end'] = [];
       var items_table = [info_text['icl2_start']];

      items_table.push("<div>Custom: 3.<input type='text' id='custom_icl' placeholder='Generic number'><input type=button value=Add onclick='custom_icl(2)'><p class='pull-right'>Add top"+combi_options+" suggestions<input type=button value=Add onclick='auto_icl_start()'></p></div>");

      items_table.push("<table id=icl2_sug_start class='table-striped table table-bordered'><thead><tr><th>"+generic_label+"</th><th>AA</th><th>Freq</th><th>From same</th><th>Fusion proteins</th><th>Add</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_start), function( i, pos ) {
        val = show_table_start[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        seq_pos = {{residues_gn.3x50.sequence_number}}-(-val['start']);
        aa = residues_pos[seq_pos][0];

        selected_row = "";
        if ($.inArray( parseInt(val['start']), existing_icl_start )!==-1 ) selected_row = "checked";
        // temp = "<tr><td>"+pos+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl2_start(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from=''>Apply</a></tr>";
        temp = "<tr><td>"+pos+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td>"+t_fusion+"</td><td><input type=checkbox onclick='icl2_start(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from='' "+selected_row+"></tr>";
        items_table.push( temp );
        export_list['icl2_start'].push([pos,val['hits'],val['levels'],val['pdbs'],val['start']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl2_start'] = result;

       var items_table = [info_text['icl2_end']];
      items_table.push("<div>Custom: 4.<input type='text' id='custom_icl_end' placeholder='Generic number'><input type=button value=Add onclick='custom_icl_end(2)'><p class='pull-right'>Add top"+combi_options2+" suggestions<input type=button value=Add onclick='auto_icl_end()'></p></div>");
      items_table.push("<div id=icl2_start_info></div><table  id=icl2_sug_end class='table-striped table table-bordered'><thead><tr><th>"+generic_label+"</th><th>AA</th><th>Freq</th><th>From same</th><th>Fusion proteins</th><th>Add</th></tr></thead><tbody>");
      $.each( getSortedKeys_advanced(show_table_end), function( i, pos ) {
        val = show_table_end[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        seq_pos = {{residues_gn.4x50.sequence_number}}-(val['end']);
        aa = residues_pos[seq_pos][0];
        selected_row = "";
        if ($.inArray( parseInt(val['end']), existing_icl_end )!==-1 ) selected_row = "checked";
        // temp = "<tr><td>"+pos+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl2(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from=''>Apply</a></tr>";
        temp = "<tr><td>"+pos+"</td><td>" + aa + "" + seq_pos +"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><input type=checkbox onclick='icl2(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from='' "+selected_row+"></tr>";
        items_table.push( temp );
        export_list['icl2_end'].push([pos,val['hits'],val['levels'],val['pdbs'],val['end']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl2_end'] = result;
      // $("#icl2_start_button").html("ICL2 ("+Object.keys(show_table_start).length+")");
    }

    function build_mutations() {
      // console.log(mutations_browser);
      // console.log(mutations_browser.length);

      // var state = $('input:radio[name=state]:checked').val();
      // var keys = Object.keys(mutations_browser);
      // export_list['thermo'] = [];
      // mutations_mode_suggestions = [];
      // muts = {}
      // $.each(keys, function( i,type ) {
      //   if (type.substring(0, 11) == "struc_rules" && type.substring(12)!=state) {
      //     return true; //loop away from these
      //   }
      //   $.each(mutations_browser[type], function(gn, values){
      //     console.log(type,values);
      //     full_mutation = gn + values[0] + values[2];
      //     if(!muts[full_mutation]) { muts[full_mutation] = {'priority': 99, 'gn': gn, 'types': [], 'pretty_types': [], 'hits':0, 'details':[]}; }

      //     muts[full_mutation]['hits'] += 1;

      //     muts[full_mutation]['details'].push(values);
      //     if (type.substring(0, 11) == "struc_rules") {
      //       if (muts[full_mutation]['priority']>5) muts[full_mutation]['priority'] = 5;
      //       pretty_type = 'State-stabilising'
      //     } else if (type == "termo_From target recepter") {
      //       if (muts[full_mutation]['priority']>1) muts[full_mutation]['priority'] = 1;
      //       pretty_type = 'From Receptor'
      //     } else if (type == "termo_Common mutation (Wt)") {
      //       if (muts[full_mutation]['priority']>2) muts[full_mutation]['priority'] = 2;
      //       pretty_type = 'Observed (multiple)'
      //     } else if (type == "termo_Common mutation (Mut)") {
      //       if (muts[full_mutation]['priority']>2) muts[full_mutation]['priority'] = 2;
      //       pretty_type = 'Observed (multiple)'
      //     } else if (type == "termo_Single common mutation (Wt)") {
      //       if (muts[full_mutation]['priority']>2) muts[full_mutation]['priority'] = 3;
      //       pretty_type = 'Observed (single)'
      //     } else if (type == "cons_rm_conserved_G") {
      //       if (muts[full_mutation]['priority']>4) muts[full_mutation]['priority'] = 4;
      //       pretty_type = 'Conservation (remove Gly)'
      //     } else if (type == "cons_rm_nonconserved_GP") {
      //       if (muts[full_mutation]['priority']>4) muts[full_mutation]['priority'] = 2;
      //       pretty_type = 'Conservation (remove Gly/Pro)'
      //     } else if (type == "cons_rf_and_class") {
      //       if (muts[full_mutation]['priority']>2) muts[full_mutation]['priority'] = 2;
      //       pretty_type = 'Conservation'
      //     } else if (type == "cons_rf") {
      //       if (muts[full_mutation]['priority']>2) muts[full_mutation]['priority'] = 2;
      //       pretty_type = 'Conservation'
      //     } else if (type == "cons_strucs") {
      //       if (muts[full_mutation]['priority']>2) muts[full_mutation]['priority'] = 2;
      //       pretty_type = 'Conservation'
      //     } else {
      //       console.log(type);
      //     }

      //     muts[full_mutation]['types'].push(type);
      //     muts[full_mutation]['pretty_types'].push(pretty_type);
      //   });
      // });
      // // console.log(muts);

      //     prio_info = '<p class=info_text>Thermostabilising mutations have 5 priority levels based on method: <ol><li>From structure of this target ({{target.entry_name}})</li><li>Introducing conserved residue or observed in >2 structures</li><li>Observed in 1 structure</li><li>Increase helix propensity (Remove Gly)</li><li>State-stabilising interactions (e.g. ionic lock or sodium ion site)</li></ol></p>';

      //   var items_table = [info_text['termo']];
      //   items_table.push("<table id='mut_sug' class='table-striped table table-bordered'><thead><tr><th>State</th><th>Prio <a class='prio_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+prio_info+"'><i class='glyphicon glyphicon-info-sign'></i></a></th><th>Pos</th><th>Mut</th><th>Methods <a class='prio_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+prio_info+"'><i class='glyphicon glyphicon-info-sign'></i></a></th></tr></thead><tbody>");
      // $.each( getSortedKeysPrio(muts), function( i, gn ) {
      //   vals = muts[gn];
      //   mut_suggestions = [];
      //   check = []
      //   label = []
      //   $.each(vals['details'], function(i, val) {
      //       // console.log(val);
      //       if (vals['types'][i].substring(0, 5) == "cons_") {
      //         label.push(val[0]+val[1]+val[2]);
      //         if ($.inArray(val[0]+val[1]+val[2], check)==-1) {
      //           mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' >"+val[0]+val[1]+val[2]+"</a>");
      //           check.push(val[0]+val[1]+val[2]);
      //         }
      //       } else if (vals['types'][i].substring(0, 5) == "termo") {
      //         $.each( val, function( key, value ) {
      //           if (vals['types'][i]=='termo_Common mutation (Wt)') {
      //             // console.log(key);
      //             // console.log(value);
      //             $.each(value['muts'], function(ii, mut_aa) {
      //               // console.log(mut_aa);
      //               label.push(value['wt'][0]+value['wt'][1]+mut_aa);
      //               if ($.inArray(value['wt'][0]+value['wt'][1]+mut_aa, check)==-1) {
      //                 mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+mut_aa+"'>"+value['wt'][0]+value['wt'][1]+mut_aa+"</a>");
      //                 check.push(value['wt'][0]+value['wt'][1]+mut_aa);
      //               }
      //              });
      //           } else if (vals['types'][i]=='termo_Single common mutation (Wt)') {
      //             // console.log(key);
      //             // console.log(value);
      //             $.each(value['muts'], function(ii, mut_aa) {
      //               // console.log(mut_aa);
      //               label.push(value['wt'][0]+value['wt'][1]+mut_aa);
      //               if ($.inArray(value['wt'][0]+value['wt'][1]+mut_aa, check)==-1) {
      //                 mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+mut_aa+"'>"+value['wt'][0]+value['wt'][1]+mut_aa+"</a>");
      //                 check.push(value['wt'][0]+value['wt'][1]+mut_aa);
      //               }
      //              });
      //           } else {
      //               // temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+to+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+to+"</strong></a></li>";

      //             label.push(value['wt'][0]+value['wt'][1]+key);
      //             if ($.inArray(value['wt'][0]+value['wt'][1]+key, check)==-1) {
      //               mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+key+"'>"+value['wt'][0]+value['wt'][1]+key+"</a>");
      //               check.push(value['wt'][0]+value['wt'][1]+key);
      //             }
      //           }
      //         });

      //       } else if (vals['types'][i].substring(0, 11) == "struc_rules") {
      //         vals['types'][i] += ":"+val[0]['definition'];
      //         $.each( val, function( key, value ) {
      //           label.push(value['wt']+value['pos']+value['mut']);
      //           if ($.inArray(value['wt']+value['pos']+value['mut'], check)==-1) {
      //             mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['pos']+"' gn='"+gn+"' wt='"+value['wt']+"' from='"+value['wt']+"' to='"+value['mut']+"' >"+value['wt']+value['pos']+value['mut']+"</a>");
      //             check.push(value['wt']+value['pos']+value['mut']);
      //           }
      //         });
      //       }
      //   });
      //   //<td>"+vals['hits']+"</td>
      //   temp = "<tr><td align=center>"+vals['priority']+"</td><td>"+gn+"</td><td origin='"+vals['types']+"'>"+mut_suggestions.join(", ")+"</td><td>"+vals['pretty_types']+" <a class='methods_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+vals['types'].join("<br>")+"'><i class='glyphicon glyphicon-info-sign'></i></a></td></tr>";
      //   items_table.push( temp );
      //   export_list['thermo'].push([gn,label.join(", "),vals['hits'],vals['types']]);
      //   mutations_mode_suggestions.push([gn,label,vals['types'],vals['priority']])
      // });
      // items_table.push( "</tbody></table>" );
      // result = items_table.join( "" );
      // tables['mutations'] = result;
      // $("#mutations_button").html("Thermostabilisation ("+Object.keys(muts).length+")");
    }

    function build_site_removals() {
      var keys = Object.keys(removals_list);
      removals = {}
      count = 0;
      var items_table = [info_text['sites'] + "<table  id='site_sug' class='table-striped table table-bordered'><thead><tr><th>Segment</th><th>Mutation</th><th>Type of removal</th></tr></thead><tbody>"];
      $.each(keys, function( i,type ) {
        $.each(removals_list[type], function(subtype, values){
          // console.log(type);
          // console.log(subtype);
          $.each(values, function(i, details) {
            // console.log(i);
            // console.log(details);
            count += 1;
            if (details[2]!="") { //single mutation
              suggestion = "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' to2='"+details[3]+"' wt2='"+details[4][1]+"'> Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3]+"</a>";
              label = "Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3];
            } else {
                suggestion =  "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' > Mutate "+details[4][0]+details[0]+details[1]+"</a>";
                label = "Mutate "+details[4][0]+details[0]+details[1];
            }
            temp = "<tr><td>"+details[5]+"</td><td>"+suggestion+"</td><td>"+type+" ("+subtype+")</td></tr>";
            items_table.push( temp );
            export_list['removals'].push([details[5],label,type,subtype]);
          });
        });
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['site_removals'] = result;
      // $("#removals_button").html("Site removals ("+count+")");
    }

    // ON CLICK FUNCTIONS

    function auto_generate() {
      console.log('reset!');
      var n_terms = $("#combi_nterm").val();
      var icl_start = $("#combi_icl_start").val();
      var icl_end = $("#combi_icl_end").val();
      var c_terms = $("#combi_cterm").val();

      //reset current
      resetAll();
      // console.log('nterms!');
      for(var i = 0; i < n_terms; i++) {
        // console.log(i,export_list['nterm'][i]);
        if (i>=export_list['nterm'].length) break;
        entry = export_list['nterm'][i];
        from = entry[4];
        n_val = entry[0];
        until = {{residues.TM1.0.sequence_number}}-n_val-1;
        range = new Array;
        for (var ii = 1; 1 > 0 ? ii <= until : ii > until; ii += 1) {
            range.push(ii);
        }
        modi = {method: "n-term", type: "deletion", from: from, range: range, info: n_val+" from TM1 start. Based on "+from.join(", "), fixed: 'no', extra: n_val};
        modifications.push(modi);
      }

      // console.log('¨cterms!');
      for(var i = 0; i < c_terms; i++) {
        // console.log(i,export_list['cterm'][i]);
        if (i>=export_list['cterm'].length) break;
        entry = export_list['cterm'][i];
        from = entry[3];
        n_val = entry[0];
        start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val);
        {% with residues.Cterm|last as last %}
         end =   {{ last.sequence_number }};
        {% endwith %}
        range = new Array;
        for (var ii = start; 1 > 0 ? ii <= end : ii > end; ii += 1) {
            range.push(ii);
        }
        modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Based on "+from.join(", "), fixed: 'no', extra: n_val};
        modifications.push(modi);
      }


      // console.log('ICL_start');

      {% if class == 'A' or class == 'F' %}
      ICL_name = "icl3";
      {% elif class == 'B' or class == 'C' %}
      ICL_name = "icl2";
      {% endif %}
      for(var i = 0; i < icl_start; i++) {
        // console.log(i,export_list[ICL_name+'_start'][i]);
        if (i>=export_list[ICL_name+'_start'].length) break;
        entry = export_list[ICL_name+'_start'][i];
        from = entry[3];
        {% if class == 'A' or class == 'F' %}
        icl3_del_start = {{residues_gn.5x50.sequence_number}}-(-entry[4])+1;
        modi = {method: "ICL3_start", type: "deletion", from: from, range: [icl3_del_start], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% elif class == 'B' or class == 'C' %}
        icl2_del_start = {{residues_gn.3x50.sequence_number}}-(-entry[4])+1;
        modi = {method: "ICL2_start", type: "deletion", from: from, range: [icl2_del_start], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% endif %}

        modifications.push(modi);
      }


      // console.log('ICL_end');

      {% if class == 'A' or class == 'F' %}
      ICL_name = "icl3";
      {% elif class == 'B' or class == 'C' %}
      ICL_name = "icl2";
      {% endif %}
      for(var i = 0; i < icl_end; i++) {
        // console.log(i,export_list[ICL_name+'_end'][i]);
        if (i>=export_list[ICL_name+'_end'].length) break;
        entry = export_list[ICL_name+'_end'][i];
        from = entry[3];
        {% if class == 'A' or class == 'F' %}
        end = {{residues_gn.6x50.sequence_number}}-entry[4]-1;
        modi = {method: "ICL3_end", type: "deletion", from: from, range: [end], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% elif class == 'B' or class == 'C' %}
        end = {{residues_gn.4x50.sequence_number}}-entry[4]-1;
        modi = {method: "ICL2_end", type: "deletion", from: from, range: [end], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% endif %}

        modifications.push(modi);
      }

      // finall overview
      modifications_overview();
    }


    $('input[type=radio][name=work_mode]').change(function() {
          // return false;
          var work_mode = $('input:radio[name=work_mode]:checked').val();
          if (work_mode=='combi_mode_button') {
            if (has_changes()) {
              $( "#dialogauto" ).dialog( "open");
            } else {
              combi_mode();
            }
          } else if (work_mode=='combi_mode_mut_button') {
            if (has_changes()) {
              $( "#dialogauto_mut" ).dialog( "open");
            } else {
              combi_mode_mut();
            }
          } else if (work_mode=='manual_mode_button') {
            edit_mode();
          }
    });

    function reset_work_mode_checked() {
    $(".work_mode").removeClass("active");
      if (edit_mode_on) {
        $("input[name=work_mode][value='manual_mode_button']").prop("checked",true);
         $("input[name=work_mode][value='manual_mode_button']").parent().addClass("active");
      } else if (combi_mode_mut_on) {
        $("input[name=work_mode][value='combi_mode_mut_button']").prop("checked",true);
         $("input[name=work_mode][value='combi_mode_mut_button']").parent().addClass("active");
      } else if (combi_mode_on) {
        $("input[name=work_mode][value='combi_mode_button']").prop("checked",true);
         $("input[name=work_mode][value='combi_mode_button']").parent().addClass("active");
      }
    }

    function combi_mode () {
      if (edit_mode_on) {
        $("#edit_mode").hide();
        $("#add_manual").hide();
        $("#manual_mode").hide();
        $("#possibilities").show();
        $("#combi_mode").show();
        $("#manual_mode_button").removeClass("active");
        manual_constructs = new Array;
        manual_inserts = new Array;
        edit_mode_on = false;
        resetAll();
      } else if (combi_mode_mut_on) {
        $("#combi_mode_mut_button").removeClass("active");
        combi_mode_mut_on = false;
        resetAll();

      }
      $(".mutation_scan_th").hide();
      $("#combi_mode").html("Truncation/fusion scan");
      combi_mode_on = true;
    }


    function combi_mode_mut () {
      if (edit_mode_on) {
        $("#edit_mode").hide();
        $("#add_manual").hide();
        $("#manual_mode").hide();
        $("#possibilities").show();
        $("#combi_mode").show();
        $("#manual_mode_button").removeClass("active");
        manual_constructs = new Array;
        manual_inserts = new Array;
        edit_mode_on = false;
        resetAll();
      } else if (combi_mode_on) {
        $("#combi_mode_button").removeClass("active");
        combi_mode_on = false;
        resetAll();

      }
      $(".mutation_scan_th").show();
      $("#combi_mode").html("Mutation scan");
      combi_mode_mut_on = true;
    }

    function edit_mode () {

      if (!edit_mode_on) {
        edit_mode_on = true;
        combi_mode_on = false;
        combi_mode_mut_on = false;

        // create constructs with own "modifications"
        $.each(possible, function(p_key,p_val) {
          // ensure it is a string
          if (String(p_val).indexOf(",")!= -1 ) {
            pos_val = p_val.split(",");
          } else {
            pos_val = Array(String(p_val));
          }
          c_modifications = [];
          $.each(modifications, function(m_key,m_val) {
            if ($.inArray(String(m_key), pos_val)==-1) {
              return true;
            }
            c_modifications.push(m_val);
          });
          c_inserts = new Array;
          $.each(['cterm','nterm','fusion'], function(c_key,c_val) {
            temp = []
            $.each(inserts[c_val], function(t_key,t_val) {
              temp.push(t_val);
            });
            c_inserts[c_val] = temp;
          });
          // console.log("c_inserts",c_inserts,inserts);
          manual_constructs.push(c_modifications)
          manual_inserts.push(c_inserts)

        });

        if (manual_inserts.length==0) add_manual_row();

        $("#possibilities").hide();
        $("#combi_mode").hide();
        $("#edit_mode").show();
        $("#add_manual").show();
        $("#manual_mode").show();
        $("#combi_mode_button").removeClass("active");
        $("#combi_mode_mut_button").removeClass("active");

        // change table (probably new table)
        build_edit_table();
      }
    }

    function add_manual_row() {
      manual_constructs.push([]);
      t_inserts = new Array;
      t_inserts['fusion'] = [];
      t_inserts['cterm'] = [];
      t_inserts['nterm'] = [];
      manual_inserts.push(t_inserts);
      build_edit_table();
    }
    function delete_manual_row(id) {
      manual_constructs.splice(id, 1);
      manual_inserts.splice(id, 1);
      build_edit_table();
    }

    function manual_selected(elem) {
      m_id = $(elem).closest('tr').attr("construct_id");
      modifications = manual_constructs[m_id];
      inserts = manual_inserts[m_id];
      changesnakeplot($(elem).closest('tr').find( ".snakechoice" ));
      $(elem).closest('tr').find( ".snakechoice" ).prop("checked", true);
    }


    function build_edit_table() {

      table_rows = [];
      export_list['sequences'] = [];
      $.each(manual_constructs, function(key,val) {
        // ensure it is a string
        modifications = val;
        inserts = manual_inserts[key];
        console.log(key,inserts);
        rebuild_insert_order();
        generate_sequence('','manual');
      });

      n_term_inserts_button =   `<button type="button" id="other_inserts_button" class="btn btn-primary btn-xs pull-right" onclick='manual_selected(this);showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("nterm");inserts_overview(true);'>+</button>`;


      n_term_fusion_button =   `<button type="button" id="other_inserts_button" class="btn btn-primary btn-xs pull-right" onclick='manual_selected(this);showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("fusion");inserts_overview(true);'>+</button>`;


      icl_fusion_button =   `<button type="button" id="other_inserts_button" class="btn btn-primary btn-xs pull-right" onclick='manual_selected(this);showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("fusion");inserts_overview(true);'>+</button>`;


      c_term_inserts_button =   `  <button type="button" id="other_inserts_button" class="btn btn-primary btn-xs pull-right" onclick='manual_selected(this);showModal("Inserts",tables["other_inserts"],"");$("#fusion_where").val(icl_cut);inserts_helper("cterm");inserts_overview(true);'>+</button>`;

      n_term_button = `<button type="button" id="nterm_button" class="btn btn-primary btn-xs  pull-right" onclick='manual_selected(this);build_nterm_menu();showModal("N-term",tables["nterm"],"#nterm_sug");'>+</button>`;

      c_term_button = `<button type="button" id="cterm_button" class="btn btn-primary btn-xs pull-right" onclick='manual_selected(this);build_cterm_menu();showModal("C-term",tables["cterm"],"#cterm_sug");'>+</button>`;

      {% if class == 'A'  or class == 'F' %}
      icl_start_button = `<button type="button" id="icl3_start_button" class="btn btn-primary btn-xs pull-right" onclick='build_icl3_menu();showModal("ICL3 (Start)",tables["icl3_start"],"#icl3_sug_start");'>+</button>`;
      {% elif class == 'B' or class == 'C' %}
        icl_start_button = `<button type="button" id="icl2_start_button" class="btn btn-primary btn-xs pull-right" onclick='build_icl2_menu();showModal("ICL2 (Start)",tables["icl2_start"],"#icl2_sug_start");'>+</button>`;
      {% endif %}

      {% if class == 'A'  or class == 'F' %}
        icl_end_button = `<button type="button" id="icl3_end_button" class="btn btn-primary btn-xs pull-right" onclick='build_icl3_menu();showModal("ICL3 (End)",tables["icl3_end"],"#icl3_sug_end");'>+</button>`;
      {% elif class == 'B' or class == 'C' %}
       icl_end_button = `<button type="button" id="icl2_end_button" class="btn btn-primary btn-xs pull-right" onclick='build_icl2_menu();showModal("ICL2 (End)",tables["icl2_end"],"#icl2_sug_end");'>+</button>`;
      {% endif %}

      mutations_button = `<button type="button" id="mutations_mode" class="btn btn-primary btn-xs  pull-right" onclick='manual_selected(this);build_mutation_mode_table();showModal("Mutations",tables["mutations"],"#mutations");'>+</button>`;

      custom_button = `<button type="button" id="mutations_button" class="btn btn-primary btn-xs" onclick='manual_selected(this);showModal("Custom",tables["custom"]);'>
          Custom
        </button>`;

      prev_choice = $("#edit_mode .snakechoice:checked").val();

      console.log('prevchoice',prev_choice);
      if (!prev_choice) prev_choice = 0;

      $("#edit_mode > tbody").html("");
       // console.log('table rows',table_rows.length);
       $.each(table_rows, function(key,val) {
          console.log("table_row",val);
            tr_class = '';
          icl_end_pos = false;
          icl_start_pos = false;
          if (val["nterm_pos"]) {
            n_val = val["nterm_pos"]
            nterm_pos = {{residues.TM1.0.sequence_number}}-n_val;
            if (nterm_pos>0) {
              nterm_aa = residues_pos[nterm_pos][0];
            } else {
              nterm_aa = "N/A";
            }
            nterm_cols = "<td>"+n_val+n_term_button+"</td><td>"+nterm_pos+"</td><td>"+nterm_aa+"</td>";
          } else {
            nterm_cols = "<td>"+n_term_button+"</td><td></td><td></td>";
          }

          if (val["cterm_pos"]){
            c_val = val["cterm_pos"]
            cterm_pos = {{residues.Cterm.0.sequence_number}}+parseInt(c_val)-1;

            if (cterm_pos-1>residues_pos.length) {
              cterm_aa = "N/A";
            } else {
              cterm_aa = residues_pos[cterm_pos][0];
            }

            cterm_cols = "<td>"+c_val+c_term_button+"</td><td>"+cterm_pos+"</td><td>"+cterm_aa+"</td>";
          } else {
            cterm_cols = "<td>"+c_term_button+"</td><td></td><td></td>";
          }

          {% if class == 'A' %}
                gn_550 = 50;
                gn_650 = 50;
          {% elif class == 'F' %}
                gn_550 = 54;
                gn_650 = 49;
          {% endif %}

          {% if class == 'B' %}
              gn_350 = 54;
              gn_450 = 50;
          {% elif class == 'C' %}
            gn_350 = 54;
            gn_450 = 40;
          {% endif %}


          if (val["icl3_start_pos"]){
            icl_start_pos = parseInt(val["icl3_start_pos"])-1
            icl_start_val = "5."+(gn_550+icl_start_pos-{{residues_gn.5x50.sequence_number}});
            icl_start_aa = residues_pos[icl_start_pos][0];
            icl_start_cols = "<td>"+icl_start_val+icl_start_button+"</td><td>"+icl_start_pos+"</td><td>"+icl_start_aa+"</td>";
          } else if (val["icl2_start_pos"]){
            icl_start_pos = parseInt(val["icl2_start_pos"])-1
            console.log('icl2!',icl_start_pos);
            icl_start_val = "3."+(gn_350+icl_start_pos-{{residues_gn.3x50.sequence_number}});
            icl_start_aa = residues_pos[icl_start_pos][0];
            icl_start_cols = "<td>"+icl_start_val+icl_start_button+"</td><td>"+icl_start_pos+"</td><td>"+icl_start_aa+"</td>";
          } else {
            icl_start_cols = "<td>"+icl_start_button+"</td><td></td><td></td>";
          }

          if (val["icl3_end_pos"]){
            icl_end_pos = parseInt(val["icl3_end_pos"])+1
            icl_end_val = "6."+(gn_650+parseInt(icl_end_pos)-{{residues_gn.6x50.sequence_number}});
            icl_end_aa = residues_pos[icl_end_pos][0];
            icl_end_cols = "<td>"+icl_end_val+icl_end_button+"</td><td>"+icl_end_pos+"</td><td>"+icl_end_aa+"</td>";
          } else if (val["icl2_end_pos"]){
            icl_end_pos = parseInt(val["icl2_end_pos"])+1
            icl_end_val = "4."+(gn_450+parseInt(icl_end_pos)-{{residues_gn.4x50.sequence_number}});
            icl_end_aa = residues_pos[icl_end_pos][0];
            icl_end_cols = "<td>"+icl_end_val+icl_end_button+"</td><td>"+icl_end_pos+"</td><td>"+icl_end_aa+"</td>";
          } else {
            icl_end_cols = "<td>"+icl_end_button+"</td><td></td><td></td>";
          }

          if (icl_end_pos && icl_start_pos && icl_end_pos<=icl_start_pos) {
            tr_class = 'error';
          }

          nfusion_cols = "<td class='possiblities_nterm'>"+n_term_fusion_button+"</td>";
          icl_start_linker = "<td class='possiblities_icl'></td>";
          icl_mod = "<td class='possiblities_icl'>"+icl_fusion_button+"</td>";
          icl_end_linker = "<td class='possiblities_icl'></td>";


          checked = "";
          if (key==prev_choice) checked = "checked";

          if (val["fusion"]){
            if (fusionpos == 'nterm') {
                nfusion_cols = "<td class='possiblities_nterm'>"+val["fusion"]['name']+n_term_fusion_button+"</td>";


            } else if (fusionpos =='None') {
              // None

            } else {
              // ICL
                      linker_count = 0;
                      icl_mod = "<td class='possiblities_icl'>"+val["fusion"]['name']+icl_fusion_button+"</td>";
                      $.each(manual_inserts[key]["fusion"], function(key2,val) {
                        if (val['type']=='fusion') {
                          linker_count += 1; // tracker to know when it is after
                        } else if (val['type']=='linker') {
                          if (linker_count==0) {
                            icl_start_linker = "<td>"+val['sequence']+"</td>";
                          } else{
                            icl_end_linker = "<td>"+val['sequence']+"</td>";
                          }
                        }
                      });
            }
          }

          // ignore for now
          icl_start_linker = '';
          icl_end_linker = '';

          icl_total_cols = icl_start_cols + icl_start_linker + icl_mod + icl_end_linker + icl_end_cols;

          custom_button = ''; // Remove custom button, as it's in menus

          // if (val['mutations_combi'].length == 0) val['mutations_combi'] = 'None';
          // if (val['mutations_fixed'].length == 0) val['mutations_fixed'] = 'None';
          //val['mutations'] = val['mutations_combi']+val['mutations_fixed'];
          // console.log(manual_inserts);
          // console.log(manual_inserts[key]);
          row_html = "<tr class='"+tr_class+"' id='row_"+key+"' construct_id='"+key+"'><td align=center>" + (key+1) + "<input type=button class='btn btn-info  btn-xs' value=Delete onclick='delete_manual_row("+key+")'>"+custom_button+"</td><td style='cursor: pointer;' onclick='selectTD(this);'><input type='radio' onclick='changesnakeplot(this)' class='snakechoice' value='"+key+"' "+checked+"></td><td>"+manual_inserts[key]['nterm'].length+n_term_inserts_button+"</td></td>"+nfusion_cols+nterm_cols+icl_total_cols+cterm_cols+"<td>"+manual_inserts[key]['cterm'].length+c_term_inserts_button+"</td><td>"+val['mutations']+mutations_button+"</td></tr>";
          $('#edit_mode tbody').append(row_html);
       });
      console.log('prevchoice',prev_choice);
      change_fusionpos();
    }


    function delete_other() {
          selected_construct = $('.snakechoice:checked').val();
          include = possible[selected_construct];
          console.log('TO KEEP '+include);
          temp_modifications = [];
          $.each(modifications, function(key,val) {

            if ($.inArray(String(key), include)==-1) { //&& val['type']!="Insert"
              return true;
            }
            temp_modifications.push(val)
          });
          modifications = temp_modifications;
          if (!edit_mode_on) {modifications_overview();} else {
            build_edit_table();
            overlay_modifications();
          }
    }


    function mutation_mode() {
      console.log('mutation_mode');
      if ($('.snakechoice:checked').length && mutation_mode_on==false)
        {

          mutation_mode_on = true;
          selected_construct = $('.snakechoice:checked').val();
          $("#possibilities > tbody > tr").not( "#row_"+selected_construct).css("background-color","#777777");
          $("#row_"+selected_construct).css("background-color","#ffffff");
          $("#mutation_scan > tbody").html("");
          build_mutation_mode_table();
        } else {
          $("#possibilities > tbody > tr").css("background-color","#ffffff");
          mutation_mode_on = false;
          $("#mutation_scan > tbody").html("");
        }

    }

    function mutations_filter(elem) {
      checked = $(elem).prop("checked");
      value = $(elem).attr('value')
      if (!checked) {
        $("tr."+value).hide();
      } else {
        $("tr."+value).show();
      }
    }

    function build_mutation_mode_table(mut_mode) {
      console.log(mut_mode);
      var state = $('input:radio[name=state]:checked').val();
      combi_options = "<select id=combi_mutations class='form-control'>";
      c = 0;
      $.each(mutations_mode_suggestions, function(i, val) {
        state = 'any';
        if (i.split("_").length>1) {
          // this has a active_ or inactive_ prefix
          // if (!i.startsWith(state)){
          //   return true;
          // }
        }
          if (val['definitions'].indexOf('same_receptor') >= 0 || val['definitions'].indexOf('custom') >= 0 ) {
            // same receptor
          } else if (combi_mode_on || mut_mode=='known') {
            // if not same receptor and not in mutant scan mode, skip.
            return true;
          }
          c += 1;
          combi_options += "<option>"+c+"</option>";
      });
      combi_options += "</select>";
      var items_table = [info_text['mutations'] + "<input type='hidden' id='mut_fixed' value='no'><table  id='mutations' class='table-striped table table-bordered'><thead><tr><th></th><th>Prio</th><th>Segment</th><th>GPCRdb</th><th>Mutation</th><th>Rationale</th><th>Use in all constructs</th><th>Use in one construct</th></tr></thead><tbody>"];
      items_table.push('<p>Add top'+combi_options+" mutants to be used in <select id='mutant_where' class='form-control'><option>All constructs</option><option>In single constructs<input type=button value=Add onclick='auto_mutations()'><input type=button value='Uncheck all mutants' onclick='uncheck_mutations()'></p>");



      var items_table = [info_text['mutations']];

        if (edit_mode_on || combi_mode_on || mut_mode=='known') {
            items_table.push( "<input type='hidden' id='mut_fixed' value='yes'>");
          } else {
            items_table.push( "<input type='hidden' id='mut_fixed' value='no'>");
        }

      if (c>0 ){
        if (edit_mode_on || combi_mode_on || mut_mode=='known') {

            items_table.push('<p>Add top'+combi_options+" mutants<input type=hidden id='mutant_where' class='form-control' value='All constructs'> <input type=button value=Add onclick='auto_mutations(\"known\")'><input type=button value='Uncheck all mutants' onclick='uncheck_mutations(\"known\")'></p>");

        } else {

            items_table.push('<p>Add top'+combi_options+" mutants<input type=hidden id='mutant_where' class='form-control' value='In single constructs'> <input type=button value=Add onclick='auto_mutations(\"scan\")'><input type=button value='Uncheck all mutants' onclick='uncheck_mutations(\"scan\")'></p>");

            items_table.push('<p>Show: <input type=checkbox value="all" onclick=\'mutations_filter(this)\' checked> <a href="http://docs.gpcrdb.org/constructs.html#construct-design-tool"  target="_blank">Thermostabilising</a> <input type=checkbox value="glyco" onclick=\'mutations_filter(this)\'> glycosylation removal <input type=checkbox value="palmi" onclick=\'mutations_filter(this)\'> palmitoylation removal  </p>');

        }

            // items_table.push("<p class=info_text>Below are all generated mutant suggestions based on rules and annotated thermostabilising mutants.<br></p>");
            items_table.push("<table  id='mutations' class='table-striped table table-bordered'><thead><tr><th></th><th>Prio</th><th>Segment</th><th>GPCRdb</th><th>Mutation</th><th>Rationale</th><th>Add</th></tr></thead><tbody>");

        // console.log(mut_mode, c);
        $.each(mutations_mode_suggestions, function(i, val) {
          state = 'any';
          if (i.split("_").length>1) {
            // this has a active_ or inactive_ prefix
            // if (!i.startsWith(state)){
            //   return true;
            // }
            state = i.split("_")[0];
          }

          if (val['definitions'].indexOf('same_receptor') >= 0 || val['definitions'].indexOf('custom') >= 0) {
            // same receptor
          } else if (combi_mode_on || mut_mode=='known') {
            // if not same receptor and not in mutant scan mode, skip.
            return true;
          }

          class_of_mut = 'all';
          if (val['definitions'].indexOf('palmitoylation removal') >= 0) {
            class_of_mut = 'palmi';
          } else if (val['definitions'].indexOf('n-linked glycosylation removal') >= 0) {
            class_of_mut = 'glyco';
          } else if (val['definitions'].indexOf('o-linked glycosylation removal') >= 0) {
            class_of_mut = 'glyco';
          }
          checked_fixed = '';
          checked_combi = '';

          $.each(modifications, function(key,val2) {
              if (val2['type']=='mutation') {

                  gn = val["gpcrdb"];
                  gn = val["display_gn"];
                  pos = val["pos"];
                  to = val["mut_aa"];
                  wt = val["wt_aa"];
                  method = wt+pos+to+" "+gn
                  if (val2['full']==val || val2['method']==method) {
                    if (val2['fixed']=='yes') checked_fixed = 'checked';
                    if (val2['fixed']=='no') checked_combi = 'checked';
                    if (edit_mode_on && val2['fixed']=='no') checked_fixed = 'checked';
                  }
              }
            });

          td_add_common = `<td><input class=mut_fixed mut_id=`+i+` type=checkbox  onclick='mut_new(this, "yes");'` +checked_fixed+`></td>`
          td_add_unique = `<td><input class=mut_pick mut_id=`+i+` type=checkbox  onclick='mut_new(this, "no");'` +checked_combi+`></td>`


          if (edit_mode_on || combi_mode_on || mut_mode=='known') {
            td_add_unique = '';
          } else {
            td_add_common = '';
          }

          if (i.split("_").length>2) {
            row = `<tr class='`+class_of_mut+`'>
                  <td>`+state+`</td>
                  <td>`+val['priority']+`</td>
                  <td>`+val['segment1']+` & `+val['segment2']+`</td>
                  <td>`+val['gpcrdb1']+` & `+val['gpcrdb2']+`</td>
                  <td>`+val['wt_aa1']+val['pos']+val['mut_aa1']+` & `+val['wt_aa2']+val['pos2']+val['mut_aa2']+`</td>
                  <td>`+val['definitions']+`</td>
                  ` +td_add_common+`
                  ` +td_add_unique+`
                  </tr>`;

          } else {
            row = `<tr class='`+class_of_mut+`'>
                  <td>`+state+`</td>
                  <td>`+val['priority']+`</td>
                  <td>`+val['segment']+`</td>
                  <td>`+val['display_gn']+`</td>
                  <td>`+val['wt_aa']+val['pos']+val['mut_aa']+`</td>
                  <td>`+val['definitions']+`</td>
                  ` +td_add_common+`
                  ` +td_add_unique+`
                  </tr>`;
              }
          items_table.push(row);
        });

        items_table.push( "</tbody></table>" );
      } else {

        items_table.push( "<br><br>There are no suggestions as there are no proven mutations with effect in our database." );
      }
      result = items_table.join( "" );
      tables['mutations'] = result;

    }

    function reset_fixed(modi_type) {

      $.each(modifications, function(key,val) {
          if (val['type']+"_"+val['method']==modi_type) {
            modifications[key]['fixed'] = 'no';
          }
      });

    }


    function nterm_tm1(elem) {

      checked = $(elem).prop("checked");
      if (edit_mode_on || combi_mode_mut_on) {
        // remove previous
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='n-term') {
          id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

        $(elem).closest("table").find("[type=checkbox]").prop("checked",false);
        $(elem).prop("checked",checked);
      }
      // console.log('checked',checked);
      n_val = $(elem).attr("value");
      if (checked) {
        from = $(elem).attr("from").split(',');
        // until = {{residues_gn.1x50.sequence_number}}-n_val;

        until = {{residues.TM1.0.sequence_number}}-n_val-1;

        range = new Array;
        for (var i = 1; 1 > 0 ? i <= until : i > until; i += 1) {
            range.push(i);
        }
        // reset_fixed("deletion_n-term");
        // $('#myModal').modal('hide');
        // $(elem).parent().parent().delay(100).fadeOut().fadeIn();
        // $(elem).css('font-weight', 'bold');
        modi = {method: "n-term", type: "deletion", from: from, range: range, info: n_val+" from TM1 start. Based on "+from.join(", "), fixed: 'no', extra: n_val};
        modifications.push(modi);
      } else {
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='n-term') {
          if (parseInt(val['extra'])==parseInt(n_val)) id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);
      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
    }


    function custom_nterm(elem) {
      if (elem=='SignalP') {
        n_val_pos = $("#custom_nterm_pos_signal").val();
      } else {
        n_val = $("#custom_nterm").val();
        n_val_pos = $("#custom_nterm_pos").val();
      }
      from = ["custom"];
      // until = {{residues_gn.1x50.sequence_number}}-n_val;
      if (n_val_pos) {
        until = n_val_pos-1;
        n_val = {{residues.TM1.0.sequence_number}}-n_val_pos;
      } else {
        until = {{residues.TM1.0.sequence_number}}-n_val-1;
      }

      range = new Array;
      for (var i = 1; 1 > 0 ? i <= until : i > until; i += 1) {
          range.push(i);
      }

      id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL2_end') {
          if (parseInt(val['extra'])==parseInt($(elem).attr("tm4"))) id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

      if ($.inArray( n_val, custom_additions['nterm'] )==-1) custom_additions['nterm'].push(n_val);

      $.each(modifications, function(key,val2) {
              console.log(key,val2);
              if (val2['method']=='n-term') {
                  if (val2['extra']==n_val) {
                    console.log('already checked! remove',val);
                    remove_mod_by_id(key);
                    return false;
                  }
              }
      });

      // reset_fixed("deletion_n-term");
      // $('#myModal').modal('hide');
      modi = {method: "n-term", type: "deletion", from: from, range: range, info: "Custom: "+n_val+" from TM1 start", fixed: 'no', extra: n_val};
      modifications.push(modi);
      modifications_overview();
      // overlay_modifications();
      build_nterm_menu();
      $("#ModalBody").html(tables['nterm']);
      $("#custom_nterm").val('');
      $("#custom_nterm_pos").val('');
    }

    function cterm(elem) {
      checked = $(elem).prop("checked");
      if (edit_mode_on || combi_mode_mut_on) {
        // remove previous
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='c-term') {
          id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

        $(elem).closest("table").find("[type=checkbox]").prop("checked",false);
        $(elem).prop("checked",checked);
      }
      n_val = $(elem).attr("value");
      if (checked) {
        from = $(elem).attr("from").split(',');
        // start = {{residues_gn.8x50.sequence_number}}-n_val;
        start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val);
        {% with residues.Cterm|last as last %}
         end =   {{ last.sequence_number }};
        {% endwith %}

        range = new Array;
        for (var i = start; 1 > 0 ? i <= end : i > end; i += 1) {
            range.push(i);
        }

        // reset_fixed("deletion_c-term");
        // $('#myModal').modal('hide');
        // $(elem).parent().parent().delay(100).fadeOut().fadeIn();
        modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Based on "+from.join(", "), fixed: 'no', extra: n_val};
        modifications.push(modi);
      } else {
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='c-term') {
          if (parseInt(val['extra'])==parseInt(n_val)) id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
      // overlay_modifications();
    }

    function custom_cterm(elem) {
      n_val = $("#custom_cterm").val();
      from = ["custom"];
      n_val_pos = $("#custom_cterm_pos").val();
      // until = {{residues_gn.1x50.sequence_number}}-n_val;
      if (n_val_pos) {
        start = n_val_pos-1;
        n_val = n_val_pos-{{residues.Cterm.0.sequence_number}};
      } else {
        start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val)+1;
      }
      // until = {{residues_gn.1x50.sequence_number}}-n_val;

      start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val)+1;
      {% with residues.Cterm|last as last %}
       end =   {{ last.sequence_number }};
      {% endwith %}

      range = new Array;
      for (var i = start; 1 > 0 ? i <= end : i > end; i += 1) {
          range.push(i);
      }

      if ($.inArray( n_val, custom_additions['cterm'] )!==-1) custom_additions['cterm'].push(n_val);

      $.each(modifications, function(key,val2) {
              console.log(key,val2);
              if (val2['method']=='c-term') {
                  if (val2['extra']==n_val) {
                    console.log('already checked! remove',val);
                    remove_mod_by_id(key);
                    return false;
                  }
              }
      });

      // reset_fixed("deletion_c-term");
      // $('#myModal').modal('hide');
      modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Custom: "+n_val+" from TM8 end", fixed: 'no', extra: n_val};
      modifications.push(modi);
      modifications_overview();

      build_cterm_menu();
      $("#ModalBody").html(tables['cterm']);
      // overlay_modifications();
    }

    var icl3_del_start = 0;
    var icl_start_from = "";

    function custom_icl(icl_number) {

      icl_del_start = $("#custom_icl").val();
      if (icl_number=='3'){
        icl3_del_start =parseInt(icl_del_start)-50;
        icl_del_start = {{residues_gn.5x50.sequence_number}}-(-parseInt(icl_del_start))+1-50;
        method = 'ICL3_start';
      } else if (icl_number=='2'){
        icl2_del_start =parseInt(icl_del_start)-50;
        icl_del_start = {{residues_gn.3x50.sequence_number}}-(-parseInt(icl_del_start))+1-50;
        method = 'ICL2_start';
      }
      icl_start_from = "Custom";

      // showModal("ICL"+icl_number+" (End)",tables["icl"+icl_number+"_end"],"#icl"+icl_number+"_sug_end");
      // $("#icl"+icl_number+"_start_info").html("Start selected: ."+(parseInt(icl_del_start)) );

      modi = {method: method, type: "deletion", from: icl_start_from, range: [icl_del_start], info: "Based on "+icl_start_from, fixed: 'no',extra : icl_del_start};
      modifications.push(modi);
      modifications_overview();
      // overlay_modifications();

    }

    function custom_icl_end(icl_number) {

      icl_del_end = $("#custom_icl_end").val();
      // make it be positions from 50
      icl_del_end =50-parseInt(icl_del_end);
      // console.log("distance "+icl_del_end);

      from = "Custom";
      if (icl_number=="3") {
        end = {{residues_gn.6x50.sequence_number}}-icl_del_end;
      } else if (icl_number=="2") {
        end = {{residues_gn.4x50.sequence_number}}-icl_del_end;
      }

      // reset_fixed("deletion_ICL"+icl_number);
      modi = {method: "ICL"+icl_number+"_end", type: "deletion", from: from, range: [end], info: from, fixed: 'yes'};
      modifications.push(modi);
      modifications_overview();
      // overlay_modifications();
      // $('#myModal').modal('hide');

    }

    function icl3_start(elem) {
      checked = $(elem).prop("checked");
      if (edit_mode_on || combi_mode_mut_on) {
        // remove previous
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL3_start') {
          id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

        $(elem).closest("table").find("[type=checkbox]").prop("checked",false);
        $(elem).prop("checked",checked);
      }
      if (checked) {
        icl_start_from = $(elem).attr("from");
        icl3_del_start = {{residues_gn.5x50.sequence_number}}-(-$(elem).attr("tm5"))+1;
        // showModal("ICL3 (End)",tables["icl3_end"],"#icl3_sug_end");
        // $("#icl3_start_info").html("Start selected: 5."+(50+parseInt(icl3_del_start)) );
        modi = {method: "ICL3_start", type: "deletion", from: icl_start_from, range: [icl3_del_start], info: "Based on "+icl_start_from, fixed: 'no', extra: $(elem).attr("tm5")};
        console.log('ENTER ICL3 START');
        modifications.push(modi);
      } else {
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL3_start') {
          if (parseInt(val['extra'])==parseInt($(elem).attr("tm5"))) id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
      // overlay_modifications();
      // $('#myModal').modal('hide');
    }

    function icl3(elem) {
      checked = $(elem).prop("checked");
      if (edit_mode_on || combi_mode_mut_on){
        // remove previous
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL3_end') {
          id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

        $(elem).closest("table").find("[type=checkbox]").prop("checked",false);
        $(elem).prop("checked",checked);
      }
      if (checked) {
        // from = icl_start_from+","+$(elem).attr("from");
        // from = Array.from(new Set(from.split(',')));
        icl_start_from = $(elem).attr("from");
        end = {{residues_gn.6x50.sequence_number}}-$(elem).attr("tm6")-1;
        // start = {{residues_gn.5x50.sequence_number}}-(-icl3_del_start);
        // icl_cut = start;
        // console.log(start+" "+end);

        // range = new Array;
        // for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
        //     range.push(i);
        // }

        // reset_fixed("deletion_ICL3");
        //modi = {method: "ICL3", type: "deletion", from: from, range: range, info: "Based on "+from.join(", "), fixed: 'yes'};
        modi = {method: "ICL3_end", type: "deletion", from: icl_start_from, range: [end], info: "Based on "+icl_start_from, fixed: 'no',extra: $(elem).attr("tm6")};
        modifications.push(modi);
      } else {
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL3_end') {
          if (parseInt(val['extra'])==parseInt($(elem).attr("tm6"))) id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
      // overlay_modifications();
      // $('#myModal').modal('hide');
    }


    var icl2_del_start = 0;
    function icl2_start(elem) {
      checked = $(elem).prop("checked");
      if (edit_mode_on || combi_mode_mut_on){
        // remove previous
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL2_start') {
          id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

        $(elem).closest("table").find("[type=checkbox]").prop("checked",false);
        $(elem).prop("checked",checked);
      }
      if (checked) {

        icl2_del_start = {{residues_gn.3x50.sequence_number}}-(-$(elem).attr("tm3"))+1;
        icl_start_from = $(elem).attr("from");

        // showModal("ICL2 (End)",tables["icl2_end"],"#icl2_sug_end");
        // $("#icl2_start_info").html("Start selected: 3."+(50+parseInt(icl2_del_start)) );
        modi = {method: "ICL2_start", type: "deletion", from: icl_start_from, range: [icl2_del_start], info: "Based on "+icl_start_from, fixed: 'no', extra: $(elem).attr("tm3")};
        modifications.push(modi);
      } else {
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL2_start') {
          if (parseInt(val['extra'])==parseInt($(elem).attr("tm3"))) id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
      // overlay_modifications();
      // $('#myModal').modal('hide');

    }

    function icl2(elem) {
      checked = $(elem).prop("checked");
      if (edit_mode_on || combi_mode_mut_on){
        // remove previous
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL2_end') {
          id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

        $(elem).closest("table").find("[type=checkbox]").prop("checked",false);
        $(elem).prop("checked",checked);
      }
      if (checked) {
        // from = icl_start_from+$(elem).attr("from");
        // from = Array.from(new Set(from.split(',')));

        // end = {{residues_gn.4x50.sequence_number}}-$(elem).attr("tm4");
        // start = {{residues_gn.3x50.sequence_number}}-(-icl2_del_start);
        // icl_cut = start;
        // // console.log(start+" "+end);

        // range = new Array;
        // for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
        //     range.push(i);
        // }

        from = $(elem).attr("from");
        end = {{residues_gn.4x50.sequence_number}}-$(elem).attr("tm4")-1;

        reset_fixed("deletion_ICL2");
        modi = {method: "ICL2_end", type: "deletion", from: from, range: [end], info: "Based on "+from, fixed: 'no', extra: $(elem).attr("tm4")};
        modifications.push(modi);
      } else {
        id_to_remove = false;
        $.each(modifications, function(key,val) {
        if (val['method']=='ICL2_end') {
          if (parseInt(val['extra'])==parseInt($(elem).attr("tm4"))) id_to_remove = key;
        }
        });
        if (id_to_remove!==false) remove_mod_by_id(id_to_remove);

      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
      // overlay_modifications();
      // $('#myModal').modal('hide');
    }

    function custom_del(confirm) {
      start = $('#custom_del_start').val();
      end = $('#custom_del_end').val();
      reason = $('#custom_del_reason').val();

      start_gn = residues_pos[start][2];
      start_wt = residues_pos[start][0];
      start_seg = residues_pos[start][1];

      end_gn = residues_pos[end][2];
      end_wt = residues_pos[end][0];
      end_seg = residues_pos[end][1];

      label = start_wt+start+'-'+end_wt+end+' ('+start_seg+'/'+end_seg+')';
      if (typeof(confirm)==='undefined'){
        $('#confirm_cus_del').html('Custom deletion! '+label+' '+'Reason:'+reason+' <input type=button value=Confirm onclick=custom_del("1")>');
      } else {
        range = new Array;
        for (var i = parseInt(start); 1 > 0 ? i <= parseInt(end) : i > parseInt(end); i += 1) {
            range.push(i);
        }
        modi = {method: label, type: "deletion", to: to, range: range, info: "Custom deletion. Reason:"+reason, fixed: 'yes'};
        modifications.push(modi);
        modifications_overview();
        // overlay_modifications();
        $('#confirm_cus_del').html('Added '+label);
        pos = $('#custom_del_end').val('');
        to = $('#custom_del_start').val('');
        reason = $('#custom_del_reason').val('');
      }
    }

    function custom_mut(confirm) {
      mut_pos = $('#custom_pos').val();
      to = $('#custom_mut').val();
      reason = $('#custom_reason').val();
      fixed = $('#mut_fixed').val();
      gn = residues_pos[mut_pos][2];
      gn = residues_pos[mut_pos][3];
      wt = residues_pos[mut_pos][0];
      seg = residues_pos[mut_pos][1];

      if (reason=='') reason='None given';

      label = wt+mut_pos+to;
      if (typeof(confirm)==='undefined'){
        $('#confirm_cus_mut').html('<br><strong>Please confirm custom mutation</strong>:  '+label+' ('+seg+'/'+gn+') '+'Reason:'+reason+' <input type=button value=Confirm onclick=custom_mut("1")>');
      } else {
        range = new Array;
        range.push(mut_pos);
        modi = {method: label+" "+gn, type: "mutation", to: to, range: range, info: "Custom mutation. Reason:"+reason, fixed: fixed};
        modifications.push(modi);
        modifications_overview();
        // overlay_modifications();
        $('#confirm_cus_mut').html('Added '+label);
        $('#custom_pos').val('');
        $('#custom_mut').val('');
        $('#custom_reason').val('');

        var new_entry = {}
        new_entry[label] = {'definitions':['custom','Reason: '+reason], gpcrdb:gn, mut_aa:to, origin:[], pos:mut_pos, priority:1, segment:seg, wt_aa:wt};
        $.extend( new_entry, mutations_mode_suggestions );
        mutations_mode_suggestions = new_entry;
        if (fixed=='yes') {
          build_mutation_mode_table("known");
        } else {
          build_mutation_mode_table("scan");
        }
        showModal("Mutations",tables["mutations"],"#mutations");

      }

    }


    function change_fusionpos(){
      fusionpos = $('input:radio[name=fusionpos]:checked').val();
      // console.log(fusionpos);
      if (fusionpos == 'nterm') {
        // nterm
        $(".possiblities_icl").hide();
        $(".possiblities_nterm").show();
        $("#icl3_start_button").html("Deletion site start (last kept Rec res)*");
        $("#icl2_start_button").html("Deletion site start (last kept Rec res)*");
        $("#icl2_end_button").html("Deletion site end (first kept Rec res)*");
        $("#icl3_end_button").html("Deletion site end (first kept Rec res)*");
      } else if (fusionpos =='None') {
        // None
        $(".possiblities_nterm").hide();
        $(".possiblities_icl").hide();
        $("#icl3_start_button").html("Deletion site start (last kept Rec res)*");
        $("#icl2_start_button").html("Deletion site start (last kept Rec res)*");
        $("#icl2_end_button").html("Deletion site end (first kept Rec res)*");
        $("#icl3_end_button").html("Deletion site end (first kept Rec res)*");
      } else if (fusionpos =='both') {
        // None
        $(".possiblities_nterm").show();
        $(".possiblities_icl").show();
        $("#icl3_start_button").html("Fusion site start (last kept Rec res)*");
        $("#icl2_start_button").html("Fusion site start (last kept Rec res)*");
        $("#icl2_end_button").html("Fusion site end (first kept Rec res)*");
        $("#icl3_end_button").html("Fusion site end (first kept Rec res)*");

      } else {
        // ICL
        $(".possiblities_nterm").hide();
        $(".possiblities_icl").show();
        $("#icl3_start_button").html("Fusion site start (last kept Rec res)*");
        $("#icl2_start_button").html("Fusion site start (last kept Rec res)*");
        $("#icl2_end_button").html("Fusion site end (first kept Rec res)*");
        $("#icl3_end_button").html("Fusion site end (first kept Rec res)*");
      }
    }

    function add_fusion(elem){

      if (edit_mode_on || combi_mode_mut_on) {
        inserts['fusion'] = [];
      }

      fusion = $( "#fusion_choice option:selected" ).val();

      // console.log($(elem).parent());
      // console.log(fusion);

      range = new Array;
      range.push("");

      order_in_icl_insert = inserts['fusion'].length

      if ("fusion_"+fusion in insert_sequences) {
         sequence = insert_sequences["fusion_"+fusion];
      } else {
        sequence = "";
        var sequence = prompt("We do not have a sequence on record for this, please specify the sequence to use:", val['sequence']);
      }
      if (sequence === null) {
        sequence = "";
      }

      inserts['fusion'].push({type: "fusion", name: fusion, order: order_in_icl_insert, sequence: sequence});

      // fusion = {method: fusion, type: "Fusion", range: range, info: "", order: order_in_icl_insert, insert_location: "fusion"};
      // modifications.push(fusion);
      // overlay_modifications();
      // modifications_overview();
      inserts_overview();
      // console.log(inserts['fusion']);
    }


    function add_other_fusion(insert_location,insert_type,insert_sub_type){

      order_in_icl_insert = inserts[insert_location].length

      if (insert_type+"_"+insert_sub_type in insert_sequences) {
         sequence = insert_sequences[insert_type+"_"+insert_sub_type];
      } else {
        sequence = "";
      }

      if (insert_type=='linker') {
        sequence = insert_sub_type;
        insert_sub_type = 'custom';
      }

      if (sequence == "") {
        var sequence = prompt("We do not have a sequence on record for this, please specify the sequence to use:", val['sequence']);
      }
      if (sequence === null) {
        sequence = "";
      }

      inserts[insert_location].push({type: insert_type, name: insert_sub_type, order: order_in_icl_insert, sequence: sequence});

      range = new Array;
      range.push("");

      // insert = {method: insert_type+":"+insert_sub_type, type: "Insert", range: range, info: "", order: order_in_icl_insert, insert_location: insert_location};
      // modifications.push(insert);
      // modifications_overview();
      // console.log(inserts);
      inserts_overview();


    }

    function edit_sequence(location,order){
      order = parseInt(order);
      $.each(inserts[location], function(key,val) {
        if (val['order']==order) {
          var sequence = prompt("Please specify the sequence to use:", val['sequence']);
          if (sequence!=null){
            inserts[location][key]['sequence'] = sequence;
          }
          return false;
        }
      });
      rebuild_insert_order();
      inserts_overview();
    }

    function remove_insert(location,order){
      order = parseInt(order);
      $.each(inserts[location], function(key,val) {
        if (val['order']==order) {
          inserts[location].splice(key, 1);
          return false;
        }
      });
      rebuild_insert_order();
      inserts_overview();
    }

    function change_insert(direction,location,order){
      order = parseInt(order);
      if (direction == "up"){
        if ((order)>0) { //dont go too far
          $.each(inserts[location], function(key,val) {
            if (val['order']==(order-1)) { //this is the one to replace
              val['order'] += 1;
            } else if (val['order']==order) { //this is the one to replace
              val['order'] -= 1;
            }
          })
        }
      } else if (direction == "down"){
        // console.log('move '+order+' down'+(order+1));
        if ((order+1)<inserts[location].length) { //dont go too far
          // console.log('move '+order+' down');
          $.each(inserts[location], function(key,val) {
            valorder = parseInt(val['order']);
            // console.log(val);
            if (valorder==order) { //this is the one to replace
              val['order'] += 1;
            } else if (valorder==(order+1)) { //this is the one to replace
              val['order'] -= 1;
            }
            // console.log(val);
          })
        }
      }
      inserts_overview();
    }

    function rebuild_insert_order() {
      console.log("rebuild_insert_order!");
      fusionpos = $('input:radio[name=fusionpos]:checked').val();
      // $.each(modifications, function(key,val) { //remove all inserts
      //   console.log(val);
      //   type = val['type'];
      //   if (type == 'Fusion' || type == 'Insert' ) {
      //     modifications.splice(key, 1);
      //   }
      // });
      for(var i = 0; i < modifications.length; i++) {
          type =  modifications[i]['type'];
          if (type == 'fusion' || type == 'Insert' ){
            modifications.splice(i, 1);
              i--;
          }
      };

      $.each(['nterm','fusion','cterm'], function(key,segment) {
        //console.log(segment);
        inserts[segment].sort(function(a, b) {
            return a.order - b.order
        })
        $.each(inserts[segment], function(key,val) {
          val['order'] = key;
          // console.log("segment"+segment);
          // console.log(val);
          // console.log("icl_cut"+icl_cut);
          if (segment=='fusion' && icl_cut) {
            range = icl_cut;
          } else if (val['range']) {
            range = val['range'][0];
          } else {
            range = "";
          }
          if (fusionpos =='None' ||  fusionpos =='nterm') {
            range = "";
          }
          modi_type = 'Insert';
          if (val['type']=='fusion') modi_type = 'fusion'
          insert = {method: val['type']+":"+val['name'], type: modi_type, range: [range], info: "", order: val['order'], insert_location: segment, sequence: val['sequence']};
          // console.log('CHECK INSERT' + insert);
          modifications.push(insert);
          // console.log(modifications);
        });
      });
      console.log('reorder done');
    }

    function mut(elem) {
      gn = $(elem).attr("gn");
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).parent().parent().parent().find('.origin').html();
      origin = $(elem).attr("title");
      origin = $(elem).parent().attr("origin");


      // console.log(origin);

      range = new Array;
      range.push(pos);


      modi = {method: wt+pos+to+" "+gn, type: "mutation", to: to, range: range, info: "Based on: "+origin.split(',').join(', '), fixed: 'yes'};
      modifications.push(modi);
      modifications_overview();
      // overlay_modifications();
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
    }

    function uncheck_mutations(mut_type) {
      var state = $('input:radio[name=state]:checked').val();
      $.each(mutations_mode_suggestions, function(i, val) {
        if (i.split("_").length>1) {
          // this has a active_ or inactive_ prefix
          if (!i.startsWith(state)){
            return true;
          }
        }

         mutation = val;
          gn = mutation["gpcrdb"];
          pos = mutation["pos"];
          to = mutation["mut_aa"];
          wt = mutation["wt_aa"];
          method = wt+pos+to+" "+gn
          $.each(modifications, function(key,val2) {
              console.log(key,val2);
              if (val2['type']=='mutation') {
                  if (val2['full']==mutation || val2['method']==method) {
                    console.log('already checked! remove',val);
                    remove_mod_by_id(key);
                    return false;
                  }
              }
            });

      });
        build_mutation_mode_table(mut_type);
        showModal("Mutations",tables["mutations"],"#mutations");
        if (!edit_mode_on) {modifications_overview();} else {
          build_edit_table();
          overlay_modifications();
        }
    }

    function auto_mutations(mut_type) {
      amount = $("#combi_mutations").val();
      where = $("#mutant_where").val();
      var state = $('input:radio[name=state]:checked').val();
      console.log(amount,where);
      c = 0;
      fixed = 'no';
      if (where =='All constructs') fixed = 'yes';
      console.log(mut_type,fixed,amount);
      $.each(mutations_mode_suggestions, function(i, val) {
        if (i.split("_").length>1) {
          // this has a active_ or inactive_ prefix
          // if (!i.startsWith(state)){
          //   return true;
          // }
        }
          c += 1;
         if (c>amount) return false;
         mutation = val;
          gn = mutation["gpcrdb"];
          pos = mutation["pos"];
          to = mutation["mut_aa"];
          wt = mutation["wt_aa"];
          method = wt+pos+to+" "+gn
          console.log(modifications);
          $.each(modifications, function(key,val2) {
              console.log(key,val2);
              if (val2['type']=='mutation') {
                  if (val2['full']==mutation || val2['method']==method) {
                    console.log('already checked! remove',val);
                    remove_mod_by_id(key);
                    return false;
                  }
              }
            });

          gn = mutation["gpcrdb"];
          pos = mutation["pos"];
          to = mutation["mut_aa"];
          wt = mutation["wt_aa"];

          origin = mutation["definitions"];

          range = new Array;
          range.push(pos);

          modi = {method: wt+pos+to+" "+gn, type: "mutation", to: to, range: range, info: "Based on: "+origin, fixed: fixed, full:mutation};
          modifications.push(modi);

      });
        build_mutation_mode_table(mut_type);
        showModal("Mutations",tables["mutations"],"#mutations");
        if (!edit_mode_on) {modifications_overview();} else {
          build_edit_table();
          overlay_modifications();
        }
    }

    function auto_nterm() {
      amount = $("#combi_nterm").val();
      for(var i = 0; i < amount; i++) {
        // console.log(i,export_list['nterm'][i]);
        if (i>=export_list['nterm'].length) break;
        entry = export_list['nterm'][i];
        from = entry[4];
        n_val = entry[0];
        until = {{residues.TM1.0.sequence_number}}-n_val-1;
        range = new Array;
        for (var ii = 1; 1 > 0 ? ii <= until : ii > until; ii += 1) {
            range.push(ii);
        }

          $.each(modifications, function(key,val2) {
              console.log(key,val2);
              if (val2['type']=='deletion' && val2['method']=="n-term") {
                  if (val2['extra']==n_val) {
                    console.log('already checked! remove',val);
                    remove_mod_by_id(key);
                    return false;
                  }
              }
            });

        modi = {method: "n-term", type: "deletion", from: from, range: range, info: n_val+" from TM1 start. Based on "+from.join(", "), fixed: 'no', extra: n_val};
        modifications.push(modi);
      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
      build_nterm_menu();
      $("#ModalBody").html(tables['nterm']);
    }

    function auto_icl_start() {
      amount = $("#combi_icl_start").val();

      {% if class == 'A' or class == 'F' %}
      ICL_name = "icl3";
      {% elif class == 'B' or class == 'C' %}
      ICL_name = "icl2";
      {% endif %}
      for(var i = 0; i < amount; i++) {
        // console.log(i,export_list[ICL_name+'_start'][i]);
        if (i>=export_list[ICL_name+'_start'].length) break;
        entry = export_list[ICL_name+'_start'][i];
        from = entry[3];
        {% if class == 'A' or class == 'F' %}
        icl3_del_start = {{residues_gn.5x50.sequence_number}}-(-entry[4])+1;
        modi = {method: "ICL3_start", type: "deletion", from: from, range: [icl3_del_start], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% elif class == 'B' or class == 'C' %}
        icl2_del_start = {{residues_gn.3x50.sequence_number}}-(-entry[4])+1;
        modi = {method: "ICL2_start", type: "deletion", from: from, range: [icl2_del_start], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% endif %}

        $.each(modifications, function(key,val2) {
              console.log(key,val2);
        {% if class == 'A' or class == 'F' %}
              if (val2['type']=='deletion' && val2['method']=="ICL3_start") {

        {% elif class == 'B' or class == 'C' %}
              if (val2['type']=='deletion' && val2['method']=="ICL2_start") {

          {% endif %}

                  if (val2['extra']==entry[4]) {
                    console.log('already checked! remove',val);
                    remove_mod_by_id(key);
                    return false;
                  }
              }
            });

        modifications.push(modi);
      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }


      {% if class == 'A' or class == 'F' %}
      build_icl3_menu();
      $("#ModalBody").html(tables['icl3_start']);
      {% elif class == 'B' or class == 'C' %}
      build_icl2_menu();
      $("#ModalBody").html(tables['icl2_start']);
      {% endif %}

    }

    function auto_icl_end() {
      amount = $("#combi_icl_end").val();

      {% if class == 'A' or class == 'F' %}
      ICL_name = "icl3";
      {% elif class == 'B' or class == 'C' %}
      ICL_name = "icl2";
      {% endif %}
      for(var i = 0; i < amount; i++) {
        if (i>=export_list[ICL_name+'_end'].length) break;
        entry = export_list[ICL_name+'_end'][i];
        from = entry[3];
        {% if class == 'A' or class == 'F' %}
        end = {{residues_gn.6x50.sequence_number}}-entry[4]-1;
        modi = {method: "ICL3_end", type: "deletion", from: from, range: [end], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% elif class == 'B' or class == 'C' %}
        end = {{residues_gn.4x50.sequence_number}}-entry[4]-1;
        modi = {method: "ICL2_end", type: "deletion", from: from, range: [end], info: "Based on "+from.join(", "), fixed: 'no', extra: entry[4]};
        {% endif %}

        modifications.push(modi);
      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }


      {% if class == 'A' or class == 'F' %}
      build_icl3_menu();
      $("#ModalBody").html(tables['icl3_end']);
      {% elif class == 'B' or class == 'C' %}
      build_icl2_menu();
      $("#ModalBody").html(tables['icl2_end']);
      {% endif %}
    }

    function auto_cterm() {
      console.log('AUTO CTERM!');
      amount = $("#combi_cterm").val();
      for(var i = 0; i < amount; i++) {
        console.log('ADD C TERM!',i)
        if (i>=export_list['cterm'].length) break;
        entry = export_list['cterm'][i];
        from = entry[3];
        n_val = entry[0];
        start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val);
        {% with residues.Cterm|last as last %}
         end =   {{ last.sequence_number }};
        {% endwith %}
        range = new Array;
        for (var ii = start; 1 > 0 ? ii <= end : ii > end; ii += 1) {
            range.push(ii);
        }

          $.each(modifications, function(key,val2) {
              console.log(key,val2);
              if (val2['type']=='deletion' && val2['method']=="c-term") {
                  if (val2['extra']==n_val) {
                    console.log('already checked! remove',val);
                    remove_mod_by_id(key);
                    return false;
                  }
              }
            });

        modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Based on "+from.join(", "), fixed: 'no', extra: n_val};
        modifications.push(modi);


      }
      if (!edit_mode_on) {modifications_overview();} else {
        build_edit_table();
        overlay_modifications();
      }
      build_cterm_menu();
      $("#ModalBody").html(tables['cterm']);
    }

    function mut_new(elem, fixed) {

      mut_id = $(elem).attr("mut_id");
      checked = $(elem).prop("checked");

      // console.log(mut_id);
      // console.log(mutations_mode_suggestions[mut_id]);

      mutation = mutations_mode_suggestions[mut_id];
      gn = mutation["gpcrdb"];
      gn = mutation["display_gn"];
      pos = mutation["pos"];
      to = mutation["mut_aa"];
      wt = mutation["wt_aa"];
      method = wt+pos+to+" "+gn
      // console.log(modifications);
      $.each(modifications, function(key,val2) {
          // console.log(key,val2);
          if (val2['type']=='mutation') {
              if (val2['full']==mutation || val2['method']==method) {
                console.log('already checked! remove',val);
                remove_mod_by_id(key);
                return false;
              }
          }
        });

        if (checked) {
          gn = mutation["gpcrdb"];
          gn = mutation["display_gn"];
          pos = mutation["pos"];
          to = mutation["mut_aa"];
          wt = mutation["wt_aa"];

          origin = mutation["definitions"];

          range = new Array;
          range.push(pos);

          modi = {method: wt+pos+to+" "+gn, type: "mutation", to: to, range: range, info: "Based on: "+origin, fixed: fixed, full:mutation};
          modifications.push(modi);
        }
        if (!edit_mode_on) {modifications_overview();} else {
          build_edit_table();
          overlay_modifications();
        }

        $(elem).parent().delay(100).fadeOut().fadeIn();

    }

    function glyco(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");
      to2 = $(elem).attr("to2");
      wt2 = $(elem).attr("wt2");

      origin = $(elem).attr("motif");

      // console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Glycosylation", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      if (to2) {
      range = new Array;
      pos2 = parseInt(parseInt(pos)+1)
      range.push(pos2);
      modi = {method: wt2+pos2+to2 + " Glycosylation", type: "mutation", to: to2, range: range, info: "Based on "+origin};
      modifications.push(modi);
      }

      modifications_overview();
      // overlay_modifications();
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
    }

    function palmi(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).attr("motif");

      // console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Palmitoylation site removal", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      modifications_overview();
      // overlay_modifications();
      $(elem).parent().parent().delay(100).fadeOut().fadeIn();
    }

    function modifications_overview(no_refresh) {
      console.log("Start modifications_overview",no_refresh);

      rebuild_insert_order();

      // $("#overview").html("");
      tables["overview"] = [];
      tables["overview"].push(info_text['current'] + "<div><table class='table-striped table table-bordered'><tr><th>Type</th><th>Modification</th><th>Pos/Range</th><th>Based on</th><th>Fix</th><th>Extra</th></tr>");

      // console.log(modifications);
      modifications.sort(function(a, b) {

          var o1 = a.type.toLowerCase();
          var o2 = b.type.toLowerCase();

          var p2 = a.method.toLowerCase();
          var p1 = b.method.toLowerCase();
          if (a.type=='mutation' && b.type=='mutation') {
            var p1 = a.range;
            var p2 = b.range;
          }


          var q1 = a.range;
          var q2 = b.range;

          if (o1 < o2) return -1;
          if (o1 > o2) return 1;
          if (p1 < p2) return -1;
          if (p1 > p2) return 1;
          if (q1 < q2) return -1;
          if (q1 > q2) return 1;
        })

      if (typeof(no_refresh)==='undefined') {
        make_combinations();
        overlay_modifications();
      }
      $.each(modifications, function(key,val) {
        // console.log(val);
        type = val['type'];
        range = val['range'];
        method = val['method'];
        from = val['from'];

        fix_checked = '';
        mod_class = '';
        if (val['fixed']) {
          if (val['fixed']=='yes'){
            fix_checked = 'checked';
            mod_class = 'fixed';
          }
        }

        if (val['ignored']) {
          if (val['ignored']=='true'){
            mod_class = 'ignored';
          }
        }

        if (val['info']) {
          info = "<p style='max-width: 100px;'>"+val['info']+"</p>";
        } else {
          info = "";
        }

        if (val['range'].length == 1 ) {
          range = val['range'];
        } else {
          // console.log(val['range']);
          // a = val['range'].split(',');
          range = val['range'][0]+" - "+val['range'][val['range'].length - 1];
        }

        if (type == 'fusion' || type == 'Insert' ) {
          range = val['insert_location']+":"+val['order'];
        }


        row =  "<h3>"+method+" ("+type+")</h3>" +
            "<div>" +
            // "  <p>Based from "+from+"</p>" +
            // "  <p>"+range+"</p>" +
            info +
            "  <button onclick='remove_mod(this)' mod_id="+key+">Remove</button>" +
            "</div>"
        row =  "<tr class="+mod_class+"><td>"+type+"</td><td>"+method+"</td><td>"+range+"</td><td><p style='max-width: 400px;'>"+val['info']+"</p></td><td><input class='fix_"+type+"_"+method+"' fix_type='"+type+"_"+method+"'  mod_id="+key+" type=checkbox "+fix_checked+"  onclick='update_fix(this);'></td><td class=mod_buttons><button class='btn btn-secondary' onclick='remove_mod(this)' mod_id="+key+">Remove</button></td></tr>";
        // $("#overview").append(row);
        tables["overview"].push(row);

      })
      tables["overview"].push("</table></div>");

      tables["overview"] = tables["overview"].join( "" );
      tables["overview"] += "<br>"+possible_combinations+" possible combinations<hr>";
      $.each(export_list['sequences'], function(key,seq) {
        tables["overview"] += "Combination #"+(key+1)+":<br>"+seq[1]+"<br>";
      });
      // $( "#overview" ).accordion( "refresh" );
      // $( "#overview" ).accordion({
      //   collapsible: true,
      //   active: false,
      // });

    }


    function inserts_overview(initial) {
      // console.log("Start inserts_overview");
      // $("#overview").html("");

      position = current_position_insert;
      console.log('current pos',position,current_position_insert)

      tables["inserts"] = [];
      tables["inserts"].push(info_text['inserts_general'] + "<table class='table-striped table table-bordered'><tr><th>Type</th><th>Subtype</th><th>Sequence</th><th>Order</th></tr>");
      $.each(['nterm','fusion','cterm'], function(key,segment) {

        // if specific segment, only show those
        if (position!==false){
          if (segment!=position) return;
        }
        //console.log(segment);
        inserts[segment].sort(function(a, b) {
            return a.order - b.order
        })
        $.each(inserts[segment], function(key2,val) {
          // console.log(val);
          type = val['type'];
          subtype = val['name'];
          order = val['order'];
          sequence = val['sequence'];
          if (sequence.length>18) {
            sequence = sequence.substring(0, 16)+"...";
          }
          //<td>"+segment_pretty[key]+"</td>
          row =  "<tr><td>"+type+"</td><td>"+subtype+"</td><td>"+sequence+" <a href=# onclick=edit_sequence('"+segment+"','"+order+"');><span class='glyphicon glyphicon-edit'></span></a></td><td>"+order+" <a href=# onclick=change_insert('up','"+segment+"','"+order+"');><span class='glyphicon glyphicon-arrow-up'></span></a> <a href=# onclick=change_insert('down','"+segment+"','"+order+"');><span class='glyphicon glyphicon-arrow-down'></a> <a href=# onclick=remove_insert('"+segment+"','"+order+"');><span class='glyphicon glyphicon-remove-sign'></a> </td></tr>";
          tables["inserts"].push(row);

        });

      })
      tables["inserts"].push("</table>");

      if (initial!=true) {
          if (!edit_mode_on) {modifications_overview();} else {
            build_edit_table();
            overlay_modifications();
          }
      }
      if ($('.snakechoice:checked').length) tables["inserts"].push("Sequence: "+export_list['sequences'][$('.snakechoice:checked').val()][1]);

      tables["inserts"] = tables["inserts"].join( "" );
      $("#inserts_table").html(tables["inserts"]);
      // $( "#overview" ).accordion( "refresh" );
      // $( "#overview" ).accordion({
      //   collapsible: true,
      //   active: false,
      // });

    }


    function make_combinations() {

      // groups that can only have on choice -- so if any is fixed, then ignore the rest
      unique_groups = {"deletion_c-term":[0,0,[],[]],"deletion_n-term":[0,0,[],[]],"deletion_ICL2_start":[0,0,[],[]],"deletion_ICL2_end":[0,0,[],[]],"deletion_ICL3_start":[0,0,[],[]],"deletion_ICL3_end":[0,0,[],[]],"mutation":[0,0,[],[],[]],"fusion":[0,0,[],[],[]]};
      //0 is combination options
      //1 is amount of fixed in this type (normally 1 but more for mutations)
      //2 is the key that is fixed
      //3 is the options to ignore from making
      //4 is the mutations that are fixed, to differenciate the ones that are combi

      combination_groups = [[],[],[],[],[],[]];
      // console.log(modifications);
      $.each(modifications, function(key,val) {
          fix_type = val['type']+"_"+val['method'];
          if (val['type'] == 'fusion') {
            fix_type="fusion";
          }
          val['ignored'] = "false";
          if (fix_type in unique_groups) {
            if(val['fixed']=='yes') {
              unique_groups[fix_type][1] += 1;
              unique_groups[fix_type][3] = unique_groups[fix_type][2];
              unique_groups[fix_type][2] = key; // only this key should be in the list to make combinations from
            } else {
              unique_groups[fix_type][0] += 1;
              if (unique_groups[fix_type][1]==0) {
                unique_groups[fix_type][2].push(key);
              } else {
                unique_groups[fix_type][3].push(key);
              }
            }
          }
          if (val['type']=="mutation") {
            //fixed will be fixed but include the rest as combinations
            if(val['fixed']=='yes') {
              unique_groups["mutation"][4].push(key);
              unique_groups["mutation"][1] += 1;
            } else {
              //if combination mutation
              unique_groups["mutation"][0] += 1;
              unique_groups["mutation"][2].push(key);

            }
          }
      });

      // console.log(unique_groups);
      possible_combinations = 1;
      modifications_to_do = []
      $.each(unique_groups, function(key,val) {
        // console.log(key,val[0]);
        if (key=='fusion' && fusionpos == 'nterm'){
          $("#"+key+"_count_nterm").html((val[0]+val[1]));
        } else if (key=='mutation') {
          $("#"+key+"_count").html((val[1]));
          $("#"+key+"_count_scan").html((val[0]));
        }else {
          $("#"+key+"_count").html((val[0]+val[1]));
        }
        $.each(val[3], function(key,ignored) {
          modifications[ignored]['ignored'] = "true";
        });
        if (val[1]!=0) {
          // do nothing, since there is only one
          if (key!='mutation') {
            modifications_to_do.push([val[2]]);
          } else {
            // add the combination possibilities to its own array
            if (val[2].length) {
              console.log('add mutations',val[1],"fixed",val[0],"combi");
              modifications_to_do.push(val[2]);
              if (val[0]) possible_combinations *= val[0];
            }

            $.each(val[4], function(key,val) {
              // add the fixed mutations one at a time
              modifications_to_do.push([val]);
            });
          }
        } else if (val[0]!=0) {
          //if combinations but it's not a batch with only one option (val[1])
          possible_combinations *= val[0];
          if (key!='mutation') {
            modifications_to_do.push(val[2]); //add all combinations to a single array
          } else {
            if (val[2]) modifications_to_do.push(val[2]); //add all combinations to a single array
            //for the case of mutations,
            $.each(val[4], function(key,val) {
              // add the fixed mutations one at a time
              modifications_to_do.push([val]);
            });
          }
        }
      });



      possible = allPossibleCases(modifications_to_do);
      // console.log("Do comb",possible);
      $("#total_count").html(possible.length);
      // console.log(possible);
      // console.log(modifications_to_do);
      // console.log(possible);
      export_list['sequences'] = [];
      table_rows = [];
      // console.log('start generation');
      $.each(possible, function(key,val) {
        // ensure it is a string
        val = String(val);
        generate_sequence(val);
      });
      // console.log('done generation');
      build_table_rows();
      // console.log(export_list['sequences']);
    }

    function build_table_rows() {

       $("#possibilities > tbody").html("");
       // console.log('table rows',table_rows.length);
       $.each(table_rows, function(key,val) {
          // console.log(val);
            tr_class = '';
          icl_end_pos = false;
          icl_start_pos = false;
          if (val["nterm_pos"]){
            n_val = val["nterm_pos"]
            nterm_pos = {{residues.TM1.0.sequence_number}}-n_val;
            if (nterm_pos>0) {
              nterm_aa = residues_pos[nterm_pos][0];
            } else {
              nterm_aa = "N/A";
            }
            nterm_cols = "<td>"+n_val+"</td><td>"+nterm_pos+"</td><td>"+nterm_aa+"</td>";
          } else {
            nterm_cols = "<td></td><td></td><td></td>";
          }

          if (val["cterm_pos"]){
            c_val = val["cterm_pos"]
            cterm_pos = {{residues.Cterm.0.sequence_number}}+parseInt(c_val)-1;

            if (cterm_pos-1>residues_pos.length) {
              cterm_aa = "N/A";
            } else {
              cterm_aa = residues_pos[cterm_pos][0];
            }

            cterm_cols = "<td>"+c_val+"</td><td>"+cterm_pos+"</td><td>"+cterm_aa+"</td>";
          } else {
            cterm_cols = "<td></td><td></td><td></td>";
          }


          {% if class == 'A' %}
                gn_550 = 50;
                gn_650 = 50;
          {% elif class == 'F' %}
                gn_550 = 54;
                gn_650 = 49;
          {% endif %}

          {% if class == 'B' %}
              gn_350 = 54;
              gn_450 = 50;
          {% elif class == 'C' %}
            gn_350 = 54;
            gn_450 = 40;
          {% endif %}


          if (val["icl3_start_pos"]){




            icl_start_pos = parseInt(val["icl3_start_pos"])-1
            icl_start_val = "5."+(gn_550+icl_start_pos-{{residues_gn.5x50.sequence_number}});
            icl_start_aa = residues_pos[icl_start_pos][0];
            icl_start_cols = "<td>"+icl_start_val+"</td><td>"+icl_start_pos+"</td><td>"+icl_start_aa+"</td>";
          } else if (val["icl2_start_pos"]){
            icl_start_pos = parseInt(val["icl2_start_pos"])-1
            console.log('icl2!',icl_start_pos);
            icl_start_val = "3."+(gn_350+icl_start_pos-{{residues_gn.3x50.sequence_number}});
            icl_start_aa = residues_pos[icl_start_pos][0];
            icl_start_cols = "<td>"+icl_start_val+"</td><td>"+icl_start_pos+"</td><td>"+icl_start_aa+"</td>";
          } else {
            icl_start_cols = "<td></td><td></td><td></td>";
          }

          if (val["icl3_end_pos"]){
            icl_end_pos = parseInt(val["icl3_end_pos"])+1
            icl_end_val = "6."+(gn_650+parseInt(icl_end_pos)-{{residues_gn.6x50.sequence_number}});
            icl_end_aa = residues_pos[icl_end_pos][0];
            icl_end_cols = "<td>"+icl_end_val+"</td><td>"+icl_end_pos+"</td><td>"+icl_end_aa+"</td>";
          } else if (val["icl2_end_pos"]){
            icl_end_pos = parseInt(val["icl2_end_pos"])+1
            icl_end_val = "4."+(gn_450+parseInt(icl_end_pos)-{{residues_gn.4x50.sequence_number}});
            icl_end_aa = residues_pos[icl_end_pos][0];
            icl_end_cols = "<td>"+icl_end_val+"</td><td>"+icl_end_pos+"</td><td>"+icl_end_aa+"</td>";
          } else {
            icl_end_cols = "<td></td><td></td><td></td>";
          }

          if (icl_end_pos && icl_start_pos && icl_end_pos<=icl_start_pos) {
            tr_class = 'error';
          }

          nfusion_cols = "<td class='possiblities_nterm'></td><td class='possiblities_nterm'></td>";
          nfusion_cols = "<td class='possiblities_nterm'></td>";
          icl_start_linker = "<td class='possiblities_icl'></td>";
          icl_mod = "<td class='possiblities_icl'></td>";
          icl_end_linker = "<td class='possiblities_icl'></td>";


          checked = "";
          if (key==0) checked = "checked";

          if (val["fusion"]){
            if (fusionpos == 'nterm') {
                nfusion_cols = "<td class='possiblities_nterm'>"+val["fusion"]['name']+"</td><td class='possiblities_nterm'></td>";
                nfusion_cols = "<td class='possiblities_nterm'>"+val["fusion"]['name']+"</td>";


            } else if (fusionpos =='None') {
              // None

            } else {
              // ICL
                      linker_count = 0;
                      icl_mod = "<td>"+val["fusion"]['name']+"</td>";
                      $.each(inserts["fusion"], function(key,val) {
                        if (val['type']=='fusion') {
                          linker_count += 1; // tracker to know when it is after
                        } else if (val['type']=='linker') {
                          if (linker_count==0) {
                            icl_start_linker = "<td>"+val['sequence']+"</td>";
                          } else{
                            icl_end_linker = "<td>"+val['sequence']+"</td>";
                          }
                        }
                      });
            }
          }

          // ignore for now
          icl_start_linker = '<td class="possiblities_icl"></td>';
          icl_end_linker = '<td class="possiblities_icl"></td>';

          if (icl_end_pos && icl_start_pos && icl_end_pos<=icl_start_pos) {
            tr_class = 'error';

            // use function but add the missing residue
            ICL_start,ICL_end,icl_start_linker,icl_end_linker = calculate_auto_linker(icl_start_pos+1,icl_end_pos-1);

            icl_start_linker = "<td>"+icl_start_linker+"</td>";
            icl_end_linker = "<td>"+icl_end_linker+"</td>";

          }


          icl_total_cols = icl_start_cols + icl_start_linker + icl_mod + icl_end_linker + icl_end_cols;

          if (val['mutations_combi'].length == 0) val['mutations_combi'] = 'None';
          if (val['mutations_fixed'].length == 0) val['mutations_fixed'] = 'None';

          if (combi_mode_on) {
            mutations = val['mutations_fixed'];
          } else {
            mutations = val['mutations_fixed'] + " </td><td> " + val['mutations_combi'];
          }


          row_html = "<tr class='"+tr_class+"' id='row_"+key+"'><td>" + (key+1) + "</td><td style='cursor: pointer;' onclick='selectTD(this);'><input type='radio' onclick='changesnakeplot(this)' class='snakechoice' value='"+key+"' "+checked+"></td><td>"+inserts['nterm'].length+"</td></td>"+nfusion_cols+nterm_cols+icl_total_cols+cterm_cols+"<td>"+inserts['cterm'].length+"</td><td>"+mutations+"</td></tr>";
          $('#possibilities tbody').append(row_html);
       });
        change_fusionpos();
    }

    function changesnakeplot(elem) {
      $(".snakechoice").not(elem).prop("checked", false);
      overlay_modifications($(elem).attr("value"));
    }

    function selectTD(elem){
      changesnakeplot($(elem).find('input:radio'));
      $(elem).find('input:radio').prop("checked", true);
    }

    function update_fix(elem) {
      id = $(elem).attr("mod_id");
      fix_group = $(elem).attr("fix_type");
      fix_checked = elem.checked;
      // console.log("check update "+fix_checked+" "+id+" reset: "+fix_group);

      reset_fixed(fix_group);
      if (fix_checked){
        // if checked
        // console.log("TRUE NOW "+fix_checked);
        modifications[id]['fixed'] = 'yes';
      }

      modifications_overview();
      $("#ModalBody").html(tables["overview"]);

    }

    function remove_mod(elem) {
      id = $(elem).attr("mod_id");
      // console.log('remove id'+id)
      //delete modifications[id];

      if (modifications[id]['type'] == 'fusion' || modifications[id]['type'] == 'Insert') {
        // if fusion/insert
        inserts[modifications[id]['insert_location']].splice(modifications[id]['order'], 1);
      }

      modifications.splice(id, 1);
      resetModifications();
      modifications_overview();
      // overlay_modifications();
      $("#ModalBody").html(tables["overview"]);

    }

    function remove_mod_by_id(id) {

      if (modifications[id]['type'] == 'fusion' || modifications[id]['type'] == 'Insert') {
        // if fusion/insert
        inserts[modifications[id]['insert_location']].splice(modifications[id]['order'], 1);
      }

      modifications.splice(id, 1);
      // resetModifications();
      // modifications_overview();
      // // overlay_modifications();
      // $("#ModalBody").html(tables["overview"]);

    }

    function calculate_auto_linker(ICL_start,ICL_end) {

              console.log('Calc new linker', ICL_start, ICL_end);
              new_cut_site = Math.round((ICL_start+ICL_end)/2);

              ICL_end_new = ICL_start-1;
              ICL_start = ICL_end+1;
              ICL_end = ICL_end_new;
              fusion_site_location = ICL_start;

              console.log('Calc new linker', ICL_start, ICL_end);

              icl_start_linker = '';

              for ( var i = ICL_start; 1 > 0 ? i <= new_cut_site : i > new_cut_site; i += 1) {
                icl_start_linker += residues_pos[i][0];
              }
              linker_to_add = 'G'
              for ( var i = new_cut_site+1; 1 > 0 ? i <= ICL_end : i > ICL_end; i += 1) {
                icl_start_linker += linker_to_add;
                linker_to_add = linker_to_add=='G' ? 'S' : 'G';
              }


              icl_end_linker = '';
              linker_to_add = 'G'
              for ( var i = ICL_start; 1 > 0 ? i <= new_cut_site : i > new_cut_site; i += 1) {
                icl_end_linker += linker_to_add;
                linker_to_add = linker_to_add=='G' ? 'S' : 'G';
              }
              for ( var i = new_cut_site+1; 1 > 0 ? i <= ICL_end : i > ICL_end; i += 1) {
                icl_end_linker += residues_pos[i][0];
              }

              console.log('LINKERS', icl_start_linker, icl_end_linker);

          return ICL_start,ICL_end,icl_start_linker,icl_end_linker;

    }

    function generate_sequence(include,manual) {
      console.log("Start generating a sequence",include);
      // console.log(include);
      include = include.split(",");
      track_pos = {};
      fusion_site_location = -1;

      table_row = {}

      fusionpos = $('input:radio[name=fusionpos]:checked').val();

      fusion_in_sequence = false;

      table_row['mutations_fixed'] = [];
      table_row['mutations_combi'] = [];
      table_row['mutations'] = [];

      ICL_start = 0;

      add_forced_icl_linkers = false;

      $.each(modifications, function(key,val) {

        if ($.inArray(String(key), include)==-1 && manual!='manual') { //&& val['type']!="Insert"
          return true;
        }
        // console.log(val);
        type = val['type'];
        range = val['range'];

        if (val['method']=='n-term' && val['type']=='deletion') {
            table_row['nterm_pos'] = val['extra'];
        }

        if (val['method']=='c-term' && val['type']=='deletion') {
            table_row['cterm_pos'] = val['extra'];
        }

        if (val['method']=='ICL3_start' && val['type']=='deletion') {
            table_row['icl3_start_pos'] = val['range'][0];
        }

        if (val['method']=='ICL3_end' && val['type']=='deletion') {
            table_row['icl3_end_pos'] = val['range'][0];
        }

        if (val['method']=='ICL2_start' && val['type']=='deletion') {
            table_row['icl2_start_pos'] = val['range'][0];
        }

        if (val['method']=='ICL2_end' && val['type']=='deletion') {
            table_row['icl2_end_pos'] = val['range'][0];
        }

        if (val['type']=='mutation') {
          if (val['fixed']=='yes') table_row['mutations_fixed'].push(val['method'])
          if (val['fixed']=='no') table_row['mutations_combi'].push(val['method'])
          table_row['mutations'].push(val['method']);
        }

        if (type == 'fusion') {
          if (val['insert_location']=='fusion'){

            // console.log('fusion! ');
            // console.log(val);
            val['name'] = val['method'].replace("fusion:", "");
            fusion_in_sequence = val;
            // fusion_in_sequence['type'] = 'Fusion';
            table_row['fusion'] = val;
          }
        }

        if (val['method']=='ICL3_start' || val['method']=='ICL2_start') {
          // do not color / track
          ICL_start = range[0];
            if (fusionpos!='nterm' && fusionpos!='None') {
              fusion_site_location = range[0];
            }
          return
        }

        if (val['method']=='ICL3_end' || val['method']=='ICL2_end') {
          if (ICL_start==0) return //do not color if no start selected
          // do not color / track
          ICL_end = range[0];

          if (ICL_start && ICL_end && ICL_end<ICL_start) {
              add_forced_icl_linkers = true;

              ICL_start,ICL_end,icl_start_linker,icl_end_linker = calculate_auto_linker(ICL_start,ICL_end);
              fusion_site_location = ICL_start;

          }

          range = new Array;
          for (var i = ICL_start; 1 > 0 ? i <= ICL_end : i > ICL_end; i += 1) {
              range.push(i);
          }
          // console.log('icl range',range);
        }



        $.each(range, function(i, ii){
          // console.log(ii,type);
          if (ii){
            track_pos[ii] = val;
          }
        })

      })
      // console.log("Fusion would be around "+fusion_site_location);
      sequence = "";
      sequence_short = "";
      sequence_short_2 = "";
      sequence_long = "";
      find_n_term = 0;
      $.each(inserts["nterm"], function(key,val) {
          sequence += "["+val['type']+":"+val['name']+"]";
          sequence_short += "["+val['type']+":"+val['name']+"]";
          sequence_short_2 += "["+val['type']+":"+val['name']+"]";
          if (val['sequence']) {
            sequence_long += val['sequence'].toLowerCase();
          } else {
            sequence_long += "["+val['type']+":"+val['name']+"]";
          }
          find_n_term = 1;
      });

      if (fusionpos=='nterm' && fusion_in_sequence) {
        var val = fusion_in_sequence;
        val['name'] = val['method'].replace("fusion:", "");
        sequence += "["+val['type']+":"+val['name']+"]";
        sequence_short += "["+val['type']+":"+val['name']+"]";
        sequence_short_2 += "["+val['type']+":"+val['name']+"]";
        if (val['sequence']) {
          sequence_long += val['sequence'].toLowerCase();
        } else {
          sequence_long += "["+val['type']+":"+val['name']+"]";
        }

          fusion_site_location = 0;
          find_n_term = 1;
      }

      if (find_n_term==0){
          sequence_short_2 += "[ADD N-TERM INSERTS]";
      }
      // console.log('fusion is at ' +fusion_site_location);

      add_wt_start = 1;
      $.each(residues_pos, function(key,val) {
        // console.log(key);
        // console.log(val);
        if (track_pos[key]){
          // if in here, either delete or add mutation
          // console.log(key +" "+track_pos[key]);
          if (add_wt_start==0){
            //if we were in a strech and got cut off
             sequence_short += (key-1)+"]";
          }
          if (track_pos[key]['type']=='mutation') {
            // console.log(key);
            // console.log(track_pos[key]);
            sequence += track_pos[key]['to'];
            sequence_short += "[MUT:"+val[0]+key+""+track_pos[key]['to']+"]";
            sequence_short_2 += "[MUT:"+val[0]+key+""+track_pos[key]['to']+"]";
            sequence_long += track_pos[key]['to'].toLowerCase();

          } else {
            // check for fusion site
            // console.log(key,fusion_site_location);
            if (fusion_site_location!=-1 && fusion_in_sequence) {
              if (key==fusion_site_location && fusionpos!='None') {
                  // console.log('WE ARE AT FUSION SITE!');

                  if (add_forced_icl_linkers) {
                    console.log('ADD LINKERS');
                    // if we have forced linkers due to overlap of cut sites
                    sequence += "[LINKER:"+icl_start_linker+"]";
                    sequence_short += "[LINKER:"+icl_start_linker+"]";
                    sequence_short_2 += "[LINKER:"+icl_start_linker+"]";
                    sequence_long += icl_start_linker.toUpperCase();
                  }

                  val = fusion_in_sequence;
                  val['name'] = val['method'].replace("fusion:", "");
                  sequence += "["+val['type']+":"+val['name']+"]";
                  sequence_short += "["+val['type']+":"+val['name']+"]";
                  sequence_short_2 += "["+val['type']+":"+val['name']+"]";
                  if (val['sequence']) {
                    sequence_long += val['sequence'].toLowerCase();
                  } else {
                    sequence_long += "["+val['type']+":"+val['name']+"]";
                  }


                  if (add_forced_icl_linkers) {
                    // if we have forced linkers due to overlap of cut sites
                    sequence += "[LINKER:"+icl_end_linker+"]";
                    sequence_short += "[LINKER:"+icl_end_linker+"]";
                    sequence_short_2 += "[LINKER:"+icl_end_linker+"]";
                    sequence_long += icl_end_linker.toUpperCase();
                  }

              }
            } else if (key==fusion_site_location && add_forced_icl_linkers) {
                    // if we have forced linkers due to overlap of cut sites
                    sequence += "[LINKER:"+icl_start_linker+"]";
                    sequence_short += "[LINKER:"+icl_start_linker+"]";
                    sequence_short_2 += "[LINKER:"+icl_start_linker+"]";
                    sequence_long += icl_start_linker.toUpperCase();
                    sequence += "[LINKER:"+icl_end_linker+"]";
                    sequence_short += "[LINKER:"+icl_end_linker+"]";
                    sequence_short_2 += "[LINKER:"+icl_end_linker+"]";
                    sequence_long += icl_end_linker.toUpperCase();
            }

          }
          add_wt_start = 1;
        } else {

          if (key==fusion_site_location && fusion_in_sequence) {
            // If fusion without a deletion
              sequence_short += (key-1)+"]";
              val_fusion = fusion_in_sequence;
              val_fusion['name'] = val_fusion['method'].replace("fusion:", "");
              sequence += "["+val_fusion['type']+":"+val_fusion['name']+"]";
              sequence_short += "["+val_fusion['type']+":"+val_fusion['name']+"]";
              sequence_short_2 += "["+val_fusion['type']+":"+val_fusion['name']+"]";
              if (val_fusion['sequence']) {
                sequence_long += val_fusion['sequence'].toLowerCase();
              } else {
                sequence_long += "["+val_fusion['type']+":"+val_fusion['name']+"]";
              }
              add_wt_start = 1;
          }

          sequence += val[0];
          sequence_long += val[0].toUpperCase();
          sequence_short_2 += val[0].toUpperCase();
          if (add_wt_start){
             sequence_short += "["+receptor_name+":"+key+"-";
             add_wt_start = 0;
          }
          last_key_in_stretch = key;
          // console.log('added');
        }
      });
      if (add_wt_start==0){
            //if we were in a strech and got cut off
             sequence_short += last_key_in_stretch+"]";
          }

      find_c_term = 0;
      $.each(inserts["cterm"], function(key,val) {
          sequence += "["+val['type']+":"+val['name']+"]";
          sequence_short += "["+val['type']+":"+val['name']+"]";
          sequence_short_2 += "["+val['type']+":"+val['name']+"]";
          if (val['sequence']) {
            sequence_long += val['sequence'].toLowerCase();
          } else {
            sequence_long += "["+val['type']+":"+val['name']+"]";
          }
          find_c_term = 1;
      });
      if (find_c_term==0){
          sequence_short_2 += "[ADD C-TERM INSERTS]";
      }

      export_list['sequences'].push([include.sort(function (a, b) {  return a - b;  }),sequence_short,sequence_long,sequence_short_2]);
      table_rows.push(table_row);
      // console.log(sequence_short);
      return [sequence_short,sequence_long];
    }

    function generate_new_path(pos1,pos2,type,add_forced_icl_linkers) {
          cut_pos = [pos1,pos2];
          console.log('CHECK OVERLAP',pos1,pos2);
          // fix to first
          if (parseInt(pos1)>ICL_min[type]) pos1 = ICL_min[type];
          if (parseInt(pos2)<ICL_max[type]) pos2 = ICL_max[type];
          x1 = parseInt($('#'+pos1).attr('cx'));
          y1 = parseInt($('#'+pos1).attr('cy'));

          x2 = parseInt($('#'+pos2).attr('cx'));
          y2 = parseInt($('#'+pos2).attr('cy'));

          // mirror py function
          y_indent = 90;
          y_offset = 50;
          boxY = Math.max(y1,y2)+y_offset;

          p2 = [Math.round(x1-y_indent*0.5),Math.round(boxY+y_indent*0.5)];
          p3 = [Math.round(parseInt(x2)+(y_indent)*0.5),Math.round(boxY+y_indent*0.5)]
          red_length = lengthbezier([x1,y1],p2,p3,0.01,[x2,y2]);

          extra_boxes = 0;
          if (fusionpos == 'nterm') {
            // nterm
          } else if (fusionpos =='None') {
            // None
          } else {
            // ICL


            if (fusion_in_sequence) extra_boxes += 1;
            if (add_forced_icl_linkers) extra_boxes += 2;
            // $.each(inserts["fusion"], function(key,val) {
            //   extra_boxes += 1;
            // });
          }

          tries = 0; // adjust size
          length_surplus = 50+ extra_boxes*50;
          old_length = 0;
          length_of_residues_in_loop = $( "circle."+type+".long:visible" ).length*18-18+length_surplus;
          // console.log('lenght',length_of_residues_in_loop,'resides',$( "circle."+type+".long:visible" ).length);
          while (Math.abs(red_length-length_of_residues_in_loop)>5){

              if (red_length-length_of_residues_in_loop>5){
                  y_indent *=0.9;
                } else{
                  y_indent *=1.1;
                }
                p2 = [Math.round(x1-y_indent*0.5),Math.round(boxY+y_indent*0.5)];
                p3 = [Math.round(parseInt(x2)+(y_indent)*0.5),Math.round(boxY+y_indent*0.5)]
                red_length = lengthbezier([x1,y1],p2,p3,0.01,[x2,y2]);
                if (old_length==red_length) {
                  break;
                }
                old_length = red_length;
                // console.log('new length',length);
              tries += 1;
              if (tries>100) break;
          }
          // console.log(y_indent,'tries',tries,length,fusion_in_sequence);


          points_red = "M "+x1+","+y1+" C"+p2[0]+","+p2[1]+" "+p3[0]+","+p3[1]+" "+(x2)+","+(y2);
          max_replace_y = 0;
          replace_loop_residues([x1,y1],[x2,y2],p2,p3,type,pos1,pos2,cut_pos);

            current_insert = 1;
            length_availiable = length_used_last-length_used_first;

            // PRINT FIRST AND LAST FOR DEBUG
            // where_on_line = length_used_first;
            // [where,cur_length] = wherebezier([x1,y1],p2,p3,step,where_on_line,[x2,y2],true );
            // $("#snake").append(add_box(where[0],where[1],'S','red'));
            // where_on_line = length_used_last;
            // [where,cur_length] = wherebezier([x1,y1],p2,p3,step,where_on_line,[x2,y2],true );
            // $("#snake").append(add_box(where[0],where[1],'E','red'));
          if (add_forced_icl_linkers)  {
              where_on_line = length_used_first+length_availiable*current_insert/(extra_boxes+1);
              [where,cur_length] = wherebezier([x1,y1],p2,p3,step,where_on_line,[x2,y2],true );
              color = 'black';
              $("#snake").append(add_box(where[0],where[1],'Linker',color));
              current_insert += 1;
          }


          if ( (fusionpos == 'icl2' || fusionpos == 'icl3') && fusion_in_sequence ) {
            // $.each(inserts["fusion"], function(key,val) {
            // fusion_in_sequence
            $.each([fusion_in_sequence], function(key,val) {
              where_on_line = length_used_first+length_availiable*current_insert/(extra_boxes+1);
              [where,cur_length] = wherebezier([x1,y1],p2,p3,step,where_on_line,[x2,y2],true );
              color = 'blue';
              if (val['type']=='fusion') color = 'purple';
              if (val['type']=='linker') color = 'black';
              $("#snake").append(add_box(where[0],where[1],val['type'],color));
              current_insert += 1;
            });
          }

          if (add_forced_icl_linkers)  {
              where_on_line = length_used_first+length_availiable*current_insert/(extra_boxes+1);
              [where,cur_length] = wherebezier([x1,y1],p2,p3,step,where_on_line,[x2,y2],true );
              color = 'black';
              $("#snake").append(add_box(where[0],where[1],'Linker',color));
              current_insert += 1;
          }

          path = "<path id='path_custom_"+type+"' class='"+type+" long construct_custom' d='" + points_red + "' stroke='red' stroke-dasharray='5,10,5' fill='none' stroke-width='2' />"
          $("#snake").prepend(path);

          [where,cur_length] = wherebezier([x1,y1],p2,p3,step,red_length/2,[x2,y2],true );
          if (where[1]<max_replace_y) where[1] = max_replace_y;
          $("rect."+type+".long").attr('x',-17+(x2+x1)/2);
          $("rect."+type+".long").next().attr('x',-17+18+(x2+x1)/2);
          $("rect."+type+".long").attr('y',where[1]+20);
          $("rect."+type+".long").next().attr('y',13+where[1]+20);
          redraw_terminus("C");
          // $("#snake").html($("#snake").html());
          // reload_tooltips();
          redraw_snake_after = true;
    }

    function generate_new_path_simple(pos1,pos2,indent,type) {
          var x1 = parseInt($('#'+pos1).attr('cx'));
          var y1 = parseInt($('#'+pos1).attr('cy'));

          var x2 = parseInt($('#'+pos2).attr('cx'));
          var y2 = parseInt($('#'+pos2).attr('cy'));
          points = "M "+x1+" "+y1+" Q"+(x1+indent)+" "+y2+" "+(x2)+" "+y2

          path = "<path id='path_custom_"+type+"' class='"+type+" long construct_custom' d='" + points + "' stroke='black' fill='none' stroke-width='2' />"
          $("#snake").prepend(path);
          // $("#snake").html($("#snake").html());
          // reload_tooltips();
    }

    function generate_term_boxes(term) {
        // console.log('generate term box',term);
            if (term=='C') {
              orientation = 1;
              first_visible_residue = parseInt($( "circle."+term+"-term.long:visible" ).last().attr('id'));
              term_full = "cterm";
              first_res = parseInt($( "circle.H8:visible" ).last().attr('id'));
              each_boxes = $(inserts[term_full]).toArray();
              var x_min = 0;
              var y2 = 0;
              $( "rect.ICL1:visible,rect.ICL2:visible,rect.ICL3:visible" ).each(function() {
                this_y = parseInt($(this).attr('y'));
                if (this_y>y2) y2 = this_y;
              });
              y2 = y2+50;
            } else {
              // N
              orientation = -1;
              first_visible_residue = parseInt($( "circle."+term+"-term.long:visible" ).first().attr('id'));
              term_full = "nterm";
              first_res = parseInt($( "circle.TM1:visible" ).first().attr('id'));
              each_boxes = $(inserts[term_full]).toArray().reverse();
              if (fusionpos=='nterm' && fusion_in_sequence) {
                each_boxes = $(inserts[term_full].concat([fusion_in_sequence])).toArray().reverse();
              }
              var x_max = x_svgmax; //from minmax function
              var y2 = 0;
              $( "rect.ECL1:visible,rect.ECL2:visible,rect.ECL3:visible" ).each(function() {
                this_y = parseInt($(this).attr('y'));
                if (this_y<y2) y2 = this_y;
              });
              y2 = y2-50;
            }
            new_orientation = orientation;



            // console.log('short visible?',$("rect."+term+"-term.short").is(':visible'));
            if ($("rect."+term+"-term.short").is(':visible')) {
              check_short_residues = $( "circle."+term+"-term.long:not(.svg_construct_hidden)" ).length;
              // console.log('check',check_short_residues);
              $("."+term+"-term.long").hide();
            }
            // if ($(term+"-term.short:visible").length) {
            //   // do not do stuff if it's short
            //   return
            // }

            // Safari fix where :visible is not working
            $.each($( "circle."+term+"-term.long" ), function(key,val) {

              if ($(val).css('display') != 'none') {
                first_visible_residue = parseInt($(val).attr('id'));
                if (term=='N') {return false;}
              }

            });


            if (isNaN(first_visible_residue)) {
              // $("."+term+"-term").hide();
              $("line."+term+"-term.long:visible").addClass('svg_construct_hidden');
              $("line."+term+"-term.long:visible").hide();
              if (inserts["nterm"].length==0) {
                $(".long."+term+"-term:visible").addClass('svg_construct_hidden');
                $(".long."+term+"-term:visible").hide();
              }
              first_visible_residue = first_res;
            }


              var x1 = parseInt($('#'+first_visible_residue).attr('cx'));
              var y1 = parseInt($('#'+first_visible_residue).attr('cy'));

              // if ($("rect."+term+"-term.short").is(':visible')) {
              //   var x1 = parseInt($("rect."+term+"-term.short").attr('x'))+30;
              //   var y1 = parseInt($("rect."+term+"-term.short").attr('y'));
              // }

              // define boundaries for bends
              if (term=='C') var x_max = parseInt($('#'+first_res).attr('cx'))-90*orientation;
              if (term=='N') var x_min = parseInt($('#'+first_res).attr('cx'))-90*orientation;

              // console.log(term,'min',x_min,'max',x_max);

              if ((term=='C' && (y1-y2)>0) || (term=='N' && (y2-y1)>0)) {
                // is after the first bend, consider reversing direction
                bends = Math.round(Math.abs(y1-y2)/30);
                // console.log('term',term,'starts after first bend?',bends,y1,y2);
                new_orientation = orientation* Math.pow(-1,bends); //reverse amount of bends
              }

              var boxx = x1+20*(-1)*new_orientation;
              var boxy = y1;

              var length = 0;
              var pos = 0;
              var prev_box = x1;
              var prev_boxY = y1;
              var distance_between_rows = 30;
              // make sure we're up where we need to be
              if (y1-4>svgmin && term=='N') {


                x1 = parseInt($('#'+first_res).attr('cx'));
                y1 = parseInt($('#'+first_res).attr('cy'));

                // if ($("rect."+term+"-term.short").is(':visible')) {
                //   var x1 = parseInt($("rect."+term+"-term.short").attr('x'));
                //   var y1 = parseInt($("rect."+term+"-term.short").attr('y'));
                // }
                // console.log('Last',y1,'min',svgmin,'residues_between',first_res-first_visible_residue);


                bezierX = x1+60*orientation
                bezierY = (y2+y1)/2+60*orientation;

                x2 = x1-90*orientation;
                // y2 = svgmin;
                points = "M "+(x1)+" "+(y1)+" Q"+(bezierX)+" "+(bezierY)+" "+(x2)+" "+(y2);
                path = "<path class='"+term+"-term long construct_custom' d='" + points + "' stroke='black' fill='none' stroke-width='4' />";
                // $("#snake"  ).append(path);
                length = lengthbezier([x1,y1],[bezierX,bezierY],[x2,y2],0.001);
                pos = 40 + 18*(first_res-first_visible_residue)+18;



                if ($("rect."+term+"-term.short").is(':visible') && each_boxes.length) {
                  if (check_short_residues){
                    [[boxx,boxy],cur_length] = wherebezier([x1,y1],[bezierX,bezierY],[x2,y2],0.001,60);
                    prev_box = boxx;
                    prev_boxY = boxy;
                    $("#snake").append(add_box(boxx,boxy,"N-term","black"));
                  }

                  if (!$("rect."+term+"-term.short").attr('original_x')) {
                    $("rect."+term+"-term.short").attr('original_x',$("rect."+term+"-term.short").attr('x'));
                    $("rect."+term+"-term.short").next().attr('original_x',$("rect."+term+"-term.short").next().attr('x'));
                    $("rect."+term+"-term.short").attr('original_y',$("rect."+term+"-term.short").attr('y'));
                    $("rect."+term+"-term.short").next().attr('original_y',$("rect."+term+"-term.short").next().attr('y'));
                    $("path."+term+"-term.short").attr('original_d',$("path."+term+"-term.short").attr('d'));
                  }
                  $("rect."+term+"-term.short").attr('x',x1+30);
                  $("rect."+term+"-term.short").next().attr('x',x1+55);
                  $("rect."+term+"-term.short").attr('y',y1-100);
                  $("rect."+term+"-term.short").next().attr('y',y1-87);
                  $("path."+term+"-term.short").attr('d',"M "+x1+" "+y1+" L "+boxx+" "+boxy);
                  pos = 100;
                }
              } else if (y1<y2 && term=='C') {
                // console.log('H8',first_res,'term last',first_visible_residue,'Last',y1,'max',y2,'residues_between',first_visible_residue-first_res);
                x1 = parseInt($('#'+first_res).attr('cx'));
                y1 = parseInt($('#'+first_res).attr('cy'));


                bezierX = x1+60*orientation
                bezierY = (y2+y1)/2+60*orientation;

                x2 = x1-90*orientation;
                // y2 = y_max;
                points = "M "+(x1)+" "+(y1)+" Q"+(bezierX)+" "+(bezierY)+" "+(x2)+" "+(y2);
                path = "<path class='"+term+"-term long construct_custom' d='" + points + "' stroke='black' fill='none' stroke-width='4' />";
                // $("#snake"  ).append(path);
                length = lengthbezier([x1,y1],[bezierX,bezierY],[x2,y2],0.001);
                pos = 40 + 18*(first_visible_residue-first_res)+18;


                if ($("rect."+term+"-term.short").is(':visible') && each_boxes.length) {
                  if (check_short_residues){
                    [[boxx,boxy],cur_length] = wherebezier([x1,y1],[bezierX,bezierY],[x2,y2],0.001,60);
                    prev_box = boxx;
                    prev_boxY = boxy;
                    $("#snake").append(add_box(boxx,boxy,"C-term","black"));
                    pos = 100;
                  }

                  if (!$("rect."+term+"-term.short").attr('original_x')) {
                    $("rect."+term+"-term.short").attr('original_x',$("rect."+term+"-term.short").attr('x'));
                    $("rect."+term+"-term.short").next().attr('original_x',$("rect."+term+"-term.short").next().attr('x'));
                    $("rect."+term+"-term.short").attr('original_y',$("rect."+term+"-term.short").attr('y'));
                    $("rect."+term+"-term.short").next().attr('original_y',$("rect."+term+"-term.short").next().attr('y'));
                    $("path."+term+"-term.short").attr('original_d',$("path."+term+"-term.short").attr('d'));
                  }
                  $("rect."+term+"-term.short").attr('x',x1-70);
                  $("rect."+term+"-term.short").next().attr('x',x1-45);
                  $("rect."+term+"-term.short").attr('y',y1+77);
                  $("rect."+term+"-term.short").next().attr('y',y1+90);
                  $("path."+term+"-term.short").attr('d',"M "+x1+" "+y1+" L "+boxx+" "+boxy);
                }

              }
            $.each(each_boxes, function(key,val) {
              // console.log('put box ',val,'attach to id',first_visible_residue,x1,y1,key,"min y",y_min,length,pos);
              redraw_snake_after = true;
              color = 'purple';
              if (pos+40<length) {
                // console.log('put on curve',pos);
                // Means we should use curve
                pos += (val['type'].substring(0, 6).length*7+2)*0.5;
                [[boxx,boxy],cur_length] = wherebezier([x1,y1],[bezierX,bezierY],[x2,y2],0.001,pos);

                // line = "<line class='"+term+"-term long construct_custom' x1="+prev_box+" y1="+prev_boxY+" x2="+boxx+" y2="+boxy+" stroke='black' fill='none' stroke-width='2' />"
                // $("#snake").prepend(line);


                points = "M "+prev_box+" "+prev_boxY+" Q"+(prev_box+boxx)/2+" "+(prev_boxY+boxy)/2+" "+boxx+" "+(boxy);
                path = "<path class='"+term+"-term long construct_custom' d='" + points + "' stroke='black' fill='none' stroke-width='2' />";
                $("#snake"  ).prepend(path);

                pos += (val['type'].substring(0, 6).length*7+2)*0.5;
                $("#snake").append(add_box(boxx,boxy,val['type'],color));
                prev_box = boxx;
                prev_boxY = boxy;
                boxx = boxx+ (val['type'].substring(0, 6).length*7+10)*0.5*(-1)*new_orientation;
              } else {
                if (term=='C' && (boxy)<y2) boxy = y2;
                if (term=='N' && (boxy)>y2) boxy = y2;

                bends = 0;
                if ((term=='C' && (boxy-y2)>0) || (term=='N' && (y2-boxy)>0)) {
                  // is after the first bend, consider reversing direction
                  bends = Math.round(Math.abs(boxy-y2)/30);
                  new_orientation = orientation* Math.pow(-1,bends); //reverse amount of bends
                  // console.log('orientation',orientation,bends,'current boxY',boxy,'first line',y2);
                }

                mid_bend = (bends*30-Math.abs(boxy-y2)==15 ? true : false);
                console.log('y curve end',y2,'last y',boxy,'length from curve end',Math.abs(boxy-y2),bends,bends*30-Math.abs(boxy-y2),"mid_bend",mid_bend);

                // console.log('RIGHT CHECK max:',x_max,"Current",boxx,"Last",prev_box);
                // console.log('LEFT CHECK max:',x_min,"Current",boxx,"Last",prev_box);
                at_bend = false;
                if (boxx<x_min+60 && prev_box>boxx) {
                  // Gone too far left and is moving left
                  // console.log("min",x_min,"current x",boxx);
                  boxy += distance_between_rows*orientation;
                  bezierX = prev_box-(50);
                  bezierY = (boxy-distance_between_rows*orientation*0.5);
                  points = "M "+(prev_box-(orientation*10))+" "+(boxy-distance_between_rows*orientation)+" Q"+(bezierX)+" "+(bezierY)+" "+(prev_box-(orientation*10))+" "+(boxy);
                  // line = "<line class='"+term+"-term long construct_custom' x1="+prev_box+" y1="+(boxy-distance_between_rows*orientation)+" x2="+prev_box+" y2="+boxy+" stroke='black' fill='none' stroke-width='2' />"
                  path = "<path class='"+term+"-term long construct_custom' d='" + points + "' stroke='black' fill='none' stroke-width='2' />";
                  if (!mid_bend) $("#snake"  ).prepend(path);
                  // console.log('gone too far left',orientation,(x_min+40))
                  at_bend = true;
                } else if (boxx>x_max-60 && prev_box<boxx) {
                  // Gone too far right and is going right
                  boxy += distance_between_rows*orientation;
                  bezierX = prev_box+(50);
                  bezierY = (boxy-distance_between_rows*orientation*0.5);
                  points = "M "+(prev_box+(orientation*10))+" "+(boxy-distance_between_rows*orientation)+" Q"+(bezierX)+" "+(bezierY)+" "+(prev_box+(orientation*10))+" "+(boxy);
                  // line = "<line class='"+term+"-term long construct_custom' x1="+prev_box+" y1="+(boxy-distance_between_rows*orientation)+" x2="+prev_box+" y2="+boxy+" stroke='black' fill='none' stroke-width='2' />"
                  path = "<path class='"+term+"-term long construct_custom' d='" + points + "' stroke='black' fill='none' stroke-width='2' />";
                  if (!mid_bend) $("#snake"  ).prepend(path);
                  // console.log('gone too far right',orientation,(boxy-y2))
                  at_bend = true;
                }

                boxx += (val['type'].substring(0, 6).length*7+15)*0.5*(-1)*new_orientation;
                boxy = boxy;


                if (mid_bend) {
                  // if at mid-bend correct
                  if (prev_box<boxx) {
                    // going right
                    boxy += 0.5*distance_between_rows*orientation;
                  } else {
                    boxy += 0.5*distance_between_rows*orientation;
                  }
                }

                points = "M "+prev_box+" "+prev_boxY+" Q"+(prev_box+boxx)/2+" "+(prev_boxY+boxy)/2+" "+boxx+" "+(boxy);

                path = "<path class='"+term+"-term long construct_custom' d='" + points + "' stroke='black' fill='none' stroke-width='2' />";
                if (!(at_bend && !mid_bend)) $("#snake"  ).prepend(path);
                // line = "<line class='"+term+"-term long construct_custom' x1="+prev_box+" y1="+prev_boxY+" x2="+boxx+" y2="+boxy+" stroke='black' fill='none' stroke-width='2' />"
                // $("#snake").prepend(line);

                $("#snake").append(add_box(boxx,boxy,val['type'],color));
                prev_box = boxx;
                prev_boxY = boxy;
                boxx += (val['type'].substring(0, 6).length*7+15)*0.5*(-1)*new_orientation;
              }
            });
    }


    function replace_loop_residues(x1y1,x2y2,p2,p3,type,pos1,pos2,cut_pos) {
      step = 0.01;
      between_residues = 18;
      total_length = lengthbezier(x1y1,p2,p3,step,x2y2);
      pos = 0;
      // console.log("Replace loop residues!",x1y1,x2y2,p1,p2,type,pos1,pos2,cut_pos);
      bezier_cache = [];
      length_used_first = 0;
      length_used_last = 0;
      // console.log('length of cache',Object.keys(bezier_cache).length);
      $( "circle."+type+".long:visible" ).each(function() {
        id = parseInt($(this).attr('id'));
        if (parseInt(id)>cut_pos[0]) {
          if (id == ICL_max[type]) {
            // console.log(id,'is last ICL residue, genereate path to TM');
            generate_new_path_simple(id,id+1,30,type);
          }
          // this is on the right side of the cut
          from_edge = pos2-parseInt(id);
          stop = total_length-from_edge*between_residues;
          [where,cur_length] = wherebezier(x1y1,p2,p3,step,stop,x2y2,true );
          $(this).attr('cx',where[0]);
          $(this).attr('cy',where[1]);
          $("#"+id+"t").attr('x',where[0]);
          $("#"+id+"t").attr('y',where[1]+6);
          if (where[1]>max_replace_y) max_replace_y = where[1];
          if (length_used_last==0) {
            length_used_last=cur_length-18;
          }
        } else {
          if (id == ICL_min[type]) {
            // console.log(id,'is first ICL residue, genereate path to TM');
            generate_new_path_simple(id-1,id,-30,type);
          }
          // this is on the left side of the cut
          from_edge = parseInt(id)-pos1;
          stop = from_edge*between_residues;
          [where,cur_length] = wherebezier(x1y1,p2,p3,step,stop,x2y2,true);
          length_used_first = cur_length+9;
          $(this).attr('cx',where[0]);
          $(this).attr('cy',where[1]);
          $("#"+id+"t").attr('x',where[0]);
          $("#"+id+"t").attr('y',where[1]+6);
          if (where[1]>max_replace_y) max_replace_y = where[1];
        }
      });
      if (length_used_last==0) length_used_last=total_length;

      // where = wherebezier(p0,p2,p3,0.001,pos,p1);
    }


    function overlay_modifications(possible_id) {


      console.log("Start overlay_modifications");
      redraw_snake_after = false;
      if (typeof(possible_id)=='undefined'){
        possible_id = 0;

        possible_id = $('.snakechoice:checked').val();
      }
      // console.log(possible_id)
      // console.log(possible[possible_id])

      if (edit_mode_on && manual_constructs.length) {
        modifications = manual_constructs[possible_id];
        inserts = manual_inserts[possible_id];
      }

      track_pos = {};
      fusion_site_location = -1;
      fusionpos = $('input:radio[name=fusionpos]:checked').val();
      // console.log("fusionpost"+fusionpos);

      $( "circle.ICL3.long:visible" ).each(function() {
        $(this).attr('cx',$(this).attr('original_cx'));
        $(this).attr('cy',$(this).attr('original_cy'));
      });

      $( "text.ICL3.long:visible" ).each(function() {
        $(this).attr('x',$(this).attr('original_x'));
        $(this).attr('y',$(this).attr('original_y'));
      });

      // fix short n/c term
      $( "text.short:visible" ).each(function() {
        if ($(this).attr('original_x')) {
            $(this).attr('x',$(this).attr('original_x'));
            $(this).attr('y',$(this).attr('original_y'));
        }
      });

      $( "rect.short:visible" ).each(function() {
        if ($(this).attr('original_x')) {
            $(this).attr('x',$(this).attr('original_x'));
            $(this).attr('y',$(this).attr('original_y'));
        }
      });

      $( "path.short:visible" ).each(function() {
        if ($(this).attr('original_d')) {
            $(this).attr('d',$(this).attr('original_d'));
        }
      });

      $( "text.mutated" ).each(function() {
        if ($(this).attr('original_aa')) {
            $(this).html($(this).attr('original_aa'));
            $(this).removeClass('mutated');
        }
      });


      // console.log('reset almost done');
      $('.svg_construct_hidden').show();
      $('.construct_custom').remove();
      resetColors("snakeplot");
      $('.svg_construct_hidden').removeClass('svg_construct_hidden');
      // console.log('reset almost done 2');
      redraw_terminus("N");
      redraw_terminus("C");
      ICL_start = 0;
      ICL_end = 0;
      // console.log('reset done');
      fusion_in_sequence = false;
      add_forced_icl_linkers = false;
      $.each(modifications, function(key,val) {

        // console.log("key is " + key + " look in " + possible[possible_id]);
        //  && String(key)!=possible[possible_id]
        if ($.inArray(String(key), String(possible[possible_id]).split(","))==-1 && String(key)!=possible[possible_id] && !edit_mode_on) {
          return true;
        }
        // console.log("use it!");

        type = val['type'];
        range = val['range'];
        // console.log(val,val['method']);

        if (type == 'fusion') {
          if (val['insert_location']=='fusion'){
            fusion_site_location = val['range'][0];
            val['name'] = val['method'].replace("fusion:", "");
            fusion_in_sequence = val;
            // console.log('fusionsite:'+fusion_site_location);
          }
        }

        if (val['method']=='ICL3_start' || val['method']=='ICL2_start') {
          // do not color / track
          ICL_start = range[0];
          return
        }

        if (val['method']=='ICL3_end' || val['method']=='ICL2_end') {
          if (ICL_start==0) return //do not color if no start selected
          // do not color / track
          ICL_end = range[0];

          if (val['method']=='ICL3_end') {
            $('#path_ICL3').addClass('svg_construct_hidden');
            $('#path_ICL3').hide();
            $('#path_ICL3_end').addClass('svg_construct_hidden');
            $('#path_ICL3_end').hide();
            $('#path_ICL3_first').addClass('svg_construct_hidden');
            $('#path_ICL3_first').hide();
            icl_name = "ICL3";
          } else if (val['method']=='ICL2_end') {
            $('#path_ICL2').addClass('svg_construct_hidden');
            $('#path_ICL2').hide();
            $('#path_ICL2_end').addClass('svg_construct_hidden');
            $('#path_ICL2_end').hide();
            $('#path_ICL2_first').addClass('svg_construct_hidden');
            $('#path_ICL2_first').hide();
            icl_name = "ICL2";
          }

          if (ICL_start && ICL_end && ICL_end<ICL_start) {
              add_forced_icl_linkers = true;
              new_cut_site = Math.round((ICL_start+ICL_end)/2);
              AA_to_add_on_N = new_cut_site-ICL_end;
              AA_to_add_on_C = ICL_start-new_cut_site;
              filler_amount_N = AA_to_add_on_C;
              filler_amount_C = AA_to_add_on_N;

              ICL_end = ICL_start-1;
              ICL_start = range[0]+1;
          }

          range = new Array;
          for (var i = ICL_start; 1 > 0 ? i <= ICL_end : i > ICL_end; i += 1) {
              range.push(i);
          }

        }

        $.each(range, function(i, ii){
          // console.log(ii,type);
          if (ii){
            track_pos[ii] = val;
            color_residue(ii,type);
          }
        })

      })

      if (ICL_start>0 && ICL_end>0) {
        console.log('Generate new loop',(ICL_start-1),(ICL_end+1),icl_name);
        generate_new_path((ICL_start-1),(ICL_end+1),icl_name,add_forced_icl_linkers);
      }

      generate_term_boxes("N");
      generate_term_boxes("C");

      if (redraw_snake_after)
      {
        // console.log('redraw snake');
        $("#snake").html($("#snake").html());
        reload_tooltips();
        // console.log('redrawn done');
      }

      maxmin();
      fix_snake_plot();
    }
    function fix_snake_plot() {
      $("#snakeplot").height("100%")
      // console.log('CHECKHEIGHT',$("#snakeplot").height());
      if ($("#snakeplot").height()>300) {
        $("#snakeplot").height(300);
      }
      // console.log('CHECKHEIGHT',$("#snakeplot").height());
    }
    function color_residue(pos, type) {

     if (type == 'deletion') {
        bg = 'red';
        fill = 'white';
        hide_residue(pos);
        // console.log('hiding',pos);
     } else if (type == 'mutation') {
        bg = 'yellow';
        fill = 'red';
        // console.log("mutate to this",track_pos[pos],track_pos[pos]['to'])
        $('#'+pos+'t').addClass('mutated');
        $('#'+pos+'t').attr('original_aa',$('#'+pos+'t').html());
        $('#'+pos+'t').html(track_pos[pos]['to']);
     }

     $('#'+pos+'t').css("fill", fill);
     $('#'+pos+'t').prev().css("fill", bg);

    }

    function hide_residue(pos) {
       $('#'+pos+'t').addClass('svg_construct_hidden');
       $('#'+pos+'t').prev().addClass('svg_construct_hidden');
       $('#path_'+pos).addClass('svg_construct_hidden');
       // console.log($('#'+pos+'t').prev().html());
       $('#'+pos+'t').hide();
       $('#'+pos+'t').prev().hide();
       $('#path_'+pos).hide();
       $('#path_'+(pos+1)).hide();
    }

</script>

<script type="text/javascript" charset="utf-8">

  /// Start up ///


  // Make snake plot big
  $(document).ready(function() {


    $("#edit_mode").hide();
    $("#add_manual").hide();
    $("#manual_mode").hide();


    $('input[type=radio][name=state], input[type=radio][name=fusionpos]').change(function() {
          build_nterm_menu();
          build_cterm_menu();
          {% if class == 'A' or class == 'F' %}
              build_icl3_menu();
          {% elif class == 'B' or class == 'C' %}
              build_icl2_menu();
          {% endif %}
          change_fusionpos();
          build_table_rows();
          if (!edit_mode_on) {modifications_overview();} else {
            build_edit_table();
            overlay_modifications();
          }
    });

    $( "#overview" ).accordion({
      collapsible: true,
      active: false,
    });

    $( "#dialog" ).dialog({
      autoOpen: false,
      show: {
        effect: "blind",
        duration: 200
      },
      hide: {
        effect: "explode",
        duration: 200
      },
      buttons: {
        "Reset": function() {
          $( this ).dialog( "close" );
          resetAll();
        },
        Cancel: function() {
          $( this ).dialog( "close" );
        }
      }
    });

    $( "#dialogauto" ).dialog({
      autoOpen: false,
      show: {
        effect: "blind",
        duration: 200
      },
      hide: {
        effect: "explode",
        duration: 200
      },
      buttons: {
        "Truncation/fusion scan": function() {
          $( this ).dialog( "close" );
          combi_mode();
        },
        Cancel: function() {
          $( this ).dialog( "close" );
          reset_work_mode_checked();
        }
      }
    });

    $( "#dialogauto_mut" ).dialog({
      autoOpen: false,
      show: {
        effect: "blind",
        duration: 200
      },
      hide: {
        effect: "explode",
        duration: 200
      },
      buttons: {
        "Mutation scan": function() {
          $( this ).dialog( "close" );
          combi_mode_mut();
        },
        Cancel: function() {
          $( this ).dialog( "close" );
          reset_work_mode_checked();
        }
      }
    });

        $(".long").show();
        $(".short").hide();
        maxmin();
        fix_snake_plot();
        change_fusionpos();

      // http://localhost:8000/construct/tool/json/nterm/adrb2_human/
      $.getJSON( "/construct/tool/json/nterm/{{target.entry_name}}/", function( data ) {
          n_term_data = data;
          build_nterm_menu();
          load_status += 1;
          updateLoadStatus();
        });

      // http://localhost:8000/construct/tool/json/cterm/adrb2_human/
      $.getJSON( "/construct/tool/json/cterm/{{target.entry_name}}/", function( data ) {
          c_term_data = data;
          build_cterm_menu();
          load_status += 1;
          updateLoadStatus();
        });

      //and residues.ICL3|length > 8
    {% if class == 'A'  or class == 'F' %}
      // http://localhost:8000/construct/tool/json/icl3/adrb2_human/
      $.getJSON( "/construct/tool/json/icl3/{{target.entry_name}}/", function( data ) {
          icl3_data = data;
          build_icl3_menu();
          load_status += 1;
          updateLoadStatus();
        });
    {% elif class == 'B' or class == 'C' %}
      // http://localhost:8000/construct/tool/json/icl3/adrb2_human/
      $.getJSON( "/construct/tool/json/icl2/{{target.entry_name}}/", function( data ) {
          icl2_data = data;
          build_icl2_menu();
          load_status += 1;
          updateLoadStatus();
        });
    {% else %}
      icl3_data = [];
      load_status += 1;
    {% endif %}


      // $.getJSON( "/construct/tool/json/glyco/{{target.entry_name}}/", function( data ) {
      //     var items = [];
      //     $.each( data, function( type, val ) {
      //       temp = "<li id='" + type + "' class=\"dropdown-submenu\"><a>" + type + " ("+Object.keys(val).length+" hits)</a><ul class=\"dropdown-menu\">";
      //       $.each( val, function( key, value ) {
      //           if (type == 'mammalian') {
      //           temp += "<li id='"+key+"'  class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+" ("+value[5]+")</a><ul  class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' to2='"+value[3]+"' wt2='"+value[4][1]+"'> Mutate "+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+"</a></li></ul></li>";
      //           } else {
      //           temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
      //           }
      //       });

      //       temp += "</ul></li>";
      //       items.push( temp );
      //     });
      //     result = items.join( "" );
      //     $("#glyco").html(result);
      //     removals_list["glyco"] = data;
      //     build_site_removals();
      //     load_status += 1;
      //     updateLoadStatus();
      //   });

      // // http://localhost:8000/construct/tool/json/palmi/adrb2_human/
      // $.getJSON( "/construct/tool/json/palmi/{{target.entry_name}}/", function( data ) {
      //     var items = [];
      //     $.each( data, function( type, val ) {
      //       temp = "";
      //       $.each( val, function( key, value ) {
      //           temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='palmi(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
      //       });

      //       temp += "</ul></li>";
      //       items.push( temp );
      //     });
      //     result = items.join( "" );
      //     $("#palmi").html(result);
      //     removals_list["palmi"] = data;
      //     build_site_removals();
      //     load_status += 1;
      //     updateLoadStatus();
      //   });

       $.getJSON( "/construct/tool/json/mutations/{{target.entry_name}}/", function( data ) {
          mutations_mode_suggestions = data;
          load_status += 1;
          updateLoadStatus();
      });

      $.getJSON( "/construct/tool/json/struc_rules/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( level, gns ) {
            mutations_browser['struc_rules_'+level] = gns;
          });
          build_mutations();
          load_status += 1;
          updateLoadStatus();
      });

    });


</script>

{% endblock %}
